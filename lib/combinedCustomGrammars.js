'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var parsers = require('occam-parsers'),
    necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities');

var ruleUtilities = require('./utilities/rule');

var arrayUtilities = necessary.arrayUtilities,
    unshift = arrayUtilities.unshift,
    findRuleByName = ruleUtilities.findRuleByName,
    eliminateCycles = grammarUtilities.eliminateCycles,
    eliminateLeftRecursion = grammarUtilities.eliminateLeftRecursion,
    BasicParser = parsers.BasicParser,
    termDefaultCustomGrammarBNF = parsers.termDefaultCustomGrammarBNF,
    statementDefaultCustomGrammarBNF = parsers.statementDefaultCustomGrammarBNF,
    expressionDefaultCustomGrammarBNF = parsers.expressionDefaultCustomGrammarBNF,
    metastatementDefaultCustomGrammarBNF = parsers.metastatementDefaultCustomGrammarBNF;

var CombinedCustomGrammars = function () {
  function CombinedCustomGrammars(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammars);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammars, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var combinedLexicalPattern = combinedLexicalPatternFromCustomGrammars(customGrammars),
          combinedRules = combinedRulesFromCustomGrammars(customGrammars),
          lexicalPattern = combinedLexicalPattern,
          ///
      rules = combinedRules,
          ///
      combinedCustomGrammars = new CombinedCustomGrammars(lexicalPattern, rules);

      return combinedCustomGrammars;
    }
  }]);

  return CombinedCustomGrammars;
}();

module.exports = CombinedCustomGrammars;

function combinedLexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars),
      combinedLexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return combinedLexicalPattern;
}

function combinedRulesFromCustomGrammars(customGrammars) {
  var termDefaultBNF = termDefaultCustomGrammarBNF,
      ///
  statementDefaultBNF = statementDefaultCustomGrammarBNF,
      ///
  expressionDefaultBNF = expressionDefaultCustomGrammarBNF,
      ///
  metastatementDefaultBNF = metastatementDefaultCustomGrammarBNF,
      ///
  termBNFs = bnfsFromCustomGrammars('term', customGrammars),
      statementBNFs = bnfsFromCustomGrammars('statement', customGrammars),
      expressionBNFs = bnfsFromCustomGrammars('expression', customGrammars),
      metastatementBNFs = bnfsFromCustomGrammars('metastatement', customGrammars),
      termRules = rulesFromBNFs('term', termDefaultBNF, termBNFs),
      statementRules = rulesFromBNFs('statement', statementDefaultBNF, statementBNFs),
      expressionRules = rulesFromBNFs('expression', expressionDefaultBNF, expressionBNFs),
      metastatementRules = rulesFromBNFs('metastatement', metastatementDefaultBNF, metastatementBNFs),
      combinedRules = [].concat(termRules).concat(expressionRules).concat(statementRules).concat(metastatementRules); ///

  return combinedRules;
}

function lexicalPatternsFromCustomGrammars(customGrammars) {
  var lexicalPatterns = customGrammars.reduce(function (lexicalPatterns, customGrammar) {
    var lexicalPattern = customGrammar.getLexicalPattern();

    if (lexicalPattern !== null) {
      lexicalPatterns.push(lexicalPattern);
    }

    return lexicalPatterns;
  }, []);

  return lexicalPatterns;
}

function bnfsFromCustomGrammars(ruleName, customGrammars) {
  var bnfs = customGrammars.reduce(function (bnfs, customGrammar) {
    var bnf = customGrammar.getBNF(ruleName);

    if (bnf !== null) {
      bnfs.push(bnf);
    }

    return bnfs;
  }, []);

  return bnfs;
}

function rulesFromBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = mainRuleFromRulesAndRuleName(defaultRules, ruleName),
      defaultOtherRules = otherRulesFromRulesAndMainRule(defaultRules, defaultMainRule),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = mainRuleFromRulesAndRuleName(rules, ruleName),
        otherRules = otherRulesFromRulesAndMainRule(rules, mainRule),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultOtherRules, otherRules);

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule,
      ///
  otherRules = defaultOtherRules; ///

  var rules = [].concat(otherRules).concat(mainRule);

  rules = eliminateCycles(rules); ///

  rules = eliminateLeftRecursion(rules); ///

  return rules;
}

function rulesFromBNF(bnf) {
  var basicParser = BasicParser.fromBNF(bnf),
      rules = basicParser.getRules();

  return rules;
}

function mainRuleFromRulesAndRuleName(rules, ruleName) {
  var name = ruleName,
      ///
  mainRule = findRuleByName(name, rules);

  return mainRule;
}

function otherRulesFromRulesAndMainRule(rules, mainRule) {
  var otherRules = rules.filter(function (rule) {
    var ruleNotMainRule = rule !== mainRule;

    return ruleNotMainRule;
  });

  return otherRules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIl0sIm5hbWVzIjpbInBhcnNlcnMiLCJyZXF1aXJlIiwibmVjZXNzYXJ5IiwiZ3JhbW1hclV0aWxpdGllcyIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInVuc2hpZnQiLCJmaW5kUnVsZUJ5TmFtZSIsImVsaW1pbmF0ZUN5Y2xlcyIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJCYXNpY1BhcnNlciIsInRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiIsInN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwibWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiQ29tYmluZWRDdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImNvbWJpbmVkTGV4aWNhbFBhdHRlcm4iLCJjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwiY29tYmluZWRSdWxlcyIsImNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXJzIiwibW9kdWxlIiwiZXhwb3J0cyIsImxleGljYWxQYXR0ZXJucyIsImxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyIsInJldmVyc2UiLCJqb2luIiwidGVybURlZmF1bHRCTkYiLCJzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsInRlcm1CTkZzIiwiYm5mc0Zyb21DdXN0b21HcmFtbWFycyIsInN0YXRlbWVudEJORnMiLCJleHByZXNzaW9uQk5GcyIsIm1ldGFzdGF0ZW1lbnRCTkZzIiwidGVybVJ1bGVzIiwicnVsZXNGcm9tQk5GcyIsInN0YXRlbWVudFJ1bGVzIiwiZXhwcmVzc2lvblJ1bGVzIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwiY29uY2F0IiwicmVkdWNlIiwiY3VzdG9tR3JhbW1hciIsImdldExleGljYWxQYXR0ZXJuIiwicHVzaCIsInJ1bGVOYW1lIiwiYm5mcyIsImJuZiIsImdldEJORiIsImRlZmF1bHRCTkYiLCJkZWZhdWx0UnVsZXMiLCJydWxlc0Zyb21CTkYiLCJkZWZhdWx0TWFpblJ1bGUiLCJtYWluUnVsZUZyb21SdWxlc0FuZFJ1bGVOYW1lIiwiZGVmYXVsdE90aGVyUnVsZXMiLCJvdGhlclJ1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsIm1haW5SdWxlIiwib3RoZXJSdWxlcyIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJiYXNpY1BhcnNlciIsImZyb21CTkYiLCJnZXRSdWxlcyIsIm5hbWUiLCJmaWx0ZXIiLCJydWxlIiwicnVsZU5vdE1haW5SdWxlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxlQUFSLENBQWhCO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCO0FBQUEsSUFFTUUsbUJBQW1CRixRQUFRLHlCQUFSLENBRnpCOztBQUlBLElBQU1HLGdCQUFnQkgsUUFBUSxrQkFBUixDQUF0Qjs7QUFFTSxJQUFFSSxjQUFGLEdBQXFCSCxTQUFyQixDQUFFRyxjQUFGO0FBQUEsSUFDRUMsT0FERixHQUNjRCxjQURkLENBQ0VDLE9BREY7QUFBQSxJQUVFQyxjQUZGLEdBRXFCSCxhQUZyQixDQUVFRyxjQUZGO0FBQUEsSUFHRUMsZUFIRixHQUc4Q0wsZ0JBSDlDLENBR0VLLGVBSEY7QUFBQSxJQUdtQkMsc0JBSG5CLEdBRzhDTixnQkFIOUMsQ0FHbUJNLHNCQUhuQjtBQUFBLElBSUVDLFdBSkYsR0FJMEpWLE9BSjFKLENBSUVVLFdBSkY7QUFBQSxJQUllQywyQkFKZixHQUkwSlgsT0FKMUosQ0FJZVcs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Q0ssbUJBQXBDO0FBQ0QsR0FYRDs7QUFhQSxNQUFNRixXQUFXUCxlQUFqQjtBQUFBLE1BQWtDO0FBQzVCUSxlQUFhTixpQkFEbkIsQ0FuQmlELENBb0JYOztBQUV0QyxNQUFJekMsUUFBUSxHQUFHMkIsTUFBSCxDQUFVb0IsVUFBVixFQUFzQnBCLE1BQXRCLENBQTZCbUIsUUFBN0IsQ0FBWjs7QUFFQTlDLFVBQVFULGdCQUFnQlMsS0FBaEIsQ0FBUixDQXhCaUQsQ0F3QmpCOztBQUVoQ0EsVUFBUVIsdUJBQXVCUSxLQUF2QixDQUFSLENBMUJpRCxDQTBCVDs7QUFFeEMsU0FBT0EsS0FBUDtBQUNEOztBQUVELFNBQVNzQyxZQUFULENBQXNCSixHQUF0QixFQUEyQjtBQUN6QixNQUFNZSxjQUFjeEQsWUFBWXlELE9BQVosQ0FBb0JoQixHQUFwQixDQUFwQjtBQUFBLE1BQ01sQyxRQUFRaUQsWUFBWUUsUUFBWixFQURkOztBQUdBLFNBQU9uRCxLQUFQO0FBQ0Q7O0FBRUQsU0FBU3dDLDRCQUFULENBQXNDeEMsS0FBdEMsRUFBNkNnQyxRQUE3QyxFQUF1RDtBQUNyRCxNQUFNb0IsT0FBT3BCLFFBQWI7QUFBQSxNQUF3QjtBQUNsQmMsYUFBV3hELGVBQWU4RCxJQUFmLEVBQXFCcEQsS0FBckIsQ0FEakI7O0FBR0EsU0FBTzhDLFFBQVA7QUFDRDs7QUFFRCxTQUFTSiw4QkFBVCxDQUF3QzFDLEtBQXhDLEVBQStDOEMsUUFBL0MsRUFBeUQ7QUFDdkQsTUFBTUMsYUFBYS9DLE1BQU1xRCxNQUFOLENBQWEsVUFBU0MsSUFBVCxFQUFlO0FBQzdDLFFBQU1DLGtCQUFtQkQsU0FBU1IsUUFBbEM7O0FBRUEsV0FBT1MsZUFBUDtBQUNELEdBSmtCLENBQW5COztBQU1BLFNBQU9SLFVBQVA7QUFDRCIsImZpbGUiOiJjb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5JyksXG4gICAgICBncmFtbWFyVXRpbGl0aWVzID0gcmVxdWlyZSgnb2NjYW0tZ3JhbW1hci11dGlsaXRpZXMnKTtcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGVsaW1pbmF0ZUN5Y2xlcywgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9ID0gZ3JhbW1hclV0aWxpdGllcyxcbiAgICAgIHsgQmFzaWNQYXJzZXIsIHRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIGV4cHJlc3Npb25EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgbWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIH0gPSBwYXJzZXJzO1xuXG5jbGFzcyBDb21iaW5lZEN1c3RvbUdyYW1tYXJzIHtcbiAgY29uc3RydWN0b3IobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKSB7XG4gICAgdGhpcy5sZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuO1xuICAgIHRoaXMucnVsZXMgPSBydWxlcztcbiAgfVxuICBcbiAgZ2V0TGV4aWNhbFBhdHRlcm4oKSB7XG4gICAgcmV0dXJuIHRoaXMubGV4aWNhbFBhdHRlcm47XG4gIH1cblxuICBnZXRSdWxlcygpIHtcbiAgICByZXR1cm4gdGhpcy5ydWxlcztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgICBjb25zdCBjb21iaW5lZExleGljYWxQYXR0ZXJuID0gY29tYmluZWRMZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgY29tYmluZWRSdWxlcyA9IGNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIGxleGljYWxQYXR0ZXJuID0gY29tYmluZWRMZXhpY2FsUGF0dGVybiwgIC8vL1xuICAgICAgICAgIHJ1bGVzID0gY29tYmluZWRSdWxlcywgIC8vL1xuICAgICAgICAgIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcnMgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFycyhsZXhpY2FsUGF0dGVybiwgcnVsZXMpO1xuICAgIFxuICAgIHJldHVybiBjb21iaW5lZEN1c3RvbUdyYW1tYXJzO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29tYmluZWRDdXN0b21HcmFtbWFycztcblxuZnVuY3Rpb24gY29tYmluZWRMZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBjb21iaW5lZExleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5zLnJldmVyc2UoKS5qb2luKCd8Jyk7IC8vL1xuXG4gIHJldHVybiBjb21iaW5lZExleGljYWxQYXR0ZXJuO1xufVxuXG5mdW5jdGlvbiBjb21iaW5lZFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IHRlcm1EZWZhdWx0Qk5GID0gdGVybURlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgc3RhdGVtZW50RGVmYXVsdEJORiA9IHN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgZXhwcmVzc2lvbkRlZmF1bHRCTkYgPSBleHByZXNzaW9uRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiA9IG1ldGFzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgLy8vXG4gICAgICAgIHRlcm1CTkZzID0gYm5mc0Zyb21DdXN0b21HcmFtbWFycygndGVybScsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgc3RhdGVtZW50Qk5GcyA9IGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMoJ3N0YXRlbWVudCcsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgZXhwcmVzc2lvbkJORnMgPSBibmZzRnJvbUN1c3RvbUdyYW1tYXJzKCdleHByZXNzaW9uJywgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBtZXRhc3RhdGVtZW50Qk5GcyA9IGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMoJ21ldGFzdGF0ZW1lbnQnLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIHRlcm1SdWxlcyA9IHJ1bGVzRnJvbUJORnMoJ3Rlcm0nLCB0ZXJtRGVmYXVsdEJORiwgdGVybUJORnMpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbUJORnMoJ3N0YXRlbWVudCcsIHN0YXRlbWVudERlZmF1bHRCTkYsIHN0YXRlbWVudEJORnMpLFxuICAgICAgICBleHByZXNzaW9uUnVsZXMgPSBydWxlc0Zyb21CTkZzKCdleHByZXNzaW9uJywgZXhwcmVzc2lvbkRlZmF1bHRCTkYsIGV4cHJlc3Npb25CTkZzKSxcbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tQk5GcygnbWV0YXN0YXRlbWVudCcsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GLCBtZXRhc3RhdGVtZW50Qk5GcyksXG4gICAgICAgIGNvbWJpbmVkUnVsZXMgPSBbXS5jb25jYXQodGVybVJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQoc3RhdGVtZW50UnVsZXMpLmNvbmNhdChtZXRhc3RhdGVtZW50UnVsZXMpOyAvLy9cblxuICByZXR1cm4gY29tYmluZWRSdWxlcztcbn1cblxuZnVuY3Rpb24gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGxleGljYWxQYXR0ZXJucyA9IGN1c3RvbUdyYW1tYXJzLnJlZHVjZShmdW5jdGlvbihsZXhpY2FsUGF0dGVybnMsIGN1c3RvbUdyYW1tYXIpIHtcbiAgICBjb25zdCBsZXhpY2FsUGF0dGVybiA9IGN1c3RvbUdyYW1tYXIuZ2V0TGV4aWNhbFBhdHRlcm4oKTtcblxuICAgIGlmIChsZXhpY2FsUGF0dGVybiAhPT0gbnVsbCkge1xuICAgICAgbGV4aWNhbFBhdHRlcm5zLnB1c2gobGV4aWNhbFBhdHRlcm4pO1xuICAgIH1cblxuICAgIHJldHVybiBsZXhpY2FsUGF0dGVybnM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gbGV4aWNhbFBhdHRlcm5zO1xufVxuXG5mdW5jdGlvbiBibmZzRnJvbUN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBibmZzID0gY3VzdG9tR3JhbW1hcnMucmVkdWNlKGZ1bmN0aW9uKGJuZnMsIGN1c3RvbUdyYW1tYXIpIHtcbiAgICBjb25zdCBibmYgPSBjdXN0b21HcmFtbWFyLmdldEJORihydWxlTmFtZSk7XG5cbiAgICBpZiAoYm5mICE9PSBudWxsKSB7XG4gICAgICBibmZzLnB1c2goYm5mKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYm5mcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBibmZzO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21CTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZXNBbmRSdWxlTmFtZShkZWZhdWx0UnVsZXMsIHJ1bGVOYW1lKSxcbiAgICAgICAgZGVmYXVsdE90aGVyUnVsZXMgPSBvdGhlclJ1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyA9IGRlZmF1bHRNYWluUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZXNBbmRSdWxlTmFtZShydWxlcywgcnVsZU5hbWUpLFxuICAgICAgICAgIG90aGVyUnVsZXMgPSBvdGhlclJ1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSxcbiAgICAgICAgICBtYWluUnVsZURlZmluaXRpb25zID0gKG1haW5SdWxlICE9PSBudWxsKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdE90aGVyUnVsZXMsIG90aGVyUnVsZXMpO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucywgbWFpblJ1bGVEZWZpbml0aW9ucyk7XG4gIH0pO1xuXG4gIGNvbnN0IG1haW5SdWxlID0gZGVmYXVsdE1haW5SdWxlLCAvLy9cbiAgICAgICAgb3RoZXJSdWxlcyA9IGRlZmF1bHRPdGhlclJ1bGVzOyAvLy9cblxuICBsZXQgcnVsZXMgPSBbXS5jb25jYXQob3RoZXJSdWxlcykuY29uY2F0KG1haW5SdWxlKTtcblxuICBydWxlcyA9IGVsaW1pbmF0ZUN5Y2xlcyhydWxlcyk7IC8vL1xuXG4gIHJ1bGVzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcyk7ICAvLy9cblxuICByZXR1cm4gcnVsZXM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbUJORihibmYpIHtcbiAgY29uc3QgYmFzaWNQYXJzZXIgPSBCYXNpY1BhcnNlci5mcm9tQk5GKGJuZiksXG4gICAgICAgIHJ1bGVzID0gYmFzaWNQYXJzZXIuZ2V0UnVsZXMoKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG5cbmZ1bmN0aW9uIG1haW5SdWxlRnJvbVJ1bGVzQW5kUnVsZU5hbWUocnVsZXMsIHJ1bGVOYW1lKSB7XG4gIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICByZXR1cm4gbWFpblJ1bGU7XG59XG5cbmZ1bmN0aW9uIG90aGVyUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpIHtcbiAgY29uc3Qgb3RoZXJSdWxlcyA9IHJ1bGVzLmZpbHRlcihmdW5jdGlvbihydWxlKSB7XG4gICAgY29uc3QgcnVsZU5vdE1haW5SdWxlID0gKHJ1bGUgIT09IG1haW5SdWxlKTtcblxuICAgIHJldHVybiBydWxlTm90TWFpblJ1bGU7XG4gIH0pO1xuXG4gIHJldHVybiBvdGhlclJ1bGVzO1xufVxuIl19