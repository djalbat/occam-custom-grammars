'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var parsers = require('occam-parsers'),
    necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities');

var ruleUtilities = require('./utilities/rule');

var arrayUtilities = necessary.arrayUtilities,
    unshift = arrayUtilities.unshift,
    findRuleByName = ruleUtilities.findRuleByName,
    eliminateLeftRecursion = grammarUtilities.eliminateLeftRecursion,
    BasicParser = parsers.BasicParser,
    termDefaultCustomGrammarBNF = parsers.termDefaultCustomGrammarBNF,
    statementDefaultCustomGrammarBNF = parsers.statementDefaultCustomGrammarBNF,
    expressionDefaultCustomGrammarBNF = parsers.expressionDefaultCustomGrammarBNF,
    metastatementDefaultCustomGrammarBNF = parsers.metastatementDefaultCustomGrammarBNF;

var CombinedCustomGrammars = function () {
  function CombinedCustomGrammars(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammars);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammars, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var combinedLexicalPattern = combinedLexicalPatternFromCustomGrammars(customGrammars),
          combinedRules = combinedRulesFromCustomGrammars(customGrammars),
          lexicalPattern = combinedLexicalPattern,
          ///
      rules = eliminateLeftRecursion(combinedRules),
          ///
      combinedCustomGrammars = new CombinedCustomGrammars(lexicalPattern, rules);

      return combinedCustomGrammars;
    }
  }]);

  return CombinedCustomGrammars;
}();

module.exports = CombinedCustomGrammars;

function combinedLexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars),
      combinedLexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return combinedLexicalPattern;
}

function combinedRulesFromCustomGrammars(customGrammars) {
  var termDefaultBNF = termDefaultCustomGrammarBNF,
      ///
  statementDefaultBNF = statementDefaultCustomGrammarBNF,
      ///
  expressionDefaultBNF = expressionDefaultCustomGrammarBNF,
      ///
  metastatementDefaultBNF = metastatementDefaultCustomGrammarBNF,
      ///
  termBNFs = bnfsFromCustomGrammars('term', customGrammars),
      statementBNFs = bnfsFromCustomGrammars('statement', customGrammars),
      expressionBNFs = bnfsFromCustomGrammars('expression', customGrammars),
      metastatementBNFs = bnfsFromCustomGrammars('metastatement', customGrammars),
      termRules = rulesFromBNFs('term', termDefaultBNF, termBNFs),
      statementRules = rulesFromBNFs('statement', statementDefaultBNF, statementBNFs),
      expressionRules = rulesFromBNFs('expression', expressionDefaultBNF, expressionBNFs),
      metastatementRules = rulesFromBNFs('metastatement', metastatementDefaultBNF, metastatementBNFs),
      combinedRules = [].concat(termRules).concat(expressionRules).concat(statementRules).concat(metastatementRules); ///

  return combinedRules;
}

function lexicalPatternsFromCustomGrammars(customGrammars) {
  var lexicalPatterns = [];

  customGrammars.forEach(function (customGrammar) {
    var lexicalPattern = customGrammar.getLexicalPattern();

    if (lexicalPattern !== null) {
      lexicalPatterns.push(lexicalPattern);
    }
  });

  return lexicalPatterns;
}

function bnfsFromCustomGrammars(ruleName, customGrammars) {
  var bnfs = [];

  customGrammars.forEach(function (customGrammar) {
    var bnf = customGrammar.getBNF(ruleName);

    if (bnf !== null) {
      bnfs.push(bnf);
    }
  });

  return bnfs;
}

function rulesFromBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = mainRuleFromRulesAndRuleName(defaultRules, ruleName),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = mainRuleFromRulesAndRuleName(rules, ruleName),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultRemainingRules, remainingRules);

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule,
      ///
  remainingRules = defaultRemainingRules; ///

  var rules = [].concat(mainRule).concat(remainingRules);

  return rules;
}

function rulesFromBNF(bnf) {
  var basicParser = BasicParser.fromBNF(bnf),
      rules = basicParser.getRules();

  return rules;
}

function mainRuleFromRulesAndRuleName(rules, ruleName) {
  var name = ruleName,
      ///
  mainRule = findRuleByName(name, rules);

  return mainRule;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });

  return remainingRules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIl0sIm5hbWVzIjpbInBhcnNlcnMiLCJyZXF1aXJlIiwibmVjZXNzYXJ5IiwiZ3JhbW1hclV0aWxpdGllcyIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInVuc2hpZnQiLCJmaW5kUnVsZUJ5TmFtZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJCYXNpY1BhcnNlciIsInRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiIsInN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwibWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiQ29tYmluZWRDdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImNvbWJpbmVkTGV4aWNhbFBhdHRlcm4iLCJjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwiY29tYmluZWRSdWxlcyIsImNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXJzIiwibW9kdWxlIiwiZXhwb3J0cyIsImxleGljYWxQYXR0ZXJucyIsImxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyIsInJldmVyc2UiLCJqb2luIiwidGVybURlZmF1bHRCTkYiLCJzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsInRlcm1CTkZzIiwiYm5mc0Zyb21DdXN0b21HcmFtbWFycyIsInN0YXRlbWVudEJORnMiLCJleHByZXNzaW9uQk5GcyIsIm1ldGFzdGF0ZW1lbnRCTkZzIiwidGVybVJ1bGVzIiwicnVsZXNGcm9tQk5GcyIsInN0YXRlbWVudFJ1bGVzIiwiZXhwcmVzc2lvblJ1bGVzIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwiY29uY2F0IiwiZm9yRWFjaCIsImN1c3RvbUdyYW1tYXIiLCJnZXRMZXhpY2FsUGF0dGVybiIsInB1c2giLCJydWxlTmFtZSIsImJuZnMiLCJibmYiLCJnZXRCTkYiLCJkZWZhdWx0Qk5GIiwiZGVmYXVsdFJ1bGVzIiwicnVsZXNGcm9tQk5GIiwiZGVmYXVsdE1haW5SdWxlIiwibWFpblJ1bGVGcm9tUnVsZXNBbmRSdWxlTmFtZSIsImRlZmF1bHRSZW1haW5pbmdSdWxlcyIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwibWFpblJ1bGUiLCJyZW1haW5pbmdSdWxlcyIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJiYXNpY1BhcnNlciIsImZyb21CTkYiLCJnZXRSdWxlcyIsIm5hbWUiLCJmaWx0ZXIiLCJydWxlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxlQUFSLENBQWhCO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCO0FBQUEsSUFFTUUsbUJBQW1CRixRQUFRLHlCQUFSLENBRnpCOztBQUlBLElBQU1HLGdCQUFnQkgsUUFBUSxrQkFBUixDQUF0Qjs7QUFFTSxJQUFFSSxjQUFGLEdBQXFCSCxTQUFyQixDQUFFRyxjQUFGO0FBQUEsSUFDRUMsT0FERixHQUNjRCxjQURkLENBQ0VDLE9BREY7QUFBQSxJQUVFQyxjQUZGLEdBRXFCSCxhQUZyQixDQUVFRyxjQUZGO0FBQUEsSUFHRUMsc0JBSEYsR0FHNkJMLGdCQUg3QixDQUdFSyxzQkFIRjtBQUFBLElBSUVDLFdBSkYsR0FJMEpULE9BSjFKLENBSUVTLFdBSkY7QUFBQSxJQUllQywyQkFKZixHQUkwSlYsT0FKMUosQ0FJZVUsMkJBSmY7QUFBQSxJQUk0Q0MsZ0NBSjVDLEdBSTBKWCxPQUoxSixDQUk0Q1csZ0NBSjVDO0FBQUEsSUFJOEVDLGlDQUo5RSxHQUkwSlos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VixFQUFvQmxCLE1BQXBCLENBQTJCbUIsY0FBM0IsQ0FBZDs7QUFFQSxTQUFPOUMsS0FBUDtBQUNEOztBQUVELFNBQVNzQyxZQUFULENBQXNCSixHQUF0QixFQUEyQjtBQUN6QixNQUFNYyxjQUFjdkQsWUFBWXdELE9BQVosQ0FBb0JmLEdBQXBCLENBQXBCO0FBQUEsTUFDTWxDLFFBQVFnRCxZQUFZRSxRQUFaLEVBRGQ7O0FBR0EsU0FBT2xELEtBQVA7QUFDRDs7QUFFRCxTQUFTd0MsNEJBQVQsQ0FBc0N4QyxLQUF0QyxFQUE2Q2dDLFFBQTdDLEVBQXVEO0FBQ3JELE1BQU1tQixPQUFPbkIsUUFBYjtBQUFBLE1BQXdCO0FBQ2xCYSxhQUFXdEQsZUFBZTRELElBQWYsRUFBcUJuRCxLQUFyQixDQURqQjs7QUFHQSxTQUFPNkMsUUFBUDtBQUNEOztBQUVELFNBQVNILGtDQUFULENBQTRDMUMsS0FBNUMsRUFBbUQ2QyxRQUFuRCxFQUE2RDtBQUMzRCxNQUFNQyxpQkFBaUI5QyxNQUFNb0QsTUFBTixDQUFhLFVBQVNDLElBQVQsRUFBZTtBQUNqRCxRQUFJQSxTQUFTUixRQUFiLEVBQXVCO0FBQ3JCLGFBQU8sSUFBUDtBQUNEO0FBQ0YsR0FKc0IsQ0FBdkI7O0FBTUEsU0FBT0MsY0FBUDtBQUNEIiwiZmlsZSI6ImNvbWJpbmVkQ3VzdG9tR3JhbW1hcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHBhcnNlcnMgPSByZXF1aXJlKCdvY2NhbS1wYXJzZXJzJyksXG4gICAgICBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKSxcbiAgICAgIGdyYW1tYXJVdGlsaXRpZXMgPSByZXF1aXJlKCdvY2NhbS1ncmFtbWFyLXV0aWxpdGllcycpO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpO1xuXG5jb25zdCB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHVuc2hpZnQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9ID0gZ3JhbW1hclV0aWxpdGllcyxcbiAgICAgIHsgQmFzaWNQYXJzZXIsIHRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIGV4cHJlc3Npb25EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgbWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIH0gPSBwYXJzZXJzO1xuXG5jbGFzcyBDb21iaW5lZEN1c3RvbUdyYW1tYXJzIHtcbiAgY29uc3RydWN0b3IobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKSB7XG4gICAgdGhpcy5sZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuO1xuICAgIHRoaXMucnVsZXMgPSBydWxlcztcbiAgfVxuICBcbiAgZ2V0TGV4aWNhbFBhdHRlcm4oKSB7XG4gICAgcmV0dXJuIHRoaXMubGV4aWNhbFBhdHRlcm47XG4gIH1cblxuICBnZXRSdWxlcygpIHtcbiAgICByZXR1cm4gdGhpcy5ydWxlcztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgICBjb25zdCBjb21iaW5lZExleGljYWxQYXR0ZXJuID0gY29tYmluZWRMZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgY29tYmluZWRSdWxlcyA9IGNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIGxleGljYWxQYXR0ZXJuID0gY29tYmluZWRMZXhpY2FsUGF0dGVybiwgIC8vL1xuICAgICAgICAgIHJ1bGVzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihjb21iaW5lZFJ1bGVzKSwgIC8vL1xuICAgICAgICAgIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcnMgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFycyhsZXhpY2FsUGF0dGVybiwgcnVsZXMpO1xuICAgIFxuICAgIHJldHVybiBjb21iaW5lZEN1c3RvbUdyYW1tYXJzO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29tYmluZWRDdXN0b21HcmFtbWFycztcblxuZnVuY3Rpb24gY29tYmluZWRMZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBjb21iaW5lZExleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5zLnJldmVyc2UoKS5qb2luKCd8Jyk7IC8vL1xuXG4gIHJldHVybiBjb21iaW5lZExleGljYWxQYXR0ZXJuO1xufVxuXG5mdW5jdGlvbiBjb21iaW5lZFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IHRlcm1EZWZhdWx0Qk5GID0gdGVybURlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgc3RhdGVtZW50RGVmYXVsdEJORiA9IHN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgZXhwcmVzc2lvbkRlZmF1bHRCTkYgPSBleHByZXNzaW9uRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiA9IG1ldGFzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgLy8vXG4gICAgICAgIHRlcm1CTkZzID0gYm5mc0Zyb21DdXN0b21HcmFtbWFycygndGVybScsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgc3RhdGVtZW50Qk5GcyA9IGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMoJ3N0YXRlbWVudCcsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgZXhwcmVzc2lvbkJORnMgPSBibmZzRnJvbUN1c3RvbUdyYW1tYXJzKCdleHByZXNzaW9uJywgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBtZXRhc3RhdGVtZW50Qk5GcyA9IGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMoJ21ldGFzdGF0ZW1lbnQnLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIHRlcm1SdWxlcyA9IHJ1bGVzRnJvbUJORnMoJ3Rlcm0nLCB0ZXJtRGVmYXVsdEJORiwgdGVybUJORnMpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbUJORnMoJ3N0YXRlbWVudCcsIHN0YXRlbWVudERlZmF1bHRCTkYsIHN0YXRlbWVudEJORnMpLFxuICAgICAgICBleHByZXNzaW9uUnVsZXMgPSBydWxlc0Zyb21CTkZzKCdleHByZXNzaW9uJywgZXhwcmVzc2lvbkRlZmF1bHRCTkYsIGV4cHJlc3Npb25CTkZzKSxcbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tQk5GcygnbWV0YXN0YXRlbWVudCcsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GLCBtZXRhc3RhdGVtZW50Qk5GcyksXG4gICAgICAgIGNvbWJpbmVkUnVsZXMgPSBbXS5jb25jYXQodGVybVJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQoc3RhdGVtZW50UnVsZXMpLmNvbmNhdChtZXRhc3RhdGVtZW50UnVsZXMpOyAvLy9cblxuICByZXR1cm4gY29tYmluZWRSdWxlcztcbn1cblxuZnVuY3Rpb24gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGxleGljYWxQYXR0ZXJucyA9IFtdO1xuXG4gIGN1c3RvbUdyYW1tYXJzLmZvckVhY2goZnVuY3Rpb24oY3VzdG9tR3JhbW1hcikge1xuICAgIGNvbnN0IGxleGljYWxQYXR0ZXJuID0gY3VzdG9tR3JhbW1hci5nZXRMZXhpY2FsUGF0dGVybigpO1xuXG4gICAgaWYgKGxleGljYWxQYXR0ZXJuICE9PSBudWxsKSB7XG4gICAgICBsZXhpY2FsUGF0dGVybnMucHVzaChsZXhpY2FsUGF0dGVybik7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gbGV4aWNhbFBhdHRlcm5zO1xufVxuXG5mdW5jdGlvbiBibmZzRnJvbUN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBibmZzID0gW107XG5cbiAgY3VzdG9tR3JhbW1hcnMuZm9yRWFjaChmdW5jdGlvbihjdXN0b21HcmFtbWFyKSB7XG4gICAgY29uc3QgYm5mID0gY3VzdG9tR3JhbW1hci5nZXRCTkYocnVsZU5hbWUpO1xuXG4gICAgaWYgKGJuZiAhPT0gbnVsbCkge1xuICAgICAgYm5mcy5wdXNoKGJuZik7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gYm5mcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IG1haW5SdWxlRnJvbVJ1bGVzQW5kUnVsZU5hbWUoZGVmYXVsdFJ1bGVzLCBydWxlTmFtZSksXG4gICAgICAgIGRlZmF1bHRSZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyA9IGRlZmF1bHRNYWluUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZXNBbmRSdWxlTmFtZShydWxlcywgcnVsZU5hbWUpLFxuICAgICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpLFxuICAgICAgICAgIG1haW5SdWxlRGVmaW5pdGlvbnMgPSAobWFpblJ1bGUgIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUnVsZS5nZXREZWZpbml0aW9ucygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0UmVtYWluaW5nUnVsZXMsIHJlbWFpbmluZ1J1bGVzKTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMsIG1haW5SdWxlRGVmaW5pdGlvbnMpO1xuICB9KTtcblxuICBjb25zdCBtYWluUnVsZSA9IGRlZmF1bHRNYWluUnVsZSwgLy8vXG4gICAgICAgIHJlbWFpbmluZ1J1bGVzID0gZGVmYXVsdFJlbWFpbmluZ1J1bGVzOyAvLy9cblxuICBjb25zdCBydWxlcyA9IFtdLmNvbmNhdChtYWluUnVsZSkuY29uY2F0KHJlbWFpbmluZ1J1bGVzKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbUJORihibmYpIHtcbiAgY29uc3QgYmFzaWNQYXJzZXIgPSBCYXNpY1BhcnNlci5mcm9tQk5GKGJuZiksXG4gICAgICAgIHJ1bGVzID0gYmFzaWNQYXJzZXIuZ2V0UnVsZXMoKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG5cbmZ1bmN0aW9uIG1haW5SdWxlRnJvbVJ1bGVzQW5kUnVsZU5hbWUocnVsZXMsIHJ1bGVOYW1lKSB7XG4gIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICByZXR1cm4gbWFpblJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSB7XG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gcnVsZXMuZmlsdGVyKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBpZiAocnVsZSAhPT0gbWFpblJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuIl19