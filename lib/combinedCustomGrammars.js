'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var parsers = require('occam-parsers'),
    ///
necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities'); ///

var rulesUtilities = require('./utilities/rules'),
    ruleNameUtilities = require('./utilities/ruleName'),
    customGrammarsUtilities = require('./utilities/customGrammars');

var rulesFromBNF = rulesUtilities.rulesFromBNF,
    arrayUtilities = necessary.arrayUtilities,
    unshift = arrayUtilities.unshift,
    findRuleByRuleName = ruleNameUtilities.findRuleByRuleName,
    eliminateImplicitLeftRecursion = grammarUtilities.eliminateImplicitLeftRecursion,
    lexicalPatternsFromCustomGrammars = customGrammarsUtilities.lexicalPatternsFromCustomGrammars,
    bnfsFromRuleNameAndCustomGrammars = customGrammarsUtilities.bnfsFromRuleNameAndCustomGrammars,
    termDefaultCustomGrammarBNF = parsers.termDefaultCustomGrammarBNF,
    statementDefaultCustomGrammarBNF = parsers.statementDefaultCustomGrammarBNF,
    expressionDefaultCustomGrammarBNF = parsers.expressionDefaultCustomGrammarBNF,
    metastatementDefaultCustomGrammarBNF = parsers.metastatementDefaultCustomGrammarBNF;

var CombinedCustomGrammars = function () {
  function CombinedCustomGrammars(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammars);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammars, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var combinedLexicalPattern = combinedLexicalPatternFromCustomGrammars(customGrammars),
          combinedRules = combinedRulesFromCustomGrammars(customGrammars),
          lexicalPattern = combinedLexicalPattern,
          ///
      rules = combinedRules,
          ///
      combinedCustomGrammars = new CombinedCustomGrammars(lexicalPattern, rules);

      return combinedCustomGrammars;
    }
  }]);

  return CombinedCustomGrammars;
}();

module.exports = CombinedCustomGrammars;

function combinedLexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars),
      combinedLexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return combinedLexicalPattern;
}

function combinedRulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = 'metastatement',
      expressionRuleName = 'expression',
      statementRuleName = 'statement',
      termRuleName = 'term',
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(metastatementRuleName, customGrammars, metastatementDefaultCustomGrammarBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(expressionRuleName, customGrammars, expressionDefaultCustomGrammarBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(statementRuleName, customGrammars, statementDefaultCustomGrammarBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(termRuleName, customGrammars, termDefaultCustomGrammarBNF),
      combinedRules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);

  return combinedRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(ruleName, customGrammars, defaultCustomGrammarBNF) {
  var defaultBNF = defaultCustomGrammarBNF,
      ///
  bnfs = bnfsFromRuleNameAndCustomGrammars(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs);

  var rules = void 0;

  rules = [].concat(remainingRules).concat(mainRule);

  rules = eliminateImplicitLeftRecursion(rules);

  var metastatementRules = rules;

  return metastatementRules;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });

  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);

    unshift(defaultRemainingRules, remainingRules);
  });

  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIl0sIm5hbWVzIjpbInBhcnNlcnMiLCJyZXF1aXJlIiwibmVjZXNzYXJ5IiwiZ3JhbW1hclV0aWxpdGllcyIsInJ1bGVzVXRpbGl0aWVzIiwicnVsZU5hbWVVdGlsaXRpZXMiLCJjdXN0b21HcmFtbWFyc1V0aWxpdGllcyIsInJ1bGVzRnJvbUJORiIsImFycmF5VXRpbGl0aWVzIiwidW5zaGlmdCIsImZpbmRSdWxlQnlSdWxlTmFtZSIsImVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbiIsImxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyIsImJuZnNGcm9tUnVsZU5hbWVBbmRDdXN0b21HcmFtbWFycyIsInRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiIsInN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwibWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiQ29tYmluZWRDdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImNvbWJpbmVkTGV4aWNhbFBhdHRlcm4iLCJjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwiY29tYmluZWRSdWxlcyIsImNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXJzIiwibW9kdWxlIiwiZXhwb3J0cyIsImxleGljYWxQYXR0ZXJucyIsInJldmVyc2UiLCJqb2luIiwibWV0YXN0YXRlbWVudFJ1bGVOYW1lIiwiZXhwcmVzc2lvblJ1bGVOYW1lIiwic3RhdGVtZW50UnVsZU5hbWUiLCJ0ZXJtUnVsZU5hbWUiLCJtZXRhc3RhdGVtZW50UnVsZXMiLCJydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJleHByZXNzaW9uUnVsZXMiLCJzdGF0ZW1lbnRSdWxlcyIsInRlcm1SdWxlcyIsImNvbmNhdCIsInJ1bGVOYW1lIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJkZWZhdWx0Qk5GIiwiYm5mcyIsIm1haW5SdWxlIiwibWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsInJlbWFpbmluZ1J1bGVzIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJmaWx0ZXIiLCJydWxlIiwiZGVmYXVsdFJ1bGVzIiwiZGVmYXVsdE1haW5SdWxlIiwiZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJibmYiLCJtYWluUnVsZURlZmluaXRpb25zIiwiZGVmYXVsdFJlbWFpbmluZ1J1bGVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxlQUFSLENBQWhCO0FBQUEsSUFBMEM7QUFDcENDLFlBQVlELFFBQVEsV0FBUixDQURsQjtBQUFBLElBRU1FLG1CQUFtQkYsUUFBUSx5QkFBUixDQUZ6QixDLENBRThEOztBQUU5RCxJQUFNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FBdkI7QUFBQSxJQUNNSSxvQkFBb0JKLFFBQVEsc0JBQVIsQ0FEMUI7QUFBQSxJQUVNSywwQkFBMEJMLFFBQVEsNEJBQVIsQ0FGaEM7O0FBSU0sSUFBRU0sWUFBRixHQUFtQkgsY0FBbkIsQ0FBRUcsWUFBRjtBQUFBLElBQ0VDLGNBREYsR0FDcUJOLFNBRHJCLENBQ0VNLGNBREY7QUFBQSxJQUVFQyxPQUZGLEdBRWNELGNBRmQsQ0FFRUMsT0FGRjtBQUFBLElBR0VDLGtCQUhGLEdBR3lCTCxpQkFIekIsQ0FHRUssa0JBSEY7QUFBQSxJQUlFQyw4QkFKRixHQUlxQ1IsZ0JBSnJDLENBSUVRLDhCQUpGO0FBQUEsSUFLRUMsaUNBTEYsR0FLMkVOLHVCQUwzRSxDQUtFTSxpQ0FMRjtBQUFBLElBS3FDQyxpQ0FMckMsR0FLMkVQLHVCQUwzRSxDQUtxQ08saUNBTHJDO0FBQUEsSUFNRUMsMkJBTkYsR0FNNklkLE9BTjdJLENBTUVjLDJCQU5GO0FBQUEsSUFNK0JDLGdDQU4vQixHQU02SWYsT0FON0ksQ0FNK0JlLGdDQU4vQjtBQUFBLElBTWlFQyxpQ0FOakUsR0FNNkloQixPQU43SSxDQU1pRWdCLGlDQU5qRTtBQUFBLElBTW9HQyxvQ0FOcEcsR0FNNklqQixPQU43SSxDQU1vR2lCLG9DQU5wRzs7SUFRQUMsc0I7QUFDSixrQ0FBWUMsY0FBWixFQUE0QkMsS0FBNUIsRUFBbUM7QUFBQTs7QUFDakMsU0FBS0QsY0FBTCxHQUFzQkEsY0FBdEI7QUFDQSxTQUFLQyxLQUFMLEdBQWFBLEtBQWI7QUFDRDs7Ozt3Q0FFbUI7QUFDbEIsYUFBTyxLQUFLRCxjQUFaO0FBQ0Q7OzsrQkFFVTtBQUNULGFBQU8sS0FBS0MsS0FBWjtBQUNEOzs7dUNBRXlCQyxjLEVBQWdCO0FBQ3hDLFVBQU1DLHlCQUF5QkMseUNBQXlDRixjQUF6QyxDQUEvQjtBQUFBLFVBQ01HLGdCQUFnQkMsZ0NBQWdDSixjQUFoQyxDQUR0QjtBQUFBLFVBRU1GLGlCQUFpQkcsc0JBRnZCO0FBQUEsVUFFZ0Q7QUFDMUNGLGNBQVFJLGFBSGQ7QUFBQSxVQUc4QjtBQUN4QkUsK0JBQXlCLElBQUlSLHNCQUFKLENBQTJCQyxjQUEzQixFQUEyQ0MsS0FBM0MsQ0FKL0I7O0FBTUEsYUFBT00sc0JBQVA7QUFDRDs7Ozs7O0FBR0hDLE9BQU9DLE9BQVAsR0FBaUJWLHNCQUFqQjs7QUFFQSxTQUFTSyx3Q0FBVCxDQUFrREYsY0FBbEQsRUFBa0U7QUFDaEUsTUFBTVEsa0JBQWtCakIsa0NBQWtDUyxjQUFsQyxDQUF4QjtBQUFBLE1BQ01DLHlCQUF5Qk8sZ0JBQWdCQyxPQUFoQixHQUEwQkMsSUFBMUIsQ0FBK0IsR0FBL0IsQ0FEL0IsQ0FEZ0UsQ0FFSTs7QUFFcEUsU0FBT1Qsc0JBQVA7QUFDRDs7QUFFRCxTQUFTRywrQkFBVCxDQUF5Q0osY0FBekMsRUFBeUQ7QUFDdkQsTUFBTVcsd0JBQXdCLGVBQTlCO0FBQUEsTUFDTUMscUJBQXFCLFlBRDNCO0FBQUEsTUFFTUMsb0JBQW9CLFdBRjFCO0FBQUEsTUFHTUMsZUFBZSxNQUhyQjtBQUFBLE1BSU1DLHFCQUFxQkMsMERBQTBETCxxQkFBMUQsRUFBaUZYLGNBQWpGLEVBQWlHSixvQ0FBakcsQ0FKM0I7QUFBQSxNQUtNcUIsa0JBQWtCRCwwREFBMERKLGtCQUExRCxFQUE4RVosY0FBOUUsRUFBOEZMLGlDQUE5RixDQUx4QjtBQUFBLE1BTU11QixpQkFBaUJGLDBEQUEwREgsaUJBQTFELEVBQTZFYixjQUE3RSxFQUE2Rk4sZ0NBQTdGLENBTnZCO0FBQUEsTUFPTXlCLFlBQVlILDBEQUEwREYsWUFBMUQsRUFBd0VkLGNBQXhFLEVBQXdGUCwyQkFBeEYsQ0FQbEI7QUFBQSxNQVFNVSxnQkFBZ0IsR0FBR2lCLE1BQUgsQ0FBVUwsa0JBQVYsRUFBOEJLLE1BQTlCLENBQXFDRixjQUFyQyxFQUFxREUsTUFBckQsQ0FBNERILGVBQTVELEVBQTZFRyxNQUE3RSxDQUFvRkQsU0FBcEYsQ0FSdEI7O0FBVUEsU0FBT2hCLGFBQVA7QUFDRDs7QUFFRCxTQUFTYSx5REFBVCxDQUFtRUssUUFBbkUsRUFBNkVyQixjQUE3RSxFQUE2RnNCLHVCQUE3RixFQUFzSDtBQUNwSCxNQUFNQyxhQUFhRCx1QkFBbkI7QUFBQSxNQUE0QztBQUN0Q0UsU0FBT2hDLGtDQUFrQzZCLFFBQWxDLEVBQTRDckIsY0FBNUMsQ0FEYjtBQUFBLE1BRU15QixXQUFXQyxzQ0FBc0NMLFFBQXRDLEVBQWdERSxVQUFoRCxFQUE0REMsSUFBNUQsQ0FGakI7QUFBQSxNQUdNRyxpQkFBaUJDLDRDQUE0Q1AsUUFBNUMsRUFBc0RFLFVBQXRELEVBQWtFQyxJQUFsRSxDQUh2Qjs7QUFLQSxNQUFJekIsY0FBSjs7QUFFQUEsVUFBUSxHQUFHcUIsTUFBSCxDQUFVTyxjQUFWLEVBQTBCUCxNQUExQixDQUFpQ0ssUUFBakMsQ0FBUjs7QUFFQTFCLFVBQVFULCtCQUErQlMsS0FBL0IsQ0FBUjs7QUFFQSxNQUFNZ0IscUJBQXFCaEIsS0FBM0I7O0FBRUEsU0FBT2dCLGtCQUFQO0FBQ0Q7O0FBRUQsU0FBU2Msa0NBQVQsQ0FBNEM5QixLQUE1QyxFQUFtRDBCLFFBQW5ELEVBQTZEO0FBQzNELE1BQU1FLGlCQUFpQjVCLE1BQU0rQixNQUFOLENBQWEsVUFBU0MsSUFBVCxFQUFlO0FBQ2pELFFBQUlBLFNBQVNOLFFBQWIsRUFBdUI7QUFDckIsYUFBTyxJQUFQO0FBQ0Q7QUFDRixHQUpzQixDQUF2Qjs7QUFNQSxTQUFPRSxjQUFQO0FBQ0Q7O0FBRUQsU0FBU0QscUNBQVQsQ0FBK0NMLFFBQS9DLEVBQXlERSxVQUF6RCxFQUFxRUMsSUFBckUsRUFBMkU7QUFDekUsTUFBTVEsZUFBZTlDLGFBQWFxQyxVQUFiLENBQXJCO0FBQUEsTUFDTVUsa0JBQWtCNUMsbUJBQW1CZ0MsUUFBbkIsRUFBNkJXLFlBQTdCLENBRHhCO0FBQUEsTUFFTUUsNkJBQTZCRCxnQkFBZ0JFLGNBQWhCLEVBRm5DOztBQUlBWCxPQUFLWSxPQUFMLENBQWEsVUFBU0MsR0FBVCxFQUFjO0FBQ3pCLFFBQU10QyxRQUFRYixhQUFhbUQsR0FBYixDQUFkO0FBQUEsUUFDTVosV0FBV3BDLG1CQUFtQmdDLFFBQW5CLEVBQTZCdEIsS0FBN0IsQ0FEakI7QUFBQSxRQUVNdUMsc0JBQXVCYixhQUFhLElBQWQsR0FDRUEsU0FBU1UsY0FBVCxFQURGLEdBRUksRUFKaEM7O0FBTUEvQyxZQUFROEMsMEJBQVIsRUFBb0NJLG1CQUFwQztBQUNELEdBUkQ7O0FBVUEsTUFBTWIsV0FBV1EsZUFBakIsQ0FmeUUsQ0FldkM7O0FBRWxDLFNBQU9SLFFBQVA7QUFDRDs7QUFFRCxTQUFTRywyQ0FBVCxDQUFxRFAsUUFBckQsRUFBK0RFLFVBQS9ELEVBQTJFQyxJQUEzRSxFQUFpRjtBQUMvRSxNQUFNUSxlQUFlOUMsYUFBYXFDLFVBQWIsQ0FBckI7QUFBQSxNQUNNVSxrQkFBa0I1QyxtQkFBbUJnQyxRQUFuQixFQUE2QlcsWUFBN0IsQ0FEeEI7QUFBQSxNQUVNTyx3QkFBd0JWLG1DQUFtQ0csWUFBbkMsRUFBaURDLGVBQWpELENBRjlCOztBQUlBVCxPQUFLWSxPQUFMLENBQWEsVUFBU0MsR0FBVCxFQUFjO0FBQ3pCLFFBQU10QyxRQUFRYixhQUFhbUQsR0FBYixDQUFkO0FBQUEsUUFDTVosV0FBV3BDLG1CQUFtQmdDLFFBQW5CLEVBQTZCdEIsS0FBN0IsQ0FEakI7QUFBQSxRQUVNNEIsaUJBQWlCRSxtQ0FBbUM5QixLQUFuQyxFQUEwQzBCLFFBQTFDLENBRnZCOztBQUlBckMsWUFBUW1ELHFCQUFSLEVBQStCWixjQUEvQjtBQUNELEdBTkQ7O0FBUUEsTUFBTUEsaUJBQWlCWSxxQkFBdkIsQ0FiK0UsQ0FhakM7O0FBRTlDLFNBQU9aLGNBQVA7QUFDRCIsImZpbGUiOiJjb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpLCAvLy9cbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpLFxuICAgICAgZ3JhbW1hclV0aWxpdGllcyA9IHJlcXVpcmUoJ29jY2FtLWdyYW1tYXItdXRpbGl0aWVzJyk7ICAvLy9cblxuY29uc3QgcnVsZXNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlcycpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgY3VzdG9tR3JhbW1hcnNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9jdXN0b21HcmFtbWFycycpO1xuXG5jb25zdCB7IHJ1bGVzRnJvbUJORiB9ID0gcnVsZXNVdGlsaXRpZXMsXG4gICAgICB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHVuc2hpZnQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZUJ5UnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzLFxuICAgICAgeyBlbGltaW5hdGVJbXBsaWNpdExlZnRSZWN1cnNpb24gfSA9IGdyYW1tYXJVdGlsaXRpZXMsXG4gICAgICB7IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycywgYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIH0gPSBjdXN0b21HcmFtbWFyc1V0aWxpdGllcyxcbiAgICAgIHsgdGVybURlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCBzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCBtZXRhc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgfSA9IHBhcnNlcnM7XG5cbmNsYXNzIENvbWJpbmVkQ3VzdG9tR3JhbW1hcnMge1xuICBjb25zdHJ1Y3RvcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlcyA9IHJ1bGVzO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFJ1bGVzKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4gPSBjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBjb21iaW5lZFJ1bGVzID0gY29tYmluZWRSdWxlc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgbGV4aWNhbFBhdHRlcm4gPSBjb21iaW5lZExleGljYWxQYXR0ZXJuLCAgLy8vXG4gICAgICAgICAgcnVsZXMgPSBjb21iaW5lZFJ1bGVzLCAgLy8vXG4gICAgICAgICAgY29tYmluZWRDdXN0b21HcmFtbWFycyA9IG5ldyBDb21iaW5lZEN1c3RvbUdyYW1tYXJzKGxleGljYWxQYXR0ZXJuLCBydWxlcyk7XG4gICAgXG4gICAgcmV0dXJuIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcnM7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDb21iaW5lZEN1c3RvbUdyYW1tYXJzO1xuXG5mdW5jdGlvbiBjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGxleGljYWxQYXR0ZXJucyA9IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgIGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4gPSBsZXhpY2FsUGF0dGVybnMucmV2ZXJzZSgpLmpvaW4oJ3wnKTsgLy8vXG5cbiAgcmV0dXJuIGNvbWJpbmVkTGV4aWNhbFBhdHRlcm47XG59XG5cbmZ1bmN0aW9uIGNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVOYW1lID0gJ21ldGFzdGF0ZW1lbnQnLFxuICAgICAgICBleHByZXNzaW9uUnVsZU5hbWUgPSAnZXhwcmVzc2lvbicsXG4gICAgICAgIHN0YXRlbWVudFJ1bGVOYW1lID0gJ3N0YXRlbWVudCcsXG4gICAgICAgIHRlcm1SdWxlTmFtZSA9ICd0ZXJtJyxcbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRDdXN0b21HcmFtbWFyQk5GKG1ldGFzdGF0ZW1lbnRSdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiksXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Q3VzdG9tR3JhbW1hckJORihleHByZXNzaW9uUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBleHByZXNzaW9uRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Q3VzdG9tR3JhbW1hckJORihzdGF0ZW1lbnRSdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIHN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GKSxcbiAgICAgICAgdGVybVJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRDdXN0b21HcmFtbWFyQk5GKHRlcm1SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIHRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiksXG4gICAgICAgIGNvbWJpbmVkUnVsZXMgPSBbXS5jb25jYXQobWV0YXN0YXRlbWVudFJ1bGVzKS5jb25jYXQoc3RhdGVtZW50UnVsZXMpLmNvbmNhdChleHByZXNzaW9uUnVsZXMpLmNvbmNhdCh0ZXJtUnVsZXMpO1xuXG4gIHJldHVybiBjb21iaW5lZFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBkZWZhdWx0Q3VzdG9tR3JhbW1hckJORikge1xuICBjb25zdCBkZWZhdWx0Qk5GID0gZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBibmZzID0gYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyk7XG5cbiAgbGV0IHJ1bGVzO1xuXG4gIHJ1bGVzID0gW10uY29uY2F0KHJlbWFpbmluZ1J1bGVzKS5jb25jYXQobWFpblJ1bGUpO1xuXG4gIHJ1bGVzID0gZWxpbWluYXRlSW1wbGljaXRMZWZ0UmVjdXJzaW9uKHJ1bGVzKTtcblxuICBjb25zdCBtZXRhc3RhdGVtZW50UnVsZXMgPSBydWxlcztcblxuICByZXR1cm4gbWV0YXN0YXRlbWVudFJ1bGVzO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSkge1xuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IHJ1bGVzLmZpbHRlcihmdW5jdGlvbihydWxlKSB7XG4gICAgaWYgKHJ1bGUgIT09IG1haW5SdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMgPSBkZWZhdWx0TWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBibmZzLmZvckVhY2goZnVuY3Rpb24oYm5mKSB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIG1haW5SdWxlRGVmaW5pdGlvbnMgPSAobWFpblJ1bGUgIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUnVsZS5nZXREZWZpbml0aW9ucygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucywgbWFpblJ1bGVEZWZpbml0aW9ucyk7XG4gIH0pO1xuXG4gIGNvbnN0IG1haW5SdWxlID0gZGVmYXVsdE1haW5SdWxlOyAvLy9cblxuICByZXR1cm4gbWFpblJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRSZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSk7XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRSZW1haW5pbmdSdWxlcywgcmVtYWluaW5nUnVsZXMpO1xuICB9KTtcblxuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IGRlZmF1bHRSZW1haW5pbmdSdWxlczsgLy8vXG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuIl19