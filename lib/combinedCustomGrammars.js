'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var parsers = require('occam-parsers'),
    necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities');

var ruleUtilities = require('./utilities/rule');

var arrayUtilities = necessary.arrayUtilities,
    unshift = arrayUtilities.unshift,
    findRuleByName = ruleUtilities.findRuleByName,
    eliminateLeftRecursion = grammarUtilities.eliminateLeftRecursion,
    BasicParser = parsers.BasicParser,
    termDefaultCustomGrammarBNF = parsers.termDefaultCustomGrammarBNF,
    statementDefaultCustomGrammarBNF = parsers.statementDefaultCustomGrammarBNF,
    expressionDefaultCustomGrammarBNF = parsers.expressionDefaultCustomGrammarBNF,
    metastatementDefaultCustomGrammarBNF = parsers.metastatementDefaultCustomGrammarBNF;

var CombinedCustomGrammars = function () {
  function CombinedCustomGrammars(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammars);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammars, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var combinedLexicalPattern = combinedLexicalPatternFromCustomGrammars(customGrammars),
          combinedRules = combinedRulesFromCustomGrammars(customGrammars),
          lexicalPattern = combinedLexicalPattern,
          ///
      rules = combinedRules,
          ///
      combinedCustomGrammars = new CombinedCustomGrammars(lexicalPattern, rules);

      return combinedCustomGrammars;
    }
  }]);

  return CombinedCustomGrammars;
}();

module.exports = CombinedCustomGrammars;

function combinedLexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars),
      combinedLexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return combinedLexicalPattern;
}

function combinedRulesFromCustomGrammars(customGrammars) {
  var termDefaultBNF = termDefaultCustomGrammarBNF,
      ///
  statementDefaultBNF = statementDefaultCustomGrammarBNF,
      ///
  expressionDefaultBNF = expressionDefaultCustomGrammarBNF,
      ///
  metastatementDefaultBNF = metastatementDefaultCustomGrammarBNF,
      ///
  termBNFs = bnfsFromCustomGrammars('term', customGrammars),
      statementBNFs = bnfsFromCustomGrammars('statement', customGrammars),
      expressionBNFs = bnfsFromCustomGrammars('expression', customGrammars),
      metastatementBNFs = bnfsFromCustomGrammars('metastatement', customGrammars),
      termRules = rulesFromBNFs('term', termDefaultBNF, termBNFs),
      statementRules = rulesFromBNFs('statement', statementDefaultBNF, statementBNFs),
      expressionRules = rulesFromBNFs('expression', expressionDefaultBNF, expressionBNFs),
      metastatementRules = rulesFromBNFs('metastatement', metastatementDefaultBNF, metastatementBNFs),
      combinedRules = [].concat(termRules).concat(expressionRules).concat(statementRules).concat(metastatementRules); ///

  return combinedRules;
}

function lexicalPatternsFromCustomGrammars(customGrammars) {
  var lexicalPatterns = [];

  customGrammars.forEach(function (customGrammar) {
    var lexicalPattern = customGrammar.getLexicalPattern();

    if (lexicalPattern !== null) {
      lexicalPatterns.push(lexicalPattern);
    }
  });

  return lexicalPatterns;
}

function bnfsFromCustomGrammars(ruleName, customGrammars) {
  var bnfs = [];

  customGrammars.forEach(function (customGrammar) {
    var bnf = customGrammar.getBNF(ruleName);

    if (bnf !== null) {
      bnfs.push(bnf);
    }
  });

  return bnfs;
}

function rulesFromBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = mainRuleFromRulesAndRuleName(defaultRules, ruleName),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = mainRuleFromRulesAndRuleName(rules, ruleName),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultRemainingRules, remainingRules);

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule,
      ///
  remainingRules = defaultRemainingRules; ///

  var rules = [].concat(mainRule).concat(remainingRules);

  rules = eliminateLeftRecursion(rules); ///

  return rules;
}

function rulesFromBNF(bnf) {
  var basicParser = BasicParser.fromBNF(bnf),
      rules = basicParser.getRules();

  return rules;
}

function mainRuleFromRulesAndRuleName(rules, ruleName) {
  var name = ruleName,
      ///
  mainRule = findRuleByName(name, rules);

  return mainRule;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });

  return remainingRules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIl0sIm5hbWVzIjpbInBhcnNlcnMiLCJyZXF1aXJlIiwibmVjZXNzYXJ5IiwiZ3JhbW1hclV0aWxpdGllcyIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInVuc2hpZnQiLCJmaW5kUnVsZUJ5TmFtZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJCYXNpY1BhcnNlciIsInRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiIsInN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwibWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiQ29tYmluZWRDdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImNvbWJpbmVkTGV4aWNhbFBhdHRlcm4iLCJjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwiY29tYmluZWRSdWxlcyIsImNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXJzIiwibW9kdWxlIiwiZXhwb3J0cyIsImxleGljYWxQYXR0ZXJucyIsImxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyIsInJldmVyc2UiLCJqb2luIiwidGVybURlZmF1bHRCTkYiLCJzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsInRlcm1CTkZzIiwiYm5mc0Zyb21DdXN0b21HcmFtbWFycyIsInN0YXRlbWVudEJORnMiLCJleHByZXNzaW9uQk5GcyIsIm1ldGFzdGF0ZW1lbnRCTkZzIiwidGVybVJ1bGVzIiwicnVsZXNGcm9tQk5GcyIsInN0YXRlbWVudFJ1bGVzIiwiZXhwcmVzc2lvblJ1bGVzIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwiY29uY2F0IiwiZm9yRWFjaCIsImN1c3RvbUdyYW1tYXIiLCJnZXRMZXhpY2FsUGF0dGVybiIsInB1c2giLCJydWxlTmFtZSIsImJuZnMiLCJibmYiLCJnZXRCTkYiLCJkZWZhdWx0Qk5GIiwiZGVmYXVsdFJ1bGVzIiwicnVsZXNGcm9tQk5GIiwiZGVmYXVsdE1haW5SdWxlIiwibWFpblJ1bGVGcm9tUnVsZXNBbmRSdWxlTmFtZSIsImRlZmF1bHRSZW1haW5pbmdSdWxlcyIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwibWFpblJ1bGUiLCJyZW1haW5pbmdSdWxlcyIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJiYXNpY1BhcnNlciIsImZyb21CTkYiLCJnZXRSdWxlcyIsIm5hbWUiLCJmaWx0ZXIiLCJydWxlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxlQUFSLENBQWhCO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCO0FBQUEsSUFFTUUsbUJBQW1CRixRQUFRLHlCQUFSLENBRnpCOztBQUlBLElBQU1HLGdCQUFnQkgsUUFBUSxrQkFBUixDQUF0Qjs7QUFFTSxJQUFFSSxjQUFGLEdBQXFCSCxTQUFyQixDQUFFRyxjQUFGO0FBQUEsSUFDRUMsT0FERixHQUNjRCxjQURkLENBQ0VDLE9BREY7QUFBQSxJQUVFQyxjQUZGLEdBRXFCSCxhQUZyQixDQUVFRyxjQUZGO0FBQUEsSUFHRUMsc0JBSEYsR0FHNkJMLGdCQUg3QixDQUdFSyxzQkFIRjtBQUFBLElBSUVDLFdBSkYsR0FJMEpULE9BSjFKLENBSUVTLFdBSkY7QUFBQSxJQUllQywyQkFKZixHQUkwSlYsT0FKMUosQ0FJZVUsMkJBSmY7QUFBQSxJQUk0Q0MsZ0NBSjVDLEdBSTBKWCxPQUoxSixDQUk0Q1csZ0NBSjVDO0FBQUEsSUFJOEVDLGlDQUo5RSxHQUkwSlos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QixDQUEyQm1CLGNBQTNCLENBQVo7O0FBRUE5QyxVQUFRUix1QkFBdUJRLEtBQXZCLENBQVIsQ0F4QmlELENBd0JUOztBQUV4QyxTQUFPQSxLQUFQO0FBQ0Q7O0FBRUQsU0FBU3NDLFlBQVQsQ0FBc0JKLEdBQXRCLEVBQTJCO0FBQ3pCLE1BQU1jLGNBQWN2RCxZQUFZd0QsT0FBWixDQUFvQmYsR0FBcEIsQ0FBcEI7QUFBQSxNQUNNbEMsUUFBUWdELFlBQVlFLFFBQVosRUFEZDs7QUFHQSxTQUFPbEQsS0FBUDtBQUNEOztBQUVELFNBQVN3Qyw0QkFBVCxDQUFzQ3hDLEtBQXRDLEVBQTZDZ0MsUUFBN0MsRUFBdUQ7QUFDckQsTUFBTW1CLE9BQU9uQixRQUFiO0FBQUEsTUFBd0I7QUFDbEJhLGFBQVd0RCxlQUFlNEQsSUFBZixFQUFxQm5ELEtBQXJCLENBRGpCOztBQUdBLFNBQU82QyxRQUFQO0FBQ0Q7O0FBRUQsU0FBU0gsa0NBQVQsQ0FBNEMxQyxLQUE1QyxFQUFtRDZDLFFBQW5ELEVBQTZEO0FBQzNELE1BQU1DLGlCQUFpQjlDLE1BQU1vRCxNQUFOLENBQWEsVUFBU0MsSUFBVCxFQUFlO0FBQ2pELFFBQUlBLFNBQVNSLFFBQWIsRUFBdUI7QUFDckIsYUFBTyxJQUFQO0FBQ0Q7QUFDRixHQUpzQixDQUF2Qjs7QUFNQSxTQUFPQyxjQUFQO0FBQ0QiLCJmaWxlIjoiY29tYmluZWRDdXN0b21HcmFtbWFycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcGFyc2VycyA9IHJlcXVpcmUoJ29jY2FtLXBhcnNlcnMnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpLFxuICAgICAgZ3JhbW1hclV0aWxpdGllcyA9IHJlcXVpcmUoJ29jY2FtLWdyYW1tYXItdXRpbGl0aWVzJyk7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgdW5zaGlmdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRSdWxlQnlOYW1lIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIH0gPSBncmFtbWFyVXRpbGl0aWVzLFxuICAgICAgeyBCYXNpY1BhcnNlciwgdGVybURlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCBzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCBtZXRhc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgfSA9IHBhcnNlcnM7XG5cbmNsYXNzIENvbWJpbmVkQ3VzdG9tR3JhbW1hcnMge1xuICBjb25zdHJ1Y3RvcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlcyA9IHJ1bGVzO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFJ1bGVzKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4gPSBjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBjb21iaW5lZFJ1bGVzID0gY29tYmluZWRSdWxlc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgbGV4aWNhbFBhdHRlcm4gPSBjb21iaW5lZExleGljYWxQYXR0ZXJuLCAgLy8vXG4gICAgICAgICAgcnVsZXMgPSBjb21iaW5lZFJ1bGVzLCAgLy8vXG4gICAgICAgICAgY29tYmluZWRDdXN0b21HcmFtbWFycyA9IG5ldyBDb21iaW5lZEN1c3RvbUdyYW1tYXJzKGxleGljYWxQYXR0ZXJuLCBydWxlcyk7XG4gICAgXG4gICAgcmV0dXJuIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcnM7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDb21iaW5lZEN1c3RvbUdyYW1tYXJzO1xuXG5mdW5jdGlvbiBjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGxleGljYWxQYXR0ZXJucyA9IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgIGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4gPSBsZXhpY2FsUGF0dGVybnMucmV2ZXJzZSgpLmpvaW4oJ3wnKTsgLy8vXG5cbiAgcmV0dXJuIGNvbWJpbmVkTGV4aWNhbFBhdHRlcm47XG59XG5cbmZ1bmN0aW9uIGNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgdGVybURlZmF1bHRCTkYgPSB0ZXJtRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBzdGF0ZW1lbnREZWZhdWx0Qk5GID0gc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBleHByZXNzaW9uRGVmYXVsdEJORiA9IGV4cHJlc3Npb25EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgLy8vXG4gICAgICAgIG1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GID0gbWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgdGVybUJORnMgPSBibmZzRnJvbUN1c3RvbUdyYW1tYXJzKCd0ZXJtJywgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBzdGF0ZW1lbnRCTkZzID0gYm5mc0Zyb21DdXN0b21HcmFtbWFycygnc3RhdGVtZW50JywgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBleHByZXNzaW9uQk5GcyA9IGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMoJ2V4cHJlc3Npb24nLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIG1ldGFzdGF0ZW1lbnRCTkZzID0gYm5mc0Zyb21DdXN0b21HcmFtbWFycygnbWV0YXN0YXRlbWVudCcsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgdGVybVJ1bGVzID0gcnVsZXNGcm9tQk5GcygndGVybScsIHRlcm1EZWZhdWx0Qk5GLCB0ZXJtQk5GcyksXG4gICAgICAgIHN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tQk5Gcygnc3RhdGVtZW50Jywgc3RhdGVtZW50RGVmYXVsdEJORiwgc3RhdGVtZW50Qk5GcyksXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbUJORnMoJ2V4cHJlc3Npb24nLCBleHByZXNzaW9uRGVmYXVsdEJORiwgZXhwcmVzc2lvbkJORnMpLFxuICAgICAgICBtZXRhc3RhdGVtZW50UnVsZXMgPSBydWxlc0Zyb21CTkZzKCdtZXRhc3RhdGVtZW50JywgbWV0YXN0YXRlbWVudERlZmF1bHRCTkYsIG1ldGFzdGF0ZW1lbnRCTkZzKSxcbiAgICAgICAgY29tYmluZWRSdWxlcyA9IFtdLmNvbmNhdCh0ZXJtUnVsZXMpLmNvbmNhdChleHByZXNzaW9uUnVsZXMpLmNvbmNhdChzdGF0ZW1lbnRSdWxlcykuY29uY2F0KG1ldGFzdGF0ZW1lbnRSdWxlcyk7IC8vL1xuXG4gIHJldHVybiBjb21iaW5lZFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zID0gW107XG5cbiAgY3VzdG9tR3JhbW1hcnMuZm9yRWFjaChmdW5jdGlvbihjdXN0b21HcmFtbWFyKSB7XG4gICAgY29uc3QgbGV4aWNhbFBhdHRlcm4gPSBjdXN0b21HcmFtbWFyLmdldExleGljYWxQYXR0ZXJuKCk7XG5cbiAgICBpZiAobGV4aWNhbFBhdHRlcm4gIT09IG51bGwpIHtcbiAgICAgIGxleGljYWxQYXR0ZXJucy5wdXNoKGxleGljYWxQYXR0ZXJuKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBsZXhpY2FsUGF0dGVybnM7XG59XG5cbmZ1bmN0aW9uIGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGJuZnMgPSBbXTtcblxuICBjdXN0b21HcmFtbWFycy5mb3JFYWNoKGZ1bmN0aW9uKGN1c3RvbUdyYW1tYXIpIHtcbiAgICBjb25zdCBibmYgPSBjdXN0b21HcmFtbWFyLmdldEJORihydWxlTmFtZSk7XG5cbiAgICBpZiAoYm5mICE9PSBudWxsKSB7XG4gICAgICBibmZzLnB1c2goYm5mKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBibmZzO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21CTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZXNBbmRSdWxlTmFtZShkZWZhdWx0UnVsZXMsIHJ1bGVOYW1lKSxcbiAgICAgICAgZGVmYXVsdFJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShkZWZhdWx0UnVsZXMsIGRlZmF1bHRNYWluUnVsZSksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zID0gZGVmYXVsdE1haW5SdWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgYm5mcy5mb3JFYWNoKGZ1bmN0aW9uKGJuZikge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBtYWluUnVsZUZyb21SdWxlc0FuZFJ1bGVOYW1lKHJ1bGVzLCBydWxlTmFtZSksXG4gICAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSksXG4gICAgICAgICAgbWFpblJ1bGVEZWZpbml0aW9ucyA9IChtYWluUnVsZSAhPT0gbnVsbCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5SdWxlLmdldERlZmluaXRpb25zKCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW107XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRSZW1haW5pbmdSdWxlcywgcmVtYWluaW5nUnVsZXMpO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucywgbWFpblJ1bGVEZWZpbml0aW9ucyk7XG4gIH0pO1xuXG4gIGNvbnN0IG1haW5SdWxlID0gZGVmYXVsdE1haW5SdWxlLCAvLy9cbiAgICAgICAgcmVtYWluaW5nUnVsZXMgPSBkZWZhdWx0UmVtYWluaW5nUnVsZXM7IC8vL1xuXG4gIGxldCBydWxlcyA9IFtdLmNvbmNhdChtYWluUnVsZSkuY29uY2F0KHJlbWFpbmluZ1J1bGVzKTtcblxuICBydWxlcyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpOyAgLy8vXG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21CTkYoYm5mKSB7XG4gIGNvbnN0IGJhc2ljUGFyc2VyID0gQmFzaWNQYXJzZXIuZnJvbUJORihibmYpLFxuICAgICAgICBydWxlcyA9IGJhc2ljUGFyc2VyLmdldFJ1bGVzKCk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBtYWluUnVsZUZyb21SdWxlc0FuZFJ1bGVOYW1lKHJ1bGVzLCBydWxlTmFtZSkge1xuICBjb25zdCBuYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgcmV0dXJuIG1haW5SdWxlO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSkge1xuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IHJ1bGVzLmZpbHRlcihmdW5jdGlvbihydWxlKSB7XG4gICAgaWYgKHJ1bGUgIT09IG1haW5SdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cbiJdfQ==