'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var parsers = require('occam-parsers'),
    necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities');

var ruleUtilities = require('./utilities/rule');

var arrayUtilities = necessary.arrayUtilities,
    unshift = arrayUtilities.unshift,
    findRuleByName = ruleUtilities.findRuleByName,
    eliminateLeftRecursion = grammarUtilities.eliminateLeftRecursion,
    BasicParser = parsers.BasicParser,
    termDefaultCustomGrammarBNF = parsers.termDefaultCustomGrammarBNF,
    statementDefaultCustomGrammarBNF = parsers.statementDefaultCustomGrammarBNF,
    expressionDefaultCustomGrammarBNF = parsers.expressionDefaultCustomGrammarBNF,
    metastatementDefaultCustomGrammarBNF = parsers.metastatementDefaultCustomGrammarBNF;

var CombinedCustomGrammars = function () {
  function CombinedCustomGrammars(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammars);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammars, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var combinedLexicalPattern = combinedLexicalPatternFromCustomGrammars(customGrammars),
          combinedRules = combinedRulesFromCustomGrammars(customGrammars),
          lexicalPattern = combinedLexicalPattern,
          ///
      rules = eliminateLeftRecursion(combinedRules),
          ///
      combinedCustomGrammars = new CombinedCustomGrammars(lexicalPattern, rules);

      return combinedCustomGrammars;
    }
  }]);

  return CombinedCustomGrammars;
}();

module.exports = CombinedCustomGrammars;

function combinedLexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars),
      combinedLexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return combinedLexicalPattern;
}

function combinedRulesFromCustomGrammars(customGrammars) {
  var termDefaultBNF = termDefaultCustomGrammarBNF,
      ///
  statementDefaultBNF = statementDefaultCustomGrammarBNF,
      ///
  expressionDefaultBNF = expressionDefaultCustomGrammarBNF,
      ///
  metastatementDefaultBNF = metastatementDefaultCustomGrammarBNF,
      ///
  termBNFs = bnfsFromCustomGrammars('term', customGrammars),
      statementBNFs = bnfsFromCustomGrammars('statement', customGrammars),
      expressionBNFs = bnfsFromCustomGrammars('expression', customGrammars),
      metastatementBNFs = bnfsFromCustomGrammars('metastatement', customGrammars),
      termRules = rulesFromBNFs('term', termDefaultBNF, termBNFs),
      statementRules = rulesFromBNFs('statement', statementDefaultBNF, statementBNFs),
      expressionRules = rulesFromBNFs('expression', expressionDefaultBNF, expressionBNFs),
      metastatementRules = rulesFromBNFs('metastatement', metastatementDefaultBNF, metastatementBNFs),
      combinedRules = [].concat(termRules).concat(expressionRules).concat(statementRules).concat(metastatementRules); ///

  return combinedRules;
}

function lexicalPatternsFromCustomGrammars(customGrammars) {
  var lexicalPatterns = [];

  customGrammars.forEach(function (customGrammar) {
    var lexicalPattern = customGrammar.getLexicalPattern();

    if (lexicalPattern) {
      ///
      lexicalPatterns.push(lexicalPattern);
    }
  });

  return lexicalPatterns;
}

function bnfsFromCustomGrammars(ruleName, customGrammars) {
  var bnfs = [];

  customGrammars.forEach(function (customGrammar) {
    var bnf = customGrammar.getBNF(ruleName);

    if (bnf) {
      ///
      bnfs.push(bnf);
    }
  });

  return bnfs;
}

function rulesFromBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = mainRuleFromRulesAndRuleName(defaultRules, ruleName),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = mainRuleFromRulesAndRuleName(rules, ruleName),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultRemainingRules, remainingRules);

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule,
      ///
  remainingRules = defaultRemainingRules; ///

  var rules = [].concat(mainRule).concat(remainingRules);

  return rules;
}

function rulesFromBNF(bnf) {
  var basicParser = BasicParser.fromBNF(bnf),
      rules = basicParser.getRules();

  return rules;
}

function mainRuleFromRulesAndRuleName(rules, ruleName) {
  var name = ruleName,
      ///
  mainRule = findRuleByName(name, rules);

  return mainRule;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });

  return remainingRules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIl0sIm5hbWVzIjpbInBhcnNlcnMiLCJyZXF1aXJlIiwibmVjZXNzYXJ5IiwiZ3JhbW1hclV0aWxpdGllcyIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInVuc2hpZnQiLCJmaW5kUnVsZUJ5TmFtZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJCYXNpY1BhcnNlciIsInRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiIsInN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwibWV0YXN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwiQ29tYmluZWRDdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImNvbWJpbmVkTGV4aWNhbFBhdHRlcm4iLCJjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwiY29tYmluZWRSdWxlcyIsImNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXJzIiwibW9kdWxlIiwiZXhwb3J0cyIsImxleGljYWxQYXR0ZXJucyIsImxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyIsInJldmVyc2UiLCJqb2luIiwidGVybURlZmF1bHRCTkYiLCJzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsInRlcm1CTkZzIiwiYm5mc0Zyb21DdXN0b21HcmFtbWFycyIsInN0YXRlbWVudEJORnMiLCJleHByZXNzaW9uQk5GcyIsIm1ldGFzdGF0ZW1lbnRCTkZzIiwidGVybVJ1bGVzIiwicnVsZXNGcm9tQk5GcyIsInN0YXRlbWVudFJ1bGVzIiwiZXhwcmVzc2lvblJ1bGVzIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwiY29uY2F0IiwiZm9yRWFjaCIsImN1c3RvbUdyYW1tYXIiLCJnZXRMZXhpY2FsUGF0dGVybiIsInB1c2giLCJydWxlTmFtZSIsImJuZnMiLCJibmYiLCJnZXRCTkYiLCJkZWZhdWx0Qk5GIiwiZGVmYXVsdFJ1bGVzIiwicnVsZXNGcm9tQk5GIiwiZGVmYXVsdE1haW5SdWxlIiwibWFpblJ1bGVGcm9tUnVsZXNBbmRSdWxlTmFtZSIsImRlZmF1bHRSZW1haW5pbmdSdWxlcyIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwibWFpblJ1bGUiLCJyZW1haW5pbmdSdWxlcyIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJiYXNpY1BhcnNlciIsImZyb21CTkYiLCJnZXRSdWxlcyIsIm5hbWUiLCJmaWx0ZXIiLCJydWxlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxlQUFSLENBQWhCO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCO0FBQUEsSUFFTUUsbUJBQW1CRixRQUFRLHlCQUFSLENBRnpCOztBQUlBLElBQU1HLGdCQUFnQkgsUUFBUSxrQkFBUixDQUF0Qjs7QUFFTSxJQUFFSSxjQUFGLEdBQXFCSCxTQUFyQixDQUFFRyxjQUFGO0FBQUEsSUFDRUMsT0FERixHQUNjRCxjQURkLENBQ0VDLE9BREY7QUFBQSxJQUVFQyxjQUZGLEdBRXFCSCxhQUZyQixDQUVFRyxjQUZGO0FBQUEsSUFHRUMsc0JBSEYsR0FHNkJMLGdCQUg3QixDQUdFSyxzQkFIRjtBQUFBLElBSUVDLFdBSkYsR0FJMEpULE9BSjFKLENBSUVTLFdBSkY7QUFBQSxJQUllQywyQkFKZixHQUkwSlYsT0FKMUosQ0FJZVUsMkJBSmY7QUFBQSxJQUk0Q0MsZ0NBSjVDLEdBSTBKWCxPQUoxSixDQUk0Q1csZ0NBSjVDO0FBQUEsSUFJOEVDLGlDQUo5RSxHQUkwSlos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b0JsQixNQUFwQixDQUEyQm1CLGNBQTNCLENBQWQ7O0FBRUEsU0FBTzlDLEtBQVA7QUFDRDs7QUFFRCxTQUFTc0MsWUFBVCxDQUFzQkosR0FBdEIsRUFBMkI7QUFDekIsTUFBTWMsY0FBY3ZELFlBQVl3RCxPQUFaLENBQW9CZixHQUFwQixDQUFwQjtBQUFBLE1BQ01sQyxRQUFRZ0QsWUFBWUUsUUFBWixFQURkOztBQUdBLFNBQU9sRCxLQUFQO0FBQ0Q7O0FBRUQsU0FBU3dDLDRCQUFULENBQXNDeEMsS0FBdEMsRUFBNkNnQyxRQUE3QyxFQUF1RDtBQUNyRCxNQUFNbUIsT0FBT25CLFFBQWI7QUFBQSxNQUF3QjtBQUNsQmEsYUFBV3RELGVBQWU0RCxJQUFmLEVBQXFCbkQsS0FBckIsQ0FEakI7O0FBR0EsU0FBTzZDLFFBQVA7QUFDRDs7QUFFRCxTQUFTSCxrQ0FBVCxDQUE0QzFDLEtBQTVDLEVBQW1ENkMsUUFBbkQsRUFBNkQ7QUFDM0QsTUFBTUMsaUJBQWlCOUMsTUFBTW9ELE1BQU4sQ0FBYSxVQUFTQyxJQUFULEVBQWU7QUFDakQsUUFBSUEsU0FBU1IsUUFBYixFQUF1QjtBQUNyQixhQUFPLElBQVA7QUFDRDtBQUNGLEdBSnNCLENBQXZCOztBQU1BLFNBQU9DLGNBQVA7QUFDRCIsImZpbGUiOiJjb21iaW5lZEN1c3RvbUdyYW1tYXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5JyksXG4gICAgICBncmFtbWFyVXRpbGl0aWVzID0gcmVxdWlyZSgnb2NjYW0tZ3JhbW1hci11dGlsaXRpZXMnKTtcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24gfSA9IGdyYW1tYXJVdGlsaXRpZXMsXG4gICAgICB7IEJhc2ljUGFyc2VyLCB0ZXJtRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIHN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCBleHByZXNzaW9uRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiB9ID0gcGFyc2VycztcblxuY2xhc3MgQ29tYmluZWRDdXN0b21HcmFtbWFycyB7XG4gIGNvbnN0cnVjdG9yKGxleGljYWxQYXR0ZXJuLCBydWxlcykge1xuICAgIHRoaXMubGV4aWNhbFBhdHRlcm4gPSBsZXhpY2FsUGF0dGVybjtcbiAgICB0aGlzLnJ1bGVzID0gcnVsZXM7XG4gIH1cbiAgXG4gIGdldExleGljYWxQYXR0ZXJuKCkge1xuICAgIHJldHVybiB0aGlzLmxleGljYWxQYXR0ZXJuO1xuICB9XG5cbiAgZ2V0UnVsZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMucnVsZXM7XG4gIH1cblxuICBzdGF0aWMgZnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gICAgY29uc3QgY29tYmluZWRMZXhpY2FsUGF0dGVybiA9IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIGNvbWJpbmVkUnVsZXMgPSBjb21iaW5lZFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBsZXhpY2FsUGF0dGVybiA9IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4sICAvLy9cbiAgICAgICAgICBydWxlcyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24oY29tYmluZWRSdWxlcyksICAvLy9cbiAgICAgICAgICBjb21iaW5lZEN1c3RvbUdyYW1tYXJzID0gbmV3IENvbWJpbmVkQ3VzdG9tR3JhbW1hcnMobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKTtcbiAgICBcbiAgICByZXR1cm4gY29tYmluZWRDdXN0b21HcmFtbWFycztcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvbWJpbmVkQ3VzdG9tR3JhbW1hcnM7XG5cbmZ1bmN0aW9uIGNvbWJpbmVkTGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zID0gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgY29tYmluZWRMZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJucy5yZXZlcnNlKCkuam9pbignfCcpOyAvLy9cblxuICByZXR1cm4gY29tYmluZWRMZXhpY2FsUGF0dGVybjtcbn1cblxuZnVuY3Rpb24gY29tYmluZWRSdWxlc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCB0ZXJtRGVmYXVsdEJORiA9IHRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgLy8vXG4gICAgICAgIHN0YXRlbWVudERlZmF1bHRCTkYgPSBzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgLy8vXG4gICAgICAgIGV4cHJlc3Npb25EZWZhdWx0Qk5GID0gZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgbWV0YXN0YXRlbWVudERlZmF1bHRCTkYgPSBtZXRhc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICB0ZXJtQk5GcyA9IGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMoJ3Rlcm0nLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIHN0YXRlbWVudEJORnMgPSBibmZzRnJvbUN1c3RvbUdyYW1tYXJzKCdzdGF0ZW1lbnQnLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIGV4cHJlc3Npb25CTkZzID0gYm5mc0Zyb21DdXN0b21HcmFtbWFycygnZXhwcmVzc2lvbicsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgbWV0YXN0YXRlbWVudEJORnMgPSBibmZzRnJvbUN1c3RvbUdyYW1tYXJzKCdtZXRhc3RhdGVtZW50JywgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICB0ZXJtUnVsZXMgPSBydWxlc0Zyb21CTkZzKCd0ZXJtJywgdGVybURlZmF1bHRCTkYsIHRlcm1CTkZzKSxcbiAgICAgICAgc3RhdGVtZW50UnVsZXMgPSBydWxlc0Zyb21CTkZzKCdzdGF0ZW1lbnQnLCBzdGF0ZW1lbnREZWZhdWx0Qk5GLCBzdGF0ZW1lbnRCTkZzKSxcbiAgICAgICAgZXhwcmVzc2lvblJ1bGVzID0gcnVsZXNGcm9tQk5GcygnZXhwcmVzc2lvbicsIGV4cHJlc3Npb25EZWZhdWx0Qk5GLCBleHByZXNzaW9uQk5GcyksXG4gICAgICAgIG1ldGFzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbUJORnMoJ21ldGFzdGF0ZW1lbnQnLCBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiwgbWV0YXN0YXRlbWVudEJORnMpLFxuICAgICAgICBjb21iaW5lZFJ1bGVzID0gW10uY29uY2F0KHRlcm1SdWxlcykuY29uY2F0KGV4cHJlc3Npb25SdWxlcykuY29uY2F0KHN0YXRlbWVudFJ1bGVzKS5jb25jYXQobWV0YXN0YXRlbWVudFJ1bGVzKTsgLy8vXG5cbiAgcmV0dXJuIGNvbWJpbmVkUnVsZXM7XG59XG5cbmZ1bmN0aW9uIGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBbXTtcblxuICBjdXN0b21HcmFtbWFycy5mb3JFYWNoKGZ1bmN0aW9uKGN1c3RvbUdyYW1tYXIpIHtcbiAgICBjb25zdCBsZXhpY2FsUGF0dGVybiA9IGN1c3RvbUdyYW1tYXIuZ2V0TGV4aWNhbFBhdHRlcm4oKTtcblxuICAgIGlmIChsZXhpY2FsUGF0dGVybikgeyAvLy9cbiAgICAgIGxleGljYWxQYXR0ZXJucy5wdXNoKGxleGljYWxQYXR0ZXJuKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBsZXhpY2FsUGF0dGVybnM7XG59XG5cbmZ1bmN0aW9uIGJuZnNGcm9tQ3VzdG9tR3JhbW1hcnMocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGJuZnMgPSBbXTtcblxuICBjdXN0b21HcmFtbWFycy5mb3JFYWNoKGZ1bmN0aW9uKGN1c3RvbUdyYW1tYXIpIHtcbiAgICBjb25zdCBibmYgPSBjdXN0b21HcmFtbWFyLmdldEJORihydWxlTmFtZSk7XG5cbiAgICBpZiAoYm5mKSB7ICAvLy9cbiAgICAgIGJuZnMucHVzaChibmYpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIGJuZnM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbUJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBtYWluUnVsZUZyb21SdWxlc0FuZFJ1bGVOYW1lKGRlZmF1bHRSdWxlcywgcnVsZU5hbWUpLFxuICAgICAgICBkZWZhdWx0UmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKGRlZmF1bHRSdWxlcywgZGVmYXVsdE1haW5SdWxlKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMgPSBkZWZhdWx0TWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBibmZzLmZvckVhY2goZnVuY3Rpb24oYm5mKSB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IG1haW5SdWxlRnJvbVJ1bGVzQW5kUnVsZU5hbWUocnVsZXMsIHJ1bGVOYW1lKSxcbiAgICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSxcbiAgICAgICAgICBtYWluUnVsZURlZmluaXRpb25zID0gKG1haW5SdWxlICE9PSBudWxsKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdFJlbWFpbmluZ1J1bGVzLCByZW1haW5pbmdSdWxlcyk7XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zLCBtYWluUnVsZURlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgY29uc3QgbWFpblJ1bGUgPSBkZWZhdWx0TWFpblJ1bGUsIC8vL1xuICAgICAgICByZW1haW5pbmdSdWxlcyA9IGRlZmF1bHRSZW1haW5pbmdSdWxlczsgLy8vXG5cbiAgY29uc3QgcnVsZXMgPSBbXS5jb25jYXQobWFpblJ1bGUpLmNvbmNhdChyZW1haW5pbmdSdWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21CTkYoYm5mKSB7XG4gIGNvbnN0IGJhc2ljUGFyc2VyID0gQmFzaWNQYXJzZXIuZnJvbUJORihibmYpLFxuICAgICAgICBydWxlcyA9IGJhc2ljUGFyc2VyLmdldFJ1bGVzKCk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBtYWluUnVsZUZyb21SdWxlc0FuZFJ1bGVOYW1lKHJ1bGVzLCBydWxlTmFtZSkge1xuICBjb25zdCBuYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgcmV0dXJuIG1haW5SdWxlO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSkge1xuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IHJ1bGVzLmZpbHRlcihmdW5jdGlvbihydWxlKSB7XG4gICAgaWYgKHJ1bGUgIT09IG1haW5SdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cbiJdfQ==