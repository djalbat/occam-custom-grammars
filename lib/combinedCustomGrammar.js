'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var lexers = require('occam-lexers'),
    parsers = require('occam-parsers'),
    necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities');

var rulesUtilities = require('./utilities/rules'),
    ruleNameUtilities = require('./utilities/ruleName'),
    customGrammarsUtilities = require('./utilities/customGrammars');

var rulesFromBNF = rulesUtilities.rulesFromBNF,
    arrayUtilities = necessary.arrayUtilities,
    unshift = arrayUtilities.unshift,
    findRuleByRuleName = ruleNameUtilities.findRuleByRuleName,
    defaultLexicalPattern = lexers.defaultLexicalPattern,
    eliminateImplicitLeftRecursion = grammarUtilities.eliminateImplicitLeftRecursion,
    lexicalPatternsFromCustomGrammars = customGrammarsUtilities.lexicalPatternsFromCustomGrammars,
    bnfsFromRuleNameAndCustomGrammars = customGrammarsUtilities.bnfsFromRuleNameAndCustomGrammars,
    termDefaultBNF = parsers.termDefaultBNF,
    statementDefaultBNF = parsers.statementDefaultBNF,
    expressionDefaultBNF = parsers.expressionDefaultBNF,
    metastatementDefaultBNF = parsers.metastatementDefaultBNF;

var CombinedCustomGrammar = function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var combinedLexicalPattern = combinedLexicalPatternFromCustomGrammars(customGrammars),
          combinedRules = combinedRulesFromCustomGrammars(customGrammars),
          lexicalPattern = combinedLexicalPattern,
          ///
      rules = combinedRules,
          ///
      combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);

      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

module.exports = CombinedCustomGrammar;

function combinedLexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars);

  lexicalPatterns.unshift(defaultLexicalPattern);

  var combinedLexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return combinedLexicalPattern;
}

function combinedRulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = 'metastatement',
      statementRuleName = 'statement',
      expressionRuleName = 'expression',
      termRuleName = 'term',
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars, metastatementDefaultBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars, statementDefaultBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars, expressionDefaultBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars, termDefaultBNF),
      combinedRules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);

  return combinedRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars, defaultBNF) {
  var bnfs = bnfsFromRuleNameAndCustomGrammars(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs);

  var rules = void 0;

  rules = [].concat(remainingRules).concat(mainRule);

  rules = eliminateImplicitLeftRecursion(rules);

  return rules;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });

  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);

    unshift(defaultRemainingRules, remainingRules);
  });

  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXIuanMiXSwibmFtZXMiOlsibGV4ZXJzIiwicmVxdWlyZSIsInBhcnNlcnMiLCJuZWNlc3NhcnkiLCJncmFtbWFyVXRpbGl0aWVzIiwicnVsZXNVdGlsaXRpZXMiLCJydWxlTmFtZVV0aWxpdGllcyIsImN1c3RvbUdyYW1tYXJzVXRpbGl0aWVzIiwicnVsZXNGcm9tQk5GIiwiYXJyYXlVdGlsaXRpZXMiLCJ1bnNoaWZ0IiwiZmluZFJ1bGVCeVJ1bGVOYW1lIiwiZGVmYXVsdExleGljYWxQYXR0ZXJuIiwiZWxpbWluYXRlSW1wbGljaXRMZWZ0UmVjdXJzaW9uIiwibGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzIiwiYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIiwidGVybURlZmF1bHRCTkYiLCJzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImNvbWJpbmVkTGV4aWNhbFBhdHRlcm4iLCJjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwiY29tYmluZWRSdWxlcyIsImNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJtb2R1bGUiLCJleHBvcnRzIiwibGV4aWNhbFBhdHRlcm5zIiwicmV2ZXJzZSIsImpvaW4iLCJtZXRhc3RhdGVtZW50UnVsZU5hbWUiLCJzdGF0ZW1lbnRSdWxlTmFtZSIsImV4cHJlc3Npb25SdWxlTmFtZSIsInRlcm1SdWxlTmFtZSIsIm1ldGFzdGF0ZW1lbnRSdWxlcyIsInJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GIiwic3RhdGVtZW50UnVsZXMiLCJleHByZXNzaW9uUnVsZXMiLCJ0ZXJtUnVsZXMiLCJjb25jYXQiLCJydWxlTmFtZSIsImRlZmF1bHRCTkYiLCJibmZzIiwibWFpblJ1bGUiLCJtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwicmVtYWluaW5nUnVsZXMiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZSIsImZpbHRlciIsInJ1bGUiLCJkZWZhdWx0UnVsZXMiLCJkZWZhdWx0TWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsImJuZiIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJkZWZhdWx0UmVtYWluaW5nUnVsZXMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxTQUFTQyxRQUFRLGNBQVIsQ0FBZjtBQUFBLElBQ01DLFVBQVVELFFBQVEsZUFBUixDQURoQjtBQUFBLElBRU1FLFlBQVlGLFFBQVEsV0FBUixDQUZsQjtBQUFBLElBR01HLG1CQUFtQkgsUUFBUSx5QkFBUixDQUh6Qjs7QUFLQSxJQUFNSSxpQkFBaUJKLFFBQVEsbUJBQVIsQ0FBdkI7QUFBQSxJQUNNSyxvQkFBb0JMLFFBQVEsc0JBQVIsQ0FEMUI7QUFBQSxJQUVNTSwwQkFBMEJOLFFBQVEsNEJBQVIsQ0FGaEM7O0FBSU0sSUFBRU8sWUFBRixHQUFtQkgsY0FBbkIsQ0FBRUcsWUFBRjtBQUFBLElBQ0VDLGNBREYsR0FDcUJOLFNBRHJCLENBQ0VNLGNBREY7QUFBQSxJQUVFQyxPQUZGLEdBRWNELGNBRmQsQ0FFRUMsT0FGRjtBQUFBLElBR0VDLGtCQUhGLEdBR3lCTCxpQkFIekIsQ0FHRUssa0JBSEY7QUFBQSxJQUlFQyxxQkFKRixHQUk0QlosTUFKNUIsQ0FJRVkscUJBSkY7QUFBQSxJQUtFQyw4QkFMRixHQUtxQ1QsZ0JBTHJDLENBS0VTLDhCQUxGO0FBQUEsSUFNRUMs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WUFBN0IsQ0FEeEI7QUFBQSxNQUVNTyx3QkFBd0JWLG1DQUFtQ0csWUFBbkMsRUFBaURDLGVBQWpELENBRjlCOztBQUlBVCxPQUFLWSxPQUFMLENBQWEsVUFBU0MsR0FBVCxFQUFjO0FBQ3pCLFFBQU1yQyxRQUFRZCxhQUFhbUQsR0FBYixDQUFkO0FBQUEsUUFDTVosV0FBV3BDLG1CQUFtQmlDLFFBQW5CLEVBQTZCdEIsS0FBN0IsQ0FEakI7QUFBQSxRQUVNMkIsaUJBQWlCRSxtQ0FBbUM3QixLQUFuQyxFQUEwQ3lCLFFBQTFDLENBRnZCOztBQUlBckMsWUFBUW1ELHFCQUFSLEVBQStCWixjQUEvQjtBQUNELEdBTkQ7O0FBUUEsTUFBTUEsaUJBQWlCWSxxQkFBdkIsQ0FiK0UsQ0FhakM7O0FBRTlDLFNBQU9aLGNBQVA7QUFDRCIsImZpbGUiOiJjb21iaW5lZEN1c3RvbUdyYW1tYXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGxleGVycyA9IHJlcXVpcmUoJ29jY2FtLWxleGVycycpLFxuICAgICAgcGFyc2VycyA9IHJlcXVpcmUoJ29jY2FtLXBhcnNlcnMnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpLFxuICAgICAgZ3JhbW1hclV0aWxpdGllcyA9IHJlcXVpcmUoJ29jY2FtLWdyYW1tYXItdXRpbGl0aWVzJyk7XG5cbmNvbnN0IHJ1bGVzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZXMnKSxcbiAgICAgIHJ1bGVOYW1lVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZU5hbWUnKSxcbiAgICAgIGN1c3RvbUdyYW1tYXJzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvY3VzdG9tR3JhbW1hcnMnKTtcblxuY29uc3QgeyBydWxlc0Zyb21CTkYgfSA9IHJ1bGVzVXRpbGl0aWVzLFxuICAgICAgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeVJ1bGVOYW1lIH0gPSBydWxlTmFtZVV0aWxpdGllcyxcbiAgICAgIHsgZGVmYXVsdExleGljYWxQYXR0ZXJuIH0gPSBsZXhlcnMsXG4gICAgICB7IGVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbiB9ID0gZ3JhbW1hclV0aWxpdGllcyxcbiAgICAgIHsgbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzLCBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMgfSA9IGN1c3RvbUdyYW1tYXJzVXRpbGl0aWVzLFxuICAgICAgeyB0ZXJtRGVmYXVsdEJORiwgc3RhdGVtZW50RGVmYXVsdEJORiwgZXhwcmVzc2lvbkRlZmF1bHRCTkYsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GIH0gPSBwYXJzZXJzO1xuXG5jbGFzcyBDb21iaW5lZEN1c3RvbUdyYW1tYXIge1xuICBjb25zdHJ1Y3RvcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlcyA9IHJ1bGVzO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFJ1bGVzKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4gPSBjb21iaW5lZExleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBjb21iaW5lZFJ1bGVzID0gY29tYmluZWRSdWxlc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgbGV4aWNhbFBhdHRlcm4gPSBjb21iaW5lZExleGljYWxQYXR0ZXJuLCAgLy8vXG4gICAgICAgICAgcnVsZXMgPSBjb21iaW5lZFJ1bGVzLCAgLy8vXG4gICAgICAgICAgY29tYmluZWRDdXN0b21HcmFtbWFyID0gbmV3IENvbWJpbmVkQ3VzdG9tR3JhbW1hcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpO1xuICAgIFxuICAgIHJldHVybiBjb21iaW5lZEN1c3RvbUdyYW1tYXI7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDb21iaW5lZEN1c3RvbUdyYW1tYXI7XG5cbmZ1bmN0aW9uIGNvbWJpbmVkTGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zID0gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKTtcblxuICBsZXhpY2FsUGF0dGVybnMudW5zaGlmdChkZWZhdWx0TGV4aWNhbFBhdHRlcm4pO1xuXG4gIGNvbnN0IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4gPSBsZXhpY2FsUGF0dGVybnMucmV2ZXJzZSgpLmpvaW4oJ3wnKTsgLy8vXG5cbiAgcmV0dXJuIGNvbWJpbmVkTGV4aWNhbFBhdHRlcm47XG59XG5cbmZ1bmN0aW9uIGNvbWJpbmVkUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVOYW1lID0gJ21ldGFzdGF0ZW1lbnQnLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlTmFtZSA9ICdzdGF0ZW1lbnQnLFxuICAgICAgICBleHByZXNzaW9uUnVsZU5hbWUgPSAnZXhwcmVzc2lvbicsXG4gICAgICAgIHRlcm1SdWxlTmFtZSA9ICd0ZXJtJyxcbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYobWV0YXN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgbWV0YXN0YXRlbWVudERlZmF1bHRCTkYpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgc3RhdGVtZW50RGVmYXVsdEJORiksXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIGV4cHJlc3Npb25EZWZhdWx0Qk5GKSxcbiAgICAgICAgdGVybVJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYodGVybVJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgdGVybURlZmF1bHRCTkYpLFxuICAgICAgICBjb21iaW5lZFJ1bGVzID0gW10uY29uY2F0KG1ldGFzdGF0ZW1lbnRSdWxlcykuY29uY2F0KHN0YXRlbWVudFJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQodGVybVJ1bGVzKTtcblxuICByZXR1cm4gY29tYmluZWRSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBkZWZhdWx0Qk5GKSB7XG4gIGNvbnN0IGJuZnMgPSBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgbWFpblJ1bGUgPSBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSxcbiAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKTtcblxuICBsZXQgcnVsZXM7XG5cbiAgcnVsZXMgPSBbXS5jb25jYXQocmVtYWluaW5nUnVsZXMpLmNvbmNhdChtYWluUnVsZSk7XG5cbiAgcnVsZXMgPSBlbGltaW5hdGVJbXBsaWNpdExlZnRSZWN1cnNpb24ocnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cblxuZnVuY3Rpb24gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpIHtcbiAgY29uc3QgcmVtYWluaW5nUnVsZXMgPSBydWxlcy5maWx0ZXIoZnVuY3Rpb24ocnVsZSkge1xuICAgIGlmIChydWxlICE9PSBtYWluUnVsZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIG1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zID0gZGVmYXVsdE1haW5SdWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgYm5mcy5mb3JFYWNoKGZ1bmN0aW9uKGJuZikge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICBtYWluUnVsZURlZmluaXRpb25zID0gKG1haW5SdWxlICE9PSBudWxsKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMsIG1haW5SdWxlRGVmaW5pdGlvbnMpO1xuICB9KTtcblxuICBjb25zdCBtYWluUnVsZSA9IGRlZmF1bHRNYWluUnVsZTsgLy8vXG5cbiAgcmV0dXJuIG1haW5SdWxlO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0UmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKGRlZmF1bHRSdWxlcywgZGVmYXVsdE1haW5SdWxlKTtcblxuICBibmZzLmZvckVhY2goZnVuY3Rpb24oYm5mKSB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0UmVtYWluaW5nUnVsZXMsIHJlbWFpbmluZ1J1bGVzKTtcbiAgfSk7XG5cbiAgY29uc3QgcmVtYWluaW5nUnVsZXMgPSBkZWZhdWx0UmVtYWluaW5nUnVsZXM7IC8vL1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cbiJdfQ==