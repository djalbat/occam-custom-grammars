"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _necessary = require("necessary");

var _occamGrammarUtilities = require("occam-grammar-utilities");

var _defaultCustomGrammar = _interopRequireDefault(require("./defaultCustomGrammar"));

var _rules = require("./utilities/rules");

var _ruleName = require("./utilities/ruleName");

var _customGrammars = require("./utilities/customGrammars");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    unshift = _necessary.arrayUtilities.unshift;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, ruleMap) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.ruleMap = ruleMap;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRuleMap",
    value: function getRuleMap() {
      return this.ruleMap;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          startRule = startRuleFromNothing(),
          ruleMap = ruleMapFromCustomGrammars(customGrammars);
      ruleMap[_constants.START_RULE_NAME] = startRule;
      (0, _occamGrammarUtilities.eliminateLeftRecursion)(startRule, ruleMap);
      delete ruleMap[_constants.START_RULE_NAME];
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, ruleMap);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

exports["default"] = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = (0, _customGrammars.lexicalPatternsFromCustomGrammars)(customGrammars),
      defaultCustomGrammarLexicalPattern = _defaultCustomGrammar["default"].getLexicalPattern(),
      defaultLexicalPattern = defaultCustomGrammarLexicalPattern; ///


  lexicalPatterns.unshift(defaultLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.reverse().join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function ruleMapFromCustomGrammars(customGrammars) {
  var metastatementRuleName = _constants.METASTATEMENT_RULE_NAME,
      ///
  statementRuleName = _constants.STATEMENT_RULE_NAME,
      ///
  expressionRuleName = _constants.EXPRESSION_RULE_NAME,
      ///
  termRuleName = _constants.TERM_RULE_NAME,
      ///
  metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules),
      ruleMap = rules.reduce(function (ruleMap, rule) {
    var ruleName = rule.getName();
    ruleMap[ruleName] = rule;
    return ruleMap;
  }, []);
  return ruleMap;
}

function startRuleFromNothing() {
  var startRulesBNF = " ".concat(_constants.START_RULE_NAME, " ::= ").concat(_constants.METASTATEMENT_RULE_NAME, " | ").concat(_constants.STATEMENT_RULE_NAME, " | ").concat(_constants.EXPRESSION_RULE_NAME, " | ").concat(_constants.TERM_RULE_NAME, " ; "),
      startRules = (0, _rules.rulesFromBNF)(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  return startRule;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars) {
  var bnfs = (0, _customGrammars.bnfsFromRuleNameAndCustomGrammars)(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwidW5zaGlmdCIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZU1hcCIsImN1c3RvbUdyYW1tYXJzIiwibGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMiLCJzdGFydFJ1bGUiLCJzdGFydFJ1bGVGcm9tTm90aGluZyIsInJ1bGVNYXBGcm9tQ3VzdG9tR3JhbW1hcnMiLCJTVEFSVF9SVUxFX05BTUUiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJsZXhpY2FsUGF0dGVybnMiLCJkZWZhdWx0Q3VzdG9tR3JhbW1hckxleGljYWxQYXR0ZXJuIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXIiLCJnZXRMZXhpY2FsUGF0dGVybiIsImRlZmF1bHRMZXhpY2FsUGF0dGVybiIsImxleGljYWxQYXR0ZXJuc1N0cmluZyIsInJldmVyc2UiLCJqb2luIiwibWV0YXN0YXRlbWVudFJ1bGVOYW1lIiwiTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUiLCJzdGF0ZW1lbnRSdWxlTmFtZSIsIlNUQVRFTUVOVF9SVUxFX05BTUUiLCJleHByZXNzaW9uUnVsZU5hbWUiLCJFWFBSRVNTSU9OX1JVTEVfTkFNRSIsInRlcm1SdWxlTmFtZSIsIlRFUk1fUlVMRV9OQU1FIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwicnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJzdGF0ZW1lbnRSdWxlcyIsImV4cHJlc3Npb25SdWxlcyIsInRlcm1SdWxlcyIsInJ1bGVzIiwiY29uY2F0IiwicmVkdWNlIiwicnVsZSIsInJ1bGVOYW1lIiwiZ2V0TmFtZSIsInN0YXJ0UnVsZXNCTkYiLCJzdGFydFJ1bGVzIiwiZmlyc3RTdGFydFJ1bGUiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlIiwibWFpblJ1bGUiLCJyZW1haW5pbmdSdWxlcyIsImZpbHRlciIsIm1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMiLCJibmZzIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJnZXRCTkYiLCJkZWZhdWx0Qk5GIiwiZGVmYXVsdFJ1bGVzIiwiZGVmYXVsdE1haW5SdWxlIiwiZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJibmYiLCJtYWluUnVsZURlZmluaXRpb25zIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsImRlZmF1bHRSZW1haW5pbmdSdWxlcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7OztJQUVRQSxLLEdBQW1CQyx5QixDQUFuQkQsSztJQUFPRSxPLEdBQVlELHlCLENBQVpDLE87O0lBRU1DLHFCO0FBQ25CLGlDQUFZQyxjQUFaLEVBQTRCQyxPQUE1QixFQUFxQztBQUFBOztBQUNuQyxTQUFLRCxjQUFMLEdBQXNCQSxjQUF0QjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjtBQUNEOzs7O3dDQUVtQjtBQUNsQixhQUFPLEtBQUtELGNBQVo7QUFDRDs7O2lDQUVZO0FBQ1gsYUFBTyxLQUFLQyxPQUFaO0FBQ0Q7Ozt1Q0FFeUJDLGMsRUFBZ0I7QUFDeEMsVUFBTUYsY0FBYyxHQUFHRyxnQ0FBZ0MsQ0FBQ0QsY0FBRCxDQUF2RDtBQUFBLFVBQ01FLFNBQVMsR0FBR0Msb0JBQW9CLEVBRHRDO0FBQUEsVUFFTUosT0FBTyxHQUFHSyx5QkFBeUIsQ0FBQ0osY0FBRCxDQUZ6QztBQUlBRCxNQUFBQSxPQUFPLENBQUNNLDBCQUFELENBQVAsR0FBMkJILFNBQTNCO0FBRUEseURBQXVCQSxTQUF2QixFQUFrQ0gsT0FBbEM7QUFFQSxhQUFPQSxPQUFPLENBQUNNLDBCQUFELENBQWQ7QUFFQSxVQUFNQyxxQkFBcUIsR0FBRyxJ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QUNDLEdBQUQsRUFBUztBQUNwQixRQUFNdkIsS0FBSyxHQUFHLHlCQUFhdUIsR0FBYixDQUFkO0FBQUEsUUFDTWIsUUFBUSxHQUFHLGtDQUFtQk4sUUFBbkIsRUFBNkJKLEtBQTdCLENBRGpCO0FBQUEsUUFFTVcsY0FBYyxHQUFHRixrQ0FBa0MsQ0FBQ1QsS0FBRCxFQUFRVSxRQUFSLENBRnpEO0FBSUExQyxJQUFBQSxPQUFPLENBQUMwRCxxQkFBRCxFQUF3QmYsY0FBeEIsQ0FBUDtBQUNELEdBTkQ7QUFRQSxNQUFNQSxjQUFjLEdBQUdlLHFCQUF2QixDQWZtRSxDQWVyQjs7QUFFOUMsU0FBT2YsY0FBUDtBQUNEOztBQUVELFNBQVNmLDRDQUFULENBQXNEUSxRQUF0RCxFQUFnRWhDLGNBQWhFLEVBQWdGO0FBQzlFLE1BQU0wQyxJQUFJLEdBQUcsdURBQWtDVixRQUFsQyxFQUE0Q2hDLGNBQTVDLENBQWI7QUFBQSxNQUNNc0MsUUFBUSxHQUFHRyxxQ0FBcUMsQ0FBQ1QsUUFBRCxFQUFXVSxJQUFYLENBRHREO0FBQUEsTUFFTUgsY0FBYyxHQUFHYywyQ0FBMkMsQ0FBQ3JCLFFBQUQsRUFBV1UsSUFBWCxDQUZsRTtBQUFBLE1BR01kLEtBQUssR0FBRyxHQUFHQyxNQUFILENBQVVTLFFBQVYsRUFBb0JULE1BQXBCLENBQTJCVSxjQUEzQixDQUhkO0FBS0EsU0FBT1gsS0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IGFycmF5VXRpbGl0aWVzIH0gZnJvbSBcIm5lY2Vzc2FyeVwiO1xuaW1wb3J0IHsgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9IGZyb20gXCJvY2NhbS1ncmFtbWFyLXV0aWxpdGllc1wiO1xuXG5pbXBvcnQgZGVmYXVsdEN1c3RvbUdyYW1tYXIgZnJvbSBcIi4vZGVmYXVsdEN1c3RvbUdyYW1tYXJcIjtcblxuaW1wb3J0IHsgcnVsZXNGcm9tQk5GIH0gZnJvbSBcIi4vdXRpbGl0aWVzL3J1bGVzXCI7XG5pbXBvcnQgeyBmaW5kUnVsZUJ5UnVsZU5hbWUgfSBmcm9tIFwiLi91dGlsaXRpZXMvcnVsZU5hbWVcIjtcbmltcG9ydCB7IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycywgYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIH0gZnJvbSBcIi4vdXRpbGl0aWVzL2N1c3RvbUdyYW1tYXJzXCI7XG5pbXBvcnQgeyBTVEFSVF9SVUxFX05BTUUsIFRFUk1fUlVMRV9OQU1FLCBFWFBSRVNTSU9OX1JVTEVfTkFNRSwgU1RBVEVNRU5UX1JVTEVfTkFNRSwgTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUgfSBmcm9tIFwiLi9jb25zdGFudHNcIjtcblxuY29uc3QgeyBmaXJzdCwgdW5zaGlmdCB9ID0gYXJyYXlVdGlsaXRpZXM7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbWJpbmVkQ3VzdG9tR3JhbW1hciB7XG4gIGNvbnN0cnVjdG9yKGxleGljYWxQYXR0ZXJuLCBydWxlTWFwKSB7XG4gICAgdGhpcy5sZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuO1xuICAgIHRoaXMucnVsZU1hcCA9IHJ1bGVNYXA7XG4gIH1cbiAgXG4gIGdldExleGljYWxQYXR0ZXJuKCkge1xuICAgIHJldHVybiB0aGlzLmxleGljYWxQYXR0ZXJuO1xuICB9XG5cbiAgZ2V0UnVsZU1hcCgpIHtcbiAgICByZXR1cm4gdGhpcy5ydWxlTWFwO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHN0YXJ0UnVsZSA9IHN0YXJ0UnVsZUZyb21Ob3RoaW5nKCksXG4gICAgICAgICAgcnVsZU1hcCA9IHJ1bGVNYXBGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gICAgcnVsZU1hcFtTVEFSVF9SVUxFX05BTUVdID0gc3RhcnRSdWxlO1xuXG4gICAgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihzdGFydFJ1bGUsIHJ1bGVNYXApO1xuXG4gICAgZGVsZXRlIHJ1bGVNYXBbU1RBUlRfUlVMRV9OQU1FXTtcblxuICAgIGNvbnN0IGNvbWJpbmVkQ3VzdG9tR3JhbW1hciA9IG5ldyBDb21iaW5lZEN1c3RvbUdyYW1tYXIobGV4aWNhbFBhdHRlcm4sIHJ1bGVNYXApO1xuICAgIFxuICAgIHJldHVybiBjb21iaW5lZEN1c3RvbUdyYW1tYXI7XG4gIH1cbn1cblxuZnVuY3Rpb24gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zID0gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgZGVmYXVsdEN1c3RvbUdyYW1tYXJMZXhpY2FsUGF0dGVybiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyLmdldExleGljYWxQYXR0ZXJuKCksXG4gICAgICAgIGRlZmF1bHRMZXhpY2FsUGF0dGVybiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyTGV4aWNhbFBhdHRlcm47IC8vL1xuXG4gIGxleGljYWxQYXR0ZXJucy51bnNoaWZ0KGRlZmF1bHRMZXhpY2FsUGF0dGVybik7XG5cbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zU3RyaW5nID0gbGV4aWNhbFBhdHRlcm5zLnJldmVyc2UoKS5qb2luKFwifFwiKSwgLy8vXG4gICAgICAgIGxleGljYWxQYXR0ZXJuID0gYF4oPzoke2xleGljYWxQYXR0ZXJuc1N0cmluZ30pYDtcblxuICByZXR1cm4gbGV4aWNhbFBhdHRlcm47XG59XG5cbmZ1bmN0aW9uIHJ1bGVNYXBGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVOYW1lID0gTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUsICAvLy9cbiAgICAgICAgc3RhdGVtZW50UnVsZU5hbWUgPSBTVEFURU1FTlRfUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIGV4cHJlc3Npb25SdWxlTmFtZSA9IEVYUFJFU1NJT05fUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIHRlcm1SdWxlTmFtZSA9IFRFUk1fUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIG1ldGFzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKG1ldGFzdGF0ZW1lbnRSdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICB0ZXJtUnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORih0ZXJtUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgcnVsZXMgPSBbXS5jb25jYXQobWV0YXN0YXRlbWVudFJ1bGVzKS5jb25jYXQoc3RhdGVtZW50UnVsZXMpLmNvbmNhdChleHByZXNzaW9uUnVsZXMpLmNvbmNhdCh0ZXJtUnVsZXMpLFxuICAgICAgICBydWxlTWFwID0gcnVsZXMucmVkdWNlKChydWxlTWFwLCBydWxlKSA9PiB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKTtcblxuICAgICAgICAgIHJ1bGVNYXBbcnVsZU5hbWVdID0gcnVsZTtcblxuICAgICAgICAgIHJldHVybiBydWxlTWFwO1xuICAgICAgICB9LCBbXSk7XG5cbiAgcmV0dXJuIHJ1bGVNYXA7XG59XG5cbmZ1bmN0aW9uIHN0YXJ0UnVsZUZyb21Ob3RoaW5nKCkge1xuICBjb25zdCBzdGFydFJ1bGVzQk5GID0gYCAke1NUQVJUX1JVTEVfTkFNRX0gOjo9ICR7TUVUQVNUQVRFTUVOVF9SVUxFX05BTUV9IHwgJHtTVEFURU1FTlRfUlVMRV9OQU1FfSB8ICR7RVhQUkVTU0lPTl9SVUxFX05BTUV9IHwgJHtURVJNX1JVTEVfTkFNRX0gOyBgLFxuICAgICAgICBzdGFydFJ1bGVzID0gcnVsZXNGcm9tQk5GKHN0YXJ0UnVsZXNCTkYpLFxuICAgICAgICBmaXJzdFN0YXJ0UnVsZSA9IGZpcnN0KHN0YXJ0UnVsZXMpLFxuICAgICAgICBzdGFydFJ1bGUgPSBmaXJzdFN0YXJ0UnVsZTsgLy8vXG5cbiAgcmV0dXJuIHN0YXJ0UnVsZTtcbn1cblxuZnVuY3Rpb24gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpIHtcbiAgY29uc3QgcmVtYWluaW5nUnVsZXMgPSBydWxlcy5maWx0ZXIoKHJ1bGUpID0+IHtcbiAgICBpZiAocnVsZSAhPT0gbWFpblJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuXG5mdW5jdGlvbiBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRDdXN0b21HcmFtbWFyQk5GID0gZGVmYXVsdEN1c3RvbUdyYW1tYXIuZ2V0Qk5GKHJ1bGVOYW1lKSxcbiAgICAgICAgZGVmYXVsdEJORiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zID0gZGVmYXVsdE1haW5SdWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgYm5mcy5mb3JFYWNoKChibmYpID0+IHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgbWFpblJ1bGVEZWZpbml0aW9ucyA9IChtYWluUnVsZSAhPT0gbnVsbCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5SdWxlLmdldERlZmluaXRpb25zKCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW107XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zLCBtYWluUnVsZURlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgY29uc3QgbWFpblJ1bGUgPSBkZWZhdWx0TWFpblJ1bGU7IC8vL1xuXG4gIHJldHVybiBtYWluUnVsZTtcbn1cblxuZnVuY3Rpb24gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0Q3VzdG9tR3JhbW1hckJORiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyLmdldEJORihydWxlTmFtZSksXG4gICAgICAgIGRlZmF1bHRCTkYgPSBkZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgLy8vXG4gICAgICAgIGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0UmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKGRlZmF1bHRSdWxlcywgZGVmYXVsdE1haW5SdWxlKTtcblxuICBibmZzLmZvckVhY2goKGJuZikgPT4ge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdFJlbWFpbmluZ1J1bGVzLCByZW1haW5pbmdSdWxlcyk7XG4gIH0pO1xuXG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gZGVmYXVsdFJlbWFpbmluZ1J1bGVzOyAvLy9cblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBibmZzID0gYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgYm5mcyksXG4gICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgYm5mcyksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1haW5SdWxlKS5jb25jYXQocmVtYWluaW5nUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cbiJdfQ==