'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var lexers = require('occam-lexers'),
    parsers = require('occam-parsers'),
    necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities');

var rulesUtilities = require('./utilities/rules'),
    ruleNameUtilities = require('./utilities/ruleName'),
    customGrammarsUtilities = require('./utilities/customGrammars');

var rulesFromBNF = rulesUtilities.rulesFromBNF,
    arrayUtilities = necessary.arrayUtilities,
    findRuleByRuleName = ruleNameUtilities.findRuleByRuleName,
    defaultLexicalPattern = lexers.defaultLexicalPattern,
    eliminateLeftRecursion = grammarUtilities.eliminateLeftRecursion,
    first = arrayUtilities.first,
    filter = arrayUtilities.filter,
    unshift = arrayUtilities.unshift,
    lexicalPatternsFromCustomGrammars = customGrammarsUtilities.lexicalPatternsFromCustomGrammars,
    bnfsFromRuleNameAndCustomGrammars = customGrammarsUtilities.bnfsFromRuleNameAndCustomGrammars,
    termDefaultBNF = parsers.termDefaultBNF,
    statementDefaultBNF = parsers.statementDefaultBNF,
    expressionDefaultBNF = parsers.expressionDefaultBNF,
    metastatementDefaultBNF = parsers.metastatementDefaultBNF;

var CombinedCustomGrammar = function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          rules = rulesFromCustomGrammars(customGrammars);

      addStartRule(rules);

      eliminateLeftRecursion(rules);

      removeStartRule(rules);

      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);

      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

module.exports = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars);

  lexicalPatterns.unshift(defaultLexicalPattern);

  var lexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return lexicalPattern;
}

function rulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = 'metastatement',
      statementRuleName = 'statement',
      expressionRuleName = 'expression',
      termRuleName = 'term',
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars, metastatementDefaultBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars, statementDefaultBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars, expressionDefaultBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars, termDefaultBNF),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);

  return rules;
}

function addStartRule(rules) {
  var startRulesBNF = ' start ::= metastatement | statement | expression | term ; ',
      startRules = rulesFromBNF(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  rules.unshift(startRule);
}

function removeStartRule(rules) {
  var firstRule = first(rules),
      startRule = firstRule; ///

  filter(rules, function (rule) {
    if (rule !== startRule) {
      return true;
    }
  });
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });

  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);

    unshift(defaultRemainingRules, remainingRules);
  });

  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars, defaultBNF) {
  var bnfs = bnfsFromRuleNameAndCustomGrammars(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);

  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXIuanMiXSwibmFtZXMiOlsibGV4ZXJzIiwicmVxdWlyZSIsInBhcnNlcnMiLCJuZWNlc3NhcnkiLCJncmFtbWFyVXRpbGl0aWVzIiwicnVsZXNVdGlsaXRpZXMiLCJydWxlTmFtZVV0aWxpdGllcyIsImN1c3RvbUdyYW1tYXJzVXRpbGl0aWVzIiwicnVsZXNGcm9tQk5GIiwiYXJyYXlVdGlsaXRpZXMiLCJmaW5kUnVsZUJ5UnVsZU5hbWUiLCJkZWZhdWx0TGV4aWNhbFBhdHRlcm4iLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwiZmlyc3QiLCJmaWx0ZXIiLCJ1bnNoaWZ0IiwibGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzIiwiYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIiwidGVybURlZmF1bHRCTkYiLCJzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiZXhwcmVzc2lvbkRlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwicnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJhZGRTdGFydFJ1bGUiLCJyZW1vdmVTdGFydFJ1bGUiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJtb2R1bGUiLCJleHBvcnRzIiwibGV4aWNhbFBhdHRlcm5zIiwicmV2ZXJzZSIsImpvaW4iLCJtZXRhc3RhdGVtZW50UnVsZU5hbWUiLCJzdGF0ZW1lbnRSdWxlTmFtZSIsImV4cHJlc3Npb25SdWxlTmFtZSIsInRlcm1SdWxlTmFtZSIsIm1ldGFzdGF0ZW1lbnRSdWxlcyIsInJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GIiwic3RhdGVtZW50UnVsZXMiLCJleHByZXNzaW9uUnVsZXMiLCJ0ZXJtUnVsZXMiLCJjb25jYXQiLCJzdGFydFJ1bGVzQk5GIiwic3RhcnRSdWxlcyIsImZpcnN0U3RhcnRSdWxlIiwic3RhcnRSdWxlIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJtYWluUnVsZSIsInJlbWFpbmluZ1J1bGVzIiwibWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsInJ1bGVOYW1lIiwiZGVmYXVsdEJORiIsImJuZnMiLCJkZWZhdWx0UnVsZXMiLCJkZWZhdWx0TWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsImJuZiIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwiZGVmYXVsdFJlbWFpbmluZ1J1bGVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsU0FBU0MsUUFBUSxjQUFSLENBQWY7QUFBQSxJQUNNQyxVQUFVRCxRQUFRLGVBQVIsQ0FEaEI7QUFBQSxJQUVNRSxZQUFZRixRQUFRLFdBQVIsQ0FGbEI7QUFBQSxJQUdNRyxtQkFBbUJILFFBQVEseUJBQVIsQ0FIekI7O0FBS0EsSUFBTUksaUJBQWlCSixRQUFRLG1CQUFSLENBQXZCO0FBQUEsSUFDTUssb0JBQW9CTCxRQUFRLHNCQUFSLENBRDFCO0FBQUEsSUFFTU0sMEJBQTBCTixRQUFRLDRCQUFSLENBRmhDOztBQUlNLElBQUVPLFlBQUYsR0FBbUJILGNBQW5CLENBQUVHLFlBQUY7QUFBQSxJQUNFQyxjQURGLEdBQ3FCTixTQURyQixDQUNFTSxjQURGO0FBQUEsSUFFRUMsa0JBRkYsR0FFeUJKLGlCQUZ6QixDQUVFSSxrQkFGRjtBQUFBLElBR0VDLHFCQUhGLEdBRzRCWCxNQUg1QixDQUdFVyxxQkFIRjtBQUFBLElBSUVDLHNCQUpGLEdBSTZCUixnQkFKN0IsQ0FJRVEsc0JBSkY7QUFB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dXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbGV4ZXJzID0gcmVxdWlyZSgnb2NjYW0tbGV4ZXJzJyksXG4gICAgICBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5JyksXG4gICAgICBncmFtbWFyVXRpbGl0aWVzID0gcmVxdWlyZSgnb2NjYW0tZ3JhbW1hci11dGlsaXRpZXMnKTtcblxuY29uc3QgcnVsZXNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlcycpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgY3VzdG9tR3JhbW1hcnNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9jdXN0b21HcmFtbWFycycpO1xuXG5jb25zdCB7IHJ1bGVzRnJvbUJORiB9ID0gcnVsZXNVdGlsaXRpZXMsXG4gICAgICB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGZpbmRSdWxlQnlSdWxlTmFtZSB9ID0gcnVsZU5hbWVVdGlsaXRpZXMsXG4gICAgICB7IGRlZmF1bHRMZXhpY2FsUGF0dGVybiB9ID0gbGV4ZXJzLFxuICAgICAgeyBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIH0gPSBncmFtbWFyVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgZmlsdGVyLCB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzLCBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMgfSA9IGN1c3RvbUdyYW1tYXJzVXRpbGl0aWVzLFxuICAgICAgeyB0ZXJtRGVmYXVsdEJORiwgc3RhdGVtZW50RGVmYXVsdEJORiwgZXhwcmVzc2lvbkRlZmF1bHRCTkYsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GIH0gPSBwYXJzZXJzO1xuXG5jbGFzcyBDb21iaW5lZEN1c3RvbUdyYW1tYXIge1xuICBjb25zdHJ1Y3RvcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlcyA9IHJ1bGVzO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFJ1bGVzKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHJ1bGVzID0gcnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gICAgYWRkU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpO1xuXG4gICAgcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGNvbnN0IGNvbWJpbmVkQ3VzdG9tR3JhbW1hciA9IG5ldyBDb21iaW5lZEN1c3RvbUdyYW1tYXIobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKTtcbiAgICBcbiAgICByZXR1cm4gY29tYmluZWRDdXN0b21HcmFtbWFyO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29tYmluZWRDdXN0b21HcmFtbWFyO1xuXG5mdW5jdGlvbiBsZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gIGxleGljYWxQYXR0ZXJucy51bnNoaWZ0KGRlZmF1bHRMZXhpY2FsUGF0dGVybik7XG5cbiAgY29uc3QgbGV4aWNhbFBhdHRlcm4gPSBsZXhpY2FsUGF0dGVybnMucmV2ZXJzZSgpLmpvaW4oJ3wnKTsgLy8vXG5cbiAgcmV0dXJuIGxleGljYWxQYXR0ZXJuO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBtZXRhc3RhdGVtZW50UnVsZU5hbWUgPSAnbWV0YXN0YXRlbWVudCcsXG4gICAgICAgIHN0YXRlbWVudFJ1bGVOYW1lID0gJ3N0YXRlbWVudCcsXG4gICAgICAgIGV4cHJlc3Npb25SdWxlTmFtZSA9ICdleHByZXNzaW9uJyxcbiAgICAgICAgdGVybVJ1bGVOYW1lID0gJ3Rlcm0nLFxuICAgICAgICBtZXRhc3RhdGVtZW50UnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihtZXRhc3RhdGVtZW50UnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiksXG4gICAgICAgIHN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoc3RhdGVtZW50UnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBzdGF0ZW1lbnREZWZhdWx0Qk5GKSxcbiAgICAgICAgZXhwcmVzc2lvblJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoZXhwcmVzc2lvblJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZXhwcmVzc2lvbkRlZmF1bHRCTkYpLFxuICAgICAgICB0ZXJtUnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORih0ZXJtUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCB0ZXJtRGVmYXVsdEJORiksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1ldGFzdGF0ZW1lbnRSdWxlcykuY29uY2F0KHN0YXRlbWVudFJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQodGVybVJ1bGVzKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG5cbmZ1bmN0aW9uIGFkZFN0YXJ0UnVsZShydWxlcykge1xuICBjb25zdCBzdGFydFJ1bGVzQk5GID0gJyBzdGFydCA6Oj0gbWV0YXN0YXRlbWVudCB8IHN0YXRlbWVudCB8IGV4cHJlc3Npb24gfCB0ZXJtIDsgJyxcbiAgICAgICAgc3RhcnRSdWxlcyA9IHJ1bGVzRnJvbUJORihzdGFydFJ1bGVzQk5GKSxcbiAgICAgICAgZmlyc3RTdGFydFJ1bGUgPSBmaXJzdChzdGFydFJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RTdGFydFJ1bGU7IC8vL1xuXG4gIHJ1bGVzLnVuc2hpZnQoc3RhcnRSdWxlKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RSdWxlOyAgLy8vXG5cbiAgZmlsdGVyKHJ1bGVzLCAocnVsZSkgPT4ge1xuICAgIGlmIChydWxlICE9PSBzdGFydFJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSB7XG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gcnVsZXMuZmlsdGVyKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBpZiAocnVsZSAhPT0gbWFpblJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuXG5mdW5jdGlvbiBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyA9IGRlZmF1bHRNYWluUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgbWFpblJ1bGVEZWZpbml0aW9ucyA9IChtYWluUnVsZSAhPT0gbnVsbCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5SdWxlLmdldERlZmluaXRpb25zKCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW107XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zLCBtYWluUnVsZURlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgY29uc3QgbWFpblJ1bGUgPSBkZWZhdWx0TWFpblJ1bGU7IC8vL1xuXG4gIHJldHVybiBtYWluUnVsZTtcbn1cblxuZnVuY3Rpb24gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdFJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShkZWZhdWx0UnVsZXMsIGRlZmF1bHRNYWluUnVsZSk7XG5cbiAgYm5mcy5mb3JFYWNoKGZ1bmN0aW9uKGJuZikge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdFJlbWFpbmluZ1J1bGVzLCByZW1haW5pbmdSdWxlcyk7XG4gIH0pO1xuXG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gZGVmYXVsdFJlbWFpbmluZ1J1bGVzOyAvLy9cblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZGVmYXVsdEJORikge1xuICBjb25zdCBibmZzID0gYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1haW5SdWxlKS5jb25jYXQocmVtYWluaW5nUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cbiJdfQ==