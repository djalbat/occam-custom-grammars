"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _necessary = require("necessary");

var _occamGrammarUtilities = require("occam-grammar-utilities");

var _occamParsers = require("occam-parsers");

var _occamLexers = require("occam-lexers");

var _rules = require("./utilities/rules");

var _ruleName = require("./utilities/ruleName");

var _customGrammars = require("./utilities/customGrammars");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    filter = _necessary.arrayUtilities.filter,
    unshift = _necessary.arrayUtilities.unshift;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRules",
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          rules = rulesFromCustomGrammars(customGrammars);
      addStartRule(rules);
      (0, _occamGrammarUtilities.eliminateLeftRecursion)(rules);
      removeStartRule(rules);
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

exports["default"] = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = (0, _customGrammars.lexicalPatternsFromCustomGrammars)(customGrammars);
  lexicalPatterns.unshift(_occamLexers.defaultCustomGrammarLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.reverse().join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function rulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = "metastatement",
      statementRuleName = "statement",
      expressionRuleName = "expression",
      termRuleName = "term",
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars, _occamParsers.metastatementDefaultCustomGrammarBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars, _occamParsers.statementDefaultCustomGrammarBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars, _occamParsers.expressionDefaultCustomGrammarBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars, _occamParsers.termDefaultCustomGrammarBNF),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);
  return rules;
}

function addStartRule(rules) {
  var startRulesBNF = " start ::= metastatement | statement | expression | term ; ",
      startRules = (0, _rules.rulesFromBNF)(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  rules.unshift(startRule);
}

function removeStartRule(rules) {
  var firstRule = first(rules),
      startRule = firstRule; ///

  filter(rules, function (rule) {
    if (rule !== startRule) {
      return true;
    }
  });
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();
  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);
  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars, defaultBNF) {
  var bnfs = (0, _customGrammars.bnfsFromRuleNameAndCustomGrammars)(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwiZmlsdGVyIiwidW5zaGlmdCIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwicnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJhZGRTdGFydFJ1bGUiLCJyZW1vdmVTdGFydFJ1bGUiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJsZXhpY2FsUGF0dGVybnMiLCJkZWZhdWx0TGV4aWNhbFBhdHRlcm4iLCJsZXhpY2FsUGF0dGVybnNTdHJpbmciLCJyZXZlcnNlIiwiam9pbiIsIm1ldGFzdGF0ZW1lbnRSdWxlTmFtZSIsInN0YXRlbWVudFJ1bGVOYW1lIiwiZXhwcmVzc2lvblJ1bGVOYW1lIiwidGVybVJ1bGVOYW1lIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwicnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsInN0YXRlbWVudFJ1bGVzIiwic3RhdGVtZW50RGVmYXVsdEJORiIsImV4cHJlc3Npb25SdWxlcyIsImV4cHJlc3Npb25EZWZhdWx0Qk5GIiwidGVybVJ1bGVzIiwidGVybURlZmF1bHRCTkYiLCJjb25jYXQiLCJzdGFydFJ1bGVzQk5GIiwic3RhcnRSdWxlcyIsImZpcnN0U3RhcnRSdWxlIiwic3RhcnRSdWxlIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJtYWluUnVsZSIsInJlbWFpbmluZ1J1bGVzIiwibWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsInJ1bGVOYW1lIiwiZGVmYXVsdEJORiIsImJuZnMiLCJkZWZhdWx0UnVsZXMiLCJkZWZhdWx0TWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsImJuZiIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwiZGVmYXVsdFJlbWFpbmluZ1J1bGVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUlBOztBQUVBOztBQUNBOztBQUNBOzs7Ozs7OztJQUVRQSxLLEdBQTJCQyx5QixDQUEzQkQsSztJQUFPRSxNLEdBQW9CRCx5QixDQUFwQkMsTTtJQUFRQyxPLEdBQVlGLHlCLENBQVpFLE87O0lBRUZDLHFCO0FBQ25CLGlDQUFZQyxjQUFaLEVBQTRCQyxLQUE1QixFQUFtQztBQUFBOztBQUNqQyxTQUFLRCxjQUFMLEdBQXNCQSxjQUF0QjtBQUNBLFNBQUtDLEtBQUwsR0FBYUEsS0FBYjtBQUNEOzs7O3dDQUVtQjtBQUNsQixhQUFPLEtBQUtELGNBQVo7QUFDRDs7OytCQUVVO0FBQ1QsYUFBTyxLQUFLQyxLQUFaO0FBQ0Q7Ozt1Q0FFeUJDLGMsRUFBZ0I7QUFDeEMsVUFBTUYsY0FBYyxHQUFHRyxnQ0FBZ0MsQ0FBQ0QsY0FBRCxDQUF2RDtBQUFBLFVBQ01ELEtBQUssR0FBR0csdUJBQXVCLENBQUNGLGNBQUQsQ0FEckM7QUFHQUcsTUFBQUEsWUFBWSxDQUFDSixLQUFELENBQVo7QUFFQSx5REFBdUJBLEtBQXZCO0FBRUFLLE1BQUFBLGVBQWUsQ0FBQ0wsS0FBRCxDQUFmO0FBRUEsVUFBTU0scUJBQXFCLEdBQUcsSUFBSVIscUJBQUosQ0FBMEJDLGNBQTFCLEVBQTBDQyxLQUExQyxDQUE5QjtBQUVBLGFBQU9NLHFCQUFQO0FBQ0Q7Ozs7Ozs7O0FBR0gsU0FBU0osZ0NBQVQsQ0FBMENELGNBQTFDLEVBQTBEO0FBQ3hELE1BQU1NLGVBQWUsR0FBRyx1REFBa0NOLGNBQWxDLENBQXhCO0FBRUFNLEVBQUFBLGVBQWUsQ0FBQ1YsT0FBaEIs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Q0FBQ0MsUUFBRCxFQUFXQyxVQUFYLEVBQXVCQyxJQUF2QixDQUR0RDtBQUFBLE1BRU1KLGNBQWMsR0FBR1ksMkNBQTJDLENBQUNWLFFBQUQsRUFBV0MsVUFBWCxFQUF1QkMsSUFBdkIsQ0FGbEU7QUFBQSxNQUdNdEMsS0FBSyxHQUFHLEdBQUd5QixNQUFILENBQVVRLFFBQVYsRUFBb0JSLE1BQXBCLENBQTJCUyxjQUEzQixDQUhkO0FBS0EsU0FBT2xDLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyBhcnJheVV0aWxpdGllcyB9IGZyb20gXCJuZWNlc3NhcnlcIjtcbmltcG9ydCB7IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24gfSBmcm9tIFwib2NjYW0tZ3JhbW1hci11dGlsaXRpZXNcIjtcbmltcG9ydCB7IHRlcm1EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiBhcyB0ZXJtRGVmYXVsdEJORixcbiAgICAgICAgIHN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GIGFzIHN0YXRlbWVudERlZmF1bHRCTkYsXG4gICAgICAgICBleHByZXNzaW9uRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgYXMgZXhwcmVzc2lvbkRlZmF1bHRCTkYsXG4gICAgICAgICBtZXRhc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgYXMgbWV0YXN0YXRlbWVudERlZmF1bHRCTkYgfSBmcm9tIFwib2NjYW0tcGFyc2Vyc1wiO1xuaW1wb3J0IHsgZGVmYXVsdEN1c3RvbUdyYW1tYXJMZXhpY2FsUGF0dGVybiBhcyBkZWZhdWx0TGV4aWNhbFBhdHRlcm4gfSBmcm9tIFwib2NjYW0tbGV4ZXJzXCI7XG5cbmltcG9ydCB7IHJ1bGVzRnJvbUJORiB9IGZyb20gXCIuL3V0aWxpdGllcy9ydWxlc1wiO1xuaW1wb3J0IHsgZmluZFJ1bGVCeVJ1bGVOYW1lIH0gZnJvbSBcIi4vdXRpbGl0aWVzL3J1bGVOYW1lXCI7XG5pbXBvcnQgeyBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMsIGJuZnNGcm9tUnVsZU5hbWVBbmRDdXN0b21HcmFtbWFycyB9IGZyb20gXCIuL3V0aWxpdGllcy9jdXN0b21HcmFtbWFyc1wiO1xuXG5jb25zdCB7IGZpcnN0LCBmaWx0ZXIsIHVuc2hpZnQgfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21iaW5lZEN1c3RvbUdyYW1tYXIge1xuICBjb25zdHJ1Y3RvcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlcyA9IHJ1bGVzO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFJ1bGVzKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHJ1bGVzID0gcnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gICAgYWRkU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpO1xuXG4gICAgcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGNvbnN0IGNvbWJpbmVkQ3VzdG9tR3JhbW1hciA9IG5ldyBDb21iaW5lZEN1c3RvbUdyYW1tYXIobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKTtcbiAgICBcbiAgICByZXR1cm4gY29tYmluZWRDdXN0b21HcmFtbWFyO1xuICB9XG59XG5cbmZ1bmN0aW9uIGxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGxleGljYWxQYXR0ZXJucyA9IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyk7XG5cbiAgbGV4aWNhbFBhdHRlcm5zLnVuc2hpZnQoZGVmYXVsdExleGljYWxQYXR0ZXJuKTtcblxuICBjb25zdCBsZXhpY2FsUGF0dGVybnNTdHJpbmcgPSBsZXhpY2FsUGF0dGVybnMucmV2ZXJzZSgpLmpvaW4oXCJ8XCIpLCAvLy9cbiAgICAgICAgbGV4aWNhbFBhdHRlcm4gPSBgXig/OiR7bGV4aWNhbFBhdHRlcm5zU3RyaW5nfSlgO1xuXG4gIHJldHVybiBsZXhpY2FsUGF0dGVybjtcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVOYW1lID0gXCJtZXRhc3RhdGVtZW50XCIsXG4gICAgICAgIHN0YXRlbWVudFJ1bGVOYW1lID0gXCJzdGF0ZW1lbnRcIixcbiAgICAgICAgZXhwcmVzc2lvblJ1bGVOYW1lID0gXCJleHByZXNzaW9uXCIsXG4gICAgICAgIHRlcm1SdWxlTmFtZSA9IFwidGVybVwiLFxuICAgICAgICBtZXRhc3RhdGVtZW50UnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihtZXRhc3RhdGVtZW50UnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiksXG4gICAgICAgIHN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoc3RhdGVtZW50UnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBzdGF0ZW1lbnREZWZhdWx0Qk5GKSxcbiAgICAgICAgZXhwcmVzc2lvblJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoZXhwcmVzc2lvblJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZXhwcmVzc2lvbkRlZmF1bHRCTkYpLFxuICAgICAgICB0ZXJtUnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORih0ZXJtUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCB0ZXJtRGVmYXVsdEJORiksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1ldGFzdGF0ZW1lbnRSdWxlcykuY29uY2F0KHN0YXRlbWVudFJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQodGVybVJ1bGVzKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG5cbmZ1bmN0aW9uIGFkZFN0YXJ0UnVsZShydWxlcykge1xuICBjb25zdCBzdGFydFJ1bGVzQk5GID0gXCIgc3RhcnQgOjo9IG1ldGFzdGF0ZW1lbnQgfCBzdGF0ZW1lbnQgfCBleHByZXNzaW9uIHwgdGVybSA7IFwiLFxuICAgICAgICBzdGFydFJ1bGVzID0gcnVsZXNGcm9tQk5GKHN0YXJ0UnVsZXNCTkYpLFxuICAgICAgICBmaXJzdFN0YXJ0UnVsZSA9IGZpcnN0KHN0YXJ0UnVsZXMpLFxuICAgICAgICBzdGFydFJ1bGUgPSBmaXJzdFN0YXJ0UnVsZTsgLy8vXG5cbiAgcnVsZXMudW5zaGlmdChzdGFydFJ1bGUpO1xufVxuXG5mdW5jdGlvbiByZW1vdmVTdGFydFJ1bGUocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBzdGFydFJ1bGUgPSBmaXJzdFJ1bGU7ICAvLy9cblxuICBmaWx0ZXIocnVsZXMsIChydWxlKSA9PiB7XG4gICAgaWYgKHJ1bGUgIT09IHN0YXJ0UnVsZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpIHtcbiAgY29uc3QgcmVtYWluaW5nUnVsZXMgPSBydWxlcy5maWx0ZXIoKHJ1bGUpID0+IHtcbiAgICBpZiAocnVsZSAhPT0gbWFpblJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuXG5mdW5jdGlvbiBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyA9IGRlZmF1bHRNYWluUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGJuZnMuZm9yRWFjaCgoYm5mKSA9PiB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIG1haW5SdWxlRGVmaW5pdGlvbnMgPSAobWFpblJ1bGUgIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUnVsZS5nZXREZWZpbml0aW9ucygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucywgbWFpblJ1bGVEZWZpbml0aW9ucyk7XG4gIH0pO1xuXG4gIGNvbnN0IG1haW5SdWxlID0gZGVmYXVsdE1haW5SdWxlOyAvLy9cblxuICByZXR1cm4gbWFpblJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRSZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpO1xuXG4gIGJuZnMuZm9yRWFjaCgoYm5mKSA9PiB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0UmVtYWluaW5nUnVsZXMsIHJlbWFpbmluZ1J1bGVzKTtcbiAgfSk7XG5cbiAgY29uc3QgcmVtYWluaW5nUnVsZXMgPSBkZWZhdWx0UmVtYWluaW5nUnVsZXM7IC8vL1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBkZWZhdWx0Qk5GKSB7XG4gIGNvbnN0IGJuZnMgPSBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgbWFpblJ1bGUgPSBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSxcbiAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSxcbiAgICAgICAgcnVsZXMgPSBbXS5jb25jYXQobWFpblJ1bGUpLmNvbmNhdChyZW1haW5pbmdSdWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuIl19