"use strict";

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var lexers = require("occam-lexers"),
    parsers = require("occam-parsers"),
    necessary = require("necessary"),
    grammarUtilities = require("occam-grammar-utilities");

var rulesUtilities = require("./utilities/rules"),
    ruleNameUtilities = require("./utilities/ruleName"),
    customGrammarsUtilities = require("./utilities/customGrammars");

var rulesFromBNF = rulesUtilities.rulesFromBNF,
    arrayUtilities = necessary.arrayUtilities,
    findRuleByRuleName = ruleNameUtilities.findRuleByRuleName,
    defaultLexicalPattern = lexers.defaultLexicalPattern,
    eliminateLeftRecursion = grammarUtilities.eliminateLeftRecursion,
    first = arrayUtilities.first,
    filter = arrayUtilities.filter,
    unshift = arrayUtilities.unshift,
    lexicalPatternsFromCustomGrammars = customGrammarsUtilities.lexicalPatternsFromCustomGrammars,
    bnfsFromRuleNameAndCustomGrammars = customGrammarsUtilities.bnfsFromRuleNameAndCustomGrammars,
    termDefaultBNF = parsers.termDefaultBNF,
    statementDefaultBNF = parsers.statementDefaultBNF,
    expressionDefaultBNF = parsers.expressionDefaultBNF,
    metastatementDefaultBNF = parsers.metastatementDefaultBNF;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRules",
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          rules = rulesFromCustomGrammars(customGrammars);
      addStartRule(rules);
      eliminateLeftRecursion(rules);
      removeStartRule(rules);
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

module.exports = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars);
  lexicalPatterns.unshift(defaultLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.reverse().join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function rulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = "metastatement",
      statementRuleName = "statement",
      expressionRuleName = "expression",
      termRuleName = "term",
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars, metastatementDefaultBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars, statementDefaultBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars, expressionDefaultBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars, termDefaultBNF),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);
  return rules;
}

function addStartRule(rules) {
  var startRulesBNF = " start ::= metastatement | statement | expression | term ; ",
      startRules = rulesFromBNF(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  rules.unshift(startRule);
}

function removeStartRule(rules) {
  var firstRule = first(rules),
      startRule = firstRule; ///

  filter(rules, function (rule) {
    if (rule !== startRule) {
      return true;
    }
  });
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();
  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);
  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars, defaultBNF) {
  var bnfs = bnfsFromRuleNameAndCustomGrammars(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJsZXhlcnMiLCJyZXF1aXJlIiwicGFyc2VycyIsIm5lY2Vzc2FyeSIsImdyYW1tYXJVdGlsaXRpZXMiLCJydWxlc1V0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiY3VzdG9tR3JhbW1hcnNVdGlsaXRpZXMiLCJydWxlc0Zyb21CTkYiLCJhcnJheVV0aWxpdGllcyIsImZpbmRSdWxlQnlSdWxlTmFtZSIsImRlZmF1bHRMZXhpY2FsUGF0dGVybiIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJmaXJzdCIsImZpbHRlciIsInVuc2hpZnQiLCJsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMiLCJ0ZXJtRGVmYXVsdEJORiIsInN0YXRlbWVudERlZmF1bHRCTkYiLCJleHByZXNzaW9uRGVmYXVsdEJORiIsIm1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiQ29tYmluZWRDdXN0b21HcmFtbWFyIiwibGV4aWNhbFBhdHRlcm4iLCJydWxlcyIsImN1c3RvbUdyYW1tYXJzIiwibGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMiLCJydWxlc0Zyb21DdXN0b21HcmFtbWFycyIsImFkZFN0YXJ0UnVsZSIsInJlbW92ZVN0YXJ0UnVsZSIsImNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsIm1vZHVsZSIsImV4cG9ydHMiLCJsZXhpY2FsUGF0dGVybnMiLCJsZXhpY2FsUGF0dGVybnNTdHJpbmciLCJyZXZlcnNlIiwiam9pbiIsIm1ldGFzdGF0ZW1lbnRSdWxlTmFtZSIsInN0YXRlbWVudFJ1bGVOYW1lIiwiZXhwcmVzc2lvblJ1bGVOYW1lIiwidGVybVJ1bGVOYW1lIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwicnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJzdGF0ZW1lbnRSdWxlcyIsImV4cHJlc3Npb25SdWxlcyIsInRlcm1SdWxlcyIsImNvbmNhdCIsInN0YXJ0UnVsZXNCTkYiLCJzdGFydFJ1bGVzIiwiZmlyc3RTdGFydFJ1bGUiLCJzdGFydFJ1bGUiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZSIsIm1haW5SdWxlIiwicmVtYWluaW5nUnVsZXMiLCJtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwicnVsZU5hbWUiLCJkZWZhdWx0Qk5GIiwiYm5mcyIsImRlZmF1bHRSdWxlcyIsImRlZmF1bHRNYWluUnVsZSIsImRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwiYm5mIiwibWFpblJ1bGVEZWZpbml0aW9ucyIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMiLCJkZWZhdWx0UmVtYWluaW5nUnVsZXMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUVBLElBQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBdEI7QUFBQSxJQUNNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxlQUFELENBRHZCO0FBQUEsSUFFTUUsU0FBUyxHQUFHRixPQUFPLENBQUMsV0FBRCxDQUZ6QjtBQUFBLElBR01HLGdCQUFnQixHQUFHSCxPQUFPLENBQUMseUJBQUQsQ0FIaEM7O0FBS0EsSUFBTUksY0FBYyxHQUFHSixPQUFPLENBQUMsbUJBQUQsQ0FBOUI7QUFBQSxJQUNNSyxpQkFBaUIsR0FBR0wsT0FBTyxDQUFDLHNCQUFELENBRGpDO0FBQUEsSUFFTU0sdUJBQXVCLEdBQUdOLE9BQU8sQ0FBQyw0QkFBRCxDQUZ2Qzs7QUFJTSxJQUFFTyxZQUFGLEdBQW1CSCxjQUFuQixDQUFFRyxZQUFGO0FBQUEsSUFDRUMsY0FERixHQUNxQk4sU0FEckIsQ0FDRU0sY0FERjtBQUFBLElBRUVDLGtCQUZGLEdBRXlCSixpQkFGekIsQ0FFRUksa0JBRkY7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Q0FGekQ7QUFJQXZDLElBQUFBLE9BQU8sQ0FBQ3FELHFCQUFELEVBQXdCYixjQUF4QixDQUFQO0FBQ0QsR0FORDtBQVFBLE1BQU1BLGNBQWMsR0FBR2EscUJBQXZCLENBYitFLENBYWpDOztBQUU5QyxTQUFPYixjQUFQO0FBQ0Q7O0FBRUQsU0FBU2IsNENBQVQsQ0FBc0RlLFFBQXRELEVBQWdFaEMsY0FBaEUsRUFBZ0ZpQyxVQUFoRixFQUE0RjtBQUMxRixNQUFNQyxJQUFJLEdBQUcxQyxpQ0FBaUMsQ0FBQ3dDLFFBQUQsRUFBV2hDLGNBQVgsQ0FBOUM7QUFBQSxNQUNNNkIsUUFBUSxHQUFHRSxxQ0FBcUMsQ0FBQ0MsUUFBRCxFQUFXQyxVQUFYLEVBQXVCQyxJQUF2QixDQUR0RDtBQUFBLE1BRU1KLGNBQWMsR0FBR1ksMkNBQTJDLENBQUNWLFFBQUQsRUFBV0MsVUFBWCxFQUF1QkMsSUFBdkIsQ0FGbEU7QUFBQSxNQUdNbkMsS0FBSyxHQUFHLEdBQUdzQixNQUFILENBQVVRLFFBQVYsRUFBb0JSLE1BQXBCLENBQTJCUyxjQUEzQixDQUhkO0FBS0EsU0FBTy9CLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBsZXhlcnMgPSByZXF1aXJlKFwib2NjYW0tbGV4ZXJzXCIpLFxuICAgICAgcGFyc2VycyA9IHJlcXVpcmUoXCJvY2NhbS1wYXJzZXJzXCIpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZShcIm5lY2Vzc2FyeVwiKSxcbiAgICAgIGdyYW1tYXJVdGlsaXRpZXMgPSByZXF1aXJlKFwib2NjYW0tZ3JhbW1hci11dGlsaXRpZXNcIik7XG5cbmNvbnN0IHJ1bGVzVXRpbGl0aWVzID0gcmVxdWlyZShcIi4vdXRpbGl0aWVzL3J1bGVzXCIpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKFwiLi91dGlsaXRpZXMvcnVsZU5hbWVcIiksXG4gICAgICBjdXN0b21HcmFtbWFyc1V0aWxpdGllcyA9IHJlcXVpcmUoXCIuL3V0aWxpdGllcy9jdXN0b21HcmFtbWFyc1wiKTtcblxuY29uc3QgeyBydWxlc0Zyb21CTkYgfSA9IHJ1bGVzVXRpbGl0aWVzLFxuICAgICAgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBmaW5kUnVsZUJ5UnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzLFxuICAgICAgeyBkZWZhdWx0TGV4aWNhbFBhdHRlcm4gfSA9IGxleGVycyxcbiAgICAgIHsgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9ID0gZ3JhbW1hclV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGZpbHRlciwgdW5zaGlmdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycywgYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIH0gPSBjdXN0b21HcmFtbWFyc1V0aWxpdGllcyxcbiAgICAgIHsgdGVybURlZmF1bHRCTkYsIHN0YXRlbWVudERlZmF1bHRCTkYsIGV4cHJlc3Npb25EZWZhdWx0Qk5GLCBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiB9ID0gcGFyc2VycztcblxuY2xhc3MgQ29tYmluZWRDdXN0b21HcmFtbWFyIHtcbiAgY29uc3RydWN0b3IobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKSB7XG4gICAgdGhpcy5sZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuO1xuICAgIHRoaXMucnVsZXMgPSBydWxlcztcbiAgfVxuICBcbiAgZ2V0TGV4aWNhbFBhdHRlcm4oKSB7XG4gICAgcmV0dXJuIHRoaXMubGV4aWNhbFBhdHRlcm47XG4gIH1cblxuICBnZXRSdWxlcygpIHtcbiAgICByZXR1cm4gdGhpcy5ydWxlcztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgICBjb25zdCBsZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBydWxlcyA9IHJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKTtcblxuICAgIGFkZFN0YXJ0UnVsZShydWxlcyk7XG5cbiAgICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKTtcblxuICAgIHJlbW92ZVN0YXJ0UnVsZShydWxlcyk7XG5cbiAgICBjb25zdCBjb21iaW5lZEN1c3RvbUdyYW1tYXIgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFyKGxleGljYWxQYXR0ZXJuLCBydWxlcyk7XG4gICAgXG4gICAgcmV0dXJuIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcjtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvbWJpbmVkQ3VzdG9tR3JhbW1hcjtcblxuZnVuY3Rpb24gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zID0gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKTtcblxuICBsZXhpY2FsUGF0dGVybnMudW5zaGlmdChkZWZhdWx0TGV4aWNhbFBhdHRlcm4pO1xuXG4gIGNvbnN0IGxleGljYWxQYXR0ZXJuc1N0cmluZyA9IGxleGljYWxQYXR0ZXJucy5yZXZlcnNlKCkuam9pbihcInxcIiksIC8vL1xuICAgICAgICBsZXhpY2FsUGF0dGVybiA9IGBeKD86JHtsZXhpY2FsUGF0dGVybnNTdHJpbmd9KWA7XG5cbiAgcmV0dXJuIGxleGljYWxQYXR0ZXJuO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBtZXRhc3RhdGVtZW50UnVsZU5hbWUgPSBcIm1ldGFzdGF0ZW1lbnRcIixcbiAgICAgICAgc3RhdGVtZW50UnVsZU5hbWUgPSBcInN0YXRlbWVudFwiLFxuICAgICAgICBleHByZXNzaW9uUnVsZU5hbWUgPSBcImV4cHJlc3Npb25cIixcbiAgICAgICAgdGVybVJ1bGVOYW1lID0gXCJ0ZXJtXCIsXG4gICAgICAgIG1ldGFzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKG1ldGFzdGF0ZW1lbnRSdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GKSxcbiAgICAgICAgc3RhdGVtZW50UnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihzdGF0ZW1lbnRSdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIHN0YXRlbWVudERlZmF1bHRCTkYpLFxuICAgICAgICBleHByZXNzaW9uUnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihleHByZXNzaW9uUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBleHByZXNzaW9uRGVmYXVsdEJORiksXG4gICAgICAgIHRlcm1SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHRlcm1SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIHRlcm1EZWZhdWx0Qk5GKSxcbiAgICAgICAgcnVsZXMgPSBbXS5jb25jYXQobWV0YXN0YXRlbWVudFJ1bGVzKS5jb25jYXQoc3RhdGVtZW50UnVsZXMpLmNvbmNhdChleHByZXNzaW9uUnVsZXMpLmNvbmNhdCh0ZXJtUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cblxuZnVuY3Rpb24gYWRkU3RhcnRSdWxlKHJ1bGVzKSB7XG4gIGNvbnN0IHN0YXJ0UnVsZXNCTkYgPSBcIiBzdGFydCA6Oj0gbWV0YXN0YXRlbWVudCB8IHN0YXRlbWVudCB8IGV4cHJlc3Npb24gfCB0ZXJtIDsgXCIsXG4gICAgICAgIHN0YXJ0UnVsZXMgPSBydWxlc0Zyb21CTkYoc3RhcnRSdWxlc0JORiksXG4gICAgICAgIGZpcnN0U3RhcnRSdWxlID0gZmlyc3Qoc3RhcnRSdWxlcyksXG4gICAgICAgIHN0YXJ0UnVsZSA9IGZpcnN0U3RhcnRSdWxlOyAvLy9cblxuICBydWxlcy51bnNoaWZ0KHN0YXJ0UnVsZSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZVN0YXJ0UnVsZShydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHN0YXJ0UnVsZSA9IGZpcnN0UnVsZTsgIC8vL1xuXG4gIGZpbHRlcihydWxlcywgKHJ1bGUpID0+IHtcbiAgICBpZiAocnVsZSAhPT0gc3RhcnRSdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSkge1xuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IHJ1bGVzLmZpbHRlcihmdW5jdGlvbihydWxlKSB7XG4gICAgaWYgKHJ1bGUgIT09IG1haW5SdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMgPSBkZWZhdWx0TWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBibmZzLmZvckVhY2goZnVuY3Rpb24oYm5mKSB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIG1haW5SdWxlRGVmaW5pdGlvbnMgPSAobWFpblJ1bGUgIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUnVsZS5nZXREZWZpbml0aW9ucygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucywgbWFpblJ1bGVEZWZpbml0aW9ucyk7XG4gIH0pO1xuXG4gIGNvbnN0IG1haW5SdWxlID0gZGVmYXVsdE1haW5SdWxlOyAvLy9cblxuICByZXR1cm4gbWFpblJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRSZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSk7XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRSZW1haW5pbmdSdWxlcywgcmVtYWluaW5nUnVsZXMpO1xuICB9KTtcblxuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IGRlZmF1bHRSZW1haW5pbmdSdWxlczsgLy8vXG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihydWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIGRlZmF1bHRCTkYpIHtcbiAgY29uc3QgYm5mcyA9IGJuZnNGcm9tUnVsZU5hbWVBbmRDdXN0b21HcmFtbWFycyhydWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBtYWluUnVsZSA9IG1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpLFxuICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpLFxuICAgICAgICBydWxlcyA9IFtdLmNvbmNhdChtYWluUnVsZSkuY29uY2F0KHJlbWFpbmluZ1J1bGVzKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG4iXX0=