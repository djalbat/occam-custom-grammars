"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _necessary = require("necessary");

var _occamGrammarUtilities = require("occam-grammar-utilities");

var _defaultCustomGrammar = _interopRequireDefault(require("./defaultCustomGrammar"));

var _ruleName = require("./utilities/ruleName");

var _rules = require("./utilities/rules");

var _customGrammars = require("./utilities/customGrammars");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    unshift = _necessary.arrayUtilities.unshift;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, termRuleNames, ruleMap) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.termRuleNames = termRuleNames;
    this.ruleMap = ruleMap;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getTermRuleNames",
    value: function getTermRuleNames() {
      return this.termRuleNames;
    }
  }, {
    key: "getRuleMap",
    value: function getRuleMap() {
      return this.ruleMap;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var metastatementRules = metastatementRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          statementRules = statementRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          expressionRules = expressionRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          termRules = termRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules),
          startRule = startRuleFromNothing(),
          lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          termRuleNames = (0, _rules.ruleNamesFromRules)(termRules),
          ruleMap = (0, _rules.ruleMapFromRules)(rules);
      ruleMap[_constants.START_RULE_NAME] = startRule;
      (0, _occamGrammarUtilities.eliminateLeftRecursion)(startRule, ruleMap);
      delete ruleMap[_constants.START_RULE_NAME];
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, termRuleNames, ruleMap);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

exports["default"] = CombinedCustomGrammar;

function metastatementRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var metastatementRuleName = _constants.METASTATEMENT_RULE_NAME,
      ///
  metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars);
  return metastatementRules;
}

function statementRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var statementRuleName = _constants.STATEMENT_RULE_NAME,
      ///
  statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars);
  return statementRules;
}

function expressionRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var expressionRuleName = _constants.EXPRESSION_RULE_NAME,
      ///
  expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars);
  return expressionRules;
}

function termRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var termRuleName = _constants.TERM_RULE_NAME,
      ///
  termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars);
  return termRules;
}

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = (0, _customGrammars.lexicalPatternsFromCustomGrammars)(customGrammars),
      defaultCustomGrammarLexicalPattern = _defaultCustomGrammar["default"].getLexicalPattern(),
      defaultLexicalPattern = defaultCustomGrammarLexicalPattern; ///


  lexicalPatterns.reverse();
  lexicalPatterns.push(defaultLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function startRuleFromNothing() {
  var startRulesBNF = " ".concat(_constants.START_RULE_NAME, " ::= ").concat(_constants.METASTATEMENT_RULE_NAME, " | ").concat(_constants.STATEMENT_RULE_NAME, " | ").concat(_constants.EXPRESSION_RULE_NAME, " | ").concat(_constants.TERM_RULE_NAME, " ; "),
      startRules = (0, _rules.rulesFromBNF)(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  return startRule;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars) {
  var bnfs = (0, _customGrammars.bnfsFromRuleNameAndCustomGrammars)(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwidW5zaGlmdCIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwidGVybVJ1bGVOYW1lcyIsInJ1bGVNYXAiLCJjdXN0b21HcmFtbWFycyIsIm1ldGFzdGF0ZW1lbnRSdWxlcyIsIm1ldGFzdGF0ZW1lbnRSdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJzdGF0ZW1lbnRSdWxlcyIsInN0YXRlbWVudFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORiIsImV4cHJlc3Npb25SdWxlcyIsImV4cHJlc3Npb25SdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJ0ZXJtUnVsZXMiLCJ0ZXJtUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GIiwicnVsZXMiLCJjb25jYXQiLCJzdGFydFJ1bGUiLCJzdGFydFJ1bGVGcm9tTm90aGluZyIsImxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwiU1RBUlRfUlVMRV9OQU1FIiwiY29tYmluZWRDdXN0b21HcmFtbWFyIiwibWV0YXN0YXRlbWVudFJ1bGVOYW1lIiwiTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUiLCJydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORiIsInN0YXRlbWVudFJ1bGVOYW1lIiwiU1RBVEVNRU5UX1JVTEVfTkFNRSIsImV4cHJlc3Npb25SdWxlTmFtZSIsIkVYUFJFU1NJT05fUlVMRV9OQU1FIiwidGVybVJ1bGVOYW1lIiwiVEVSTV9SVUxFX05BTUUiLCJsZXhpY2FsUGF0dGVybnMiLCJkZWZhdWx0Q3VzdG9tR3JhbW1hckxleGljYWxQYXR0ZXJuIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXIiLCJnZXRMZXhpY2FsUGF0dGVybiIsImRlZmF1bHRMZXhpY2FsUGF0dGVybiIsInJldmVyc2UiLCJwdXNoIiwibGV4aWNhbFBhdHRlcm5zU3RyaW5nIiwiam9pbiIsInN0YXJ0UnVsZXNCTkYiLCJzdGFydFJ1bGVzIiwiZmlyc3RTdGFydFJ1bGUiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlIiwibWFpblJ1bGUiLCJyZW1haW5pbmdSdWxlcyIsImZpbHRlciIsInJ1bGUiLCJtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwicnVsZU5hbWUiLCJibmZzIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJnZXRCTkYiLCJkZWZhdWx0Qk5GIiwiZGVmYXVsdFJ1bGVzIiwiZGVmYXVsdE1haW5SdWxlIiwiZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJibmYiLCJtYWluUnVsZURlZmluaXRpb25zIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsImRlZmF1bHRSZW1haW5pbmdSdWxlcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7OztJQUVRQSxLLEdBQW1CQyx5QixDQUFuQkQsSztJQUFPRSxPLEdBQVlELHlCLENBQVpDLE87O0lBRU1DLHFCO0FBQ25CLGlDQUFZQyxjQUFaLEVBQTRCQyxhQUE1QixFQUEyQ0MsT0FBM0MsRUFBb0Q7QUFBQTs7QUFDbEQsU0FBS0YsY0FBTCxHQUFzQkEsY0FBdEI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCQSxhQUFyQjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjtBQUNEOzs7O3dDQUVtQjtBQUNsQixhQUFPLEtBQUtGLGNBQVo7QUFDRDs7O3VDQUVrQjtBQUNqQixhQUFPLEtBQUtDLGFBQVo7QUFDRDs7O2lDQUVZO0FBQ1gsYUFBTyxLQUFLQyxPQUFaO0FBQ0Q7Ozt1Q0FFeUJDLGMsRUFBZ0I7QUFDeEMsVUFBTUMsa0JBQWtC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LFFBQVEsR0FBR0kscUNBQXFDLENBQUNDLFFBQUQsRUFBV0MsSUFBWCxDQUR0RDtBQUFBLE1BRU1MLGNBQWMsR0FBR2dCLDJDQUEyQyxDQUFDWixRQUFELEVBQVdDLElBQVgsQ0FGbEU7QUFBQSxNQUdNbkMsS0FBSyxHQUFHLEdBQUdDLE1BQUgsQ0FBVTRCLFFBQVYsRUFBb0I1QixNQUFwQixDQUEyQjZCLGNBQTNCLENBSGQ7QUFLQSxTQUFPOUIsS0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IGFycmF5VXRpbGl0aWVzIH0gZnJvbSBcIm5lY2Vzc2FyeVwiO1xuaW1wb3J0IHsgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9IGZyb20gXCJvY2NhbS1ncmFtbWFyLXV0aWxpdGllc1wiO1xuXG5pbXBvcnQgZGVmYXVsdEN1c3RvbUdyYW1tYXIgZnJvbSBcIi4vZGVmYXVsdEN1c3RvbUdyYW1tYXJcIjtcblxuaW1wb3J0IHsgZmluZFJ1bGVCeVJ1bGVOYW1lIH0gZnJvbSBcIi4vdXRpbGl0aWVzL3J1bGVOYW1lXCI7XG5pbXBvcnQgeyBydWxlc0Zyb21CTkYsIHJ1bGVNYXBGcm9tUnVsZXMsIHJ1bGVOYW1lc0Zyb21SdWxlcyB9IGZyb20gXCIuL3V0aWxpdGllcy9ydWxlc1wiO1xuaW1wb3J0IHsgbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzLCBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMgfSBmcm9tIFwiLi91dGlsaXRpZXMvY3VzdG9tR3JhbW1hcnNcIjtcbmltcG9ydCB7IFNUQVJUX1JVTEVfTkFNRSwgVEVSTV9SVUxFX05BTUUsIEVYUFJFU1NJT05fUlVMRV9OQU1FLCBTVEFURU1FTlRfUlVMRV9OQU1FLCBNRVRBU1RBVEVNRU5UX1JVTEVfTkFNRSB9IGZyb20gXCIuL2NvbnN0YW50c1wiO1xuXG5jb25zdCB7IGZpcnN0LCB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tYmluZWRDdXN0b21HcmFtbWFyIHtcbiAgY29uc3RydWN0b3IobGV4aWNhbFBhdHRlcm4sIHRlcm1SdWxlTmFtZXMsIHJ1bGVNYXApIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy50ZXJtUnVsZU5hbWVzID0gdGVybVJ1bGVOYW1lcztcbiAgICB0aGlzLnJ1bGVNYXAgPSBydWxlTWFwO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFRlcm1SdWxlTmFtZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMudGVybVJ1bGVOYW1lcztcbiAgfVxuXG4gIGdldFJ1bGVNYXAoKSB7XG4gICAgcmV0dXJuIHRoaXMucnVsZU1hcDtcbiAgfVxuXG4gIHN0YXRpYyBmcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgICBjb25zdCBtZXRhc3RhdGVtZW50UnVsZXMgPSBtZXRhc3RhdGVtZW50UnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHN0YXRlbWVudFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgZXhwcmVzc2lvblJ1bGVzID0gZXhwcmVzc2lvblJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgdGVybVJ1bGVzID0gdGVybVJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgcnVsZXMgPSBbXS5jb25jYXQobWV0YXN0YXRlbWVudFJ1bGVzKS5jb25jYXQoc3RhdGVtZW50UnVsZXMpLmNvbmNhdChleHByZXNzaW9uUnVsZXMpLmNvbmNhdCh0ZXJtUnVsZXMpLFxuICAgICAgICAgIHN0YXJ0UnVsZSA9IHN0YXJ0UnVsZUZyb21Ob3RoaW5nKCksXG4gICAgICAgICAgbGV4aWNhbFBhdHRlcm4gPSBsZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgdGVybVJ1bGVOYW1lcyA9IHJ1bGVOYW1lc0Zyb21SdWxlcyh0ZXJtUnVsZXMpLFxuICAgICAgICAgIHJ1bGVNYXAgPSBydWxlTWFwRnJvbVJ1bGVzKHJ1bGVzKTtcblxuICAgIHJ1bGVNYXBbU1RBUlRfUlVMRV9OQU1FXSA9IHN0YXJ0UnVsZTtcblxuICAgIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24oc3RhcnRSdWxlLCBydWxlTWFwKTtcblxuICAgIGRlbGV0ZSBydWxlTWFwW1NUQVJUX1JVTEVfTkFNRV07XG5cbiAgICBjb25zdCBjb21iaW5lZEN1c3RvbUdyYW1tYXIgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFyKGxleGljYWxQYXR0ZXJuLCB0ZXJtUnVsZU5hbWVzLCBydWxlTWFwKTtcbiAgICBcbiAgICByZXR1cm4gY29tYmluZWRDdXN0b21HcmFtbWFyO1xuICB9XG59XG5cbmZ1bmN0aW9uIG1ldGFzdGF0ZW1lbnRSdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVOYW1lID0gTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUsICAvLy9cbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYobWV0YXN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyk7XG5cbiAgcmV0dXJuIG1ldGFzdGF0ZW1lbnRSdWxlcztcbn1cblxuZnVuY3Rpb24gc3RhdGVtZW50UnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IHN0YXRlbWVudFJ1bGVOYW1lID0gU1RBVEVNRU5UX1JVTEVfTkFNRSwgIC8vL1xuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyk7XG5cbiAgcmV0dXJuIHN0YXRlbWVudFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBleHByZXNzaW9uUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGV4cHJlc3Npb25SdWxlTmFtZSA9IEVYUFJFU1NJT05fUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpO1xuXG4gIHJldHVybiBleHByZXNzaW9uUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHRlcm1SdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgdGVybVJ1bGVOYW1lID0gVEVSTV9SVUxFX05BTUUsICAvLy9cbiAgICAgICAgdGVybVJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYodGVybVJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyk7XG5cbiAgcmV0dXJuIHRlcm1SdWxlcztcbn1cblxuZnVuY3Rpb24gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zID0gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgZGVmYXVsdEN1c3RvbUdyYW1tYXJMZXhpY2FsUGF0dGVybiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyLmdldExleGljYWxQYXR0ZXJuKCksXG4gICAgICAgIGRlZmF1bHRMZXhpY2FsUGF0dGVybiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyTGV4aWNhbFBhdHRlcm47IC8vL1xuXG4gIGxleGljYWxQYXR0ZXJucy5yZXZlcnNlKCk7XG5cbiAgbGV4aWNhbFBhdHRlcm5zLnB1c2goZGVmYXVsdExleGljYWxQYXR0ZXJuKTtcblxuICBjb25zdCBsZXhpY2FsUGF0dGVybnNTdHJpbmcgPSBsZXhpY2FsUGF0dGVybnMuam9pbihcInxcIiksIC8vL1xuICAgICAgICBsZXhpY2FsUGF0dGVybiA9IGBeKD86JHtsZXhpY2FsUGF0dGVybnNTdHJpbmd9KWA7XG5cbiAgcmV0dXJuIGxleGljYWxQYXR0ZXJuO1xufVxuXG5mdW5jdGlvbiBzdGFydFJ1bGVGcm9tTm90aGluZygpIHtcbiAgY29uc3Qgc3RhcnRSdWxlc0JORiA9IGAgJHtTVEFSVF9SVUxFX05BTUV9IDo6PSAke01FVEFTVEFURU1FTlRfUlVMRV9OQU1FfSB8ICR7U1RBVEVNRU5UX1JVTEVfTkFNRX0gfCAke0VYUFJFU1NJT05fUlVMRV9OQU1FfSB8ICR7VEVSTV9SVUxFX05BTUV9IDsgYCxcbiAgICAgICAgc3RhcnRSdWxlcyA9IHJ1bGVzRnJvbUJORihzdGFydFJ1bGVzQk5GKSxcbiAgICAgICAgZmlyc3RTdGFydFJ1bGUgPSBmaXJzdChzdGFydFJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RTdGFydFJ1bGU7IC8vL1xuXG4gIHJldHVybiBzdGFydFJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSB7XG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gcnVsZXMuZmlsdGVyKChydWxlKSA9PiB7XG4gICAgaWYgKHJ1bGUgIT09IG1haW5SdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0Q3VzdG9tR3JhbW1hckJORiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyLmdldEJORihydWxlTmFtZSksXG4gICAgICAgIGRlZmF1bHRCTkYgPSBkZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgLy8vXG4gICAgICAgIGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyA9IGRlZmF1bHRNYWluUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGJuZnMuZm9yRWFjaCgoYm5mKSA9PiB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIG1haW5SdWxlRGVmaW5pdGlvbnMgPSAobWFpblJ1bGUgIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUnVsZS5nZXREZWZpbml0aW9ucygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucywgbWFpblJ1bGVEZWZpbml0aW9ucyk7XG4gIH0pO1xuXG4gIGNvbnN0IG1haW5SdWxlID0gZGVmYXVsdE1haW5SdWxlOyAvLy9cblxuICByZXR1cm4gbWFpblJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgPSBkZWZhdWx0Q3VzdG9tR3JhbW1hci5nZXRCTkYocnVsZU5hbWUpLFxuICAgICAgICBkZWZhdWx0Qk5GID0gZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdFJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShkZWZhdWx0UnVsZXMsIGRlZmF1bHRNYWluUnVsZSk7XG5cbiAgYm5mcy5mb3JFYWNoKChibmYpID0+IHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSk7XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRSZW1haW5pbmdSdWxlcywgcmVtYWluaW5nUnVsZXMpO1xuICB9KTtcblxuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IGRlZmF1bHRSZW1haW5pbmdSdWxlczsgLy8vXG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihydWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgYm5mcyA9IGJuZnNGcm9tUnVsZU5hbWVBbmRDdXN0b21HcmFtbWFycyhydWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBtYWluUnVsZSA9IG1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGJuZnMpLFxuICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGJuZnMpLFxuICAgICAgICBydWxlcyA9IFtdLmNvbmNhdChtYWluUnVsZSkuY29uY2F0KHJlbWFpbmluZ1J1bGVzKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG4iXX0=