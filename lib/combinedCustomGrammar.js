"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _necessary = require("necessary");

var _occamLexers = require("occam-lexers");

var _occamGrammarUtilities = require("occam-grammar-utilities");

var _occamParsers = require("occam-parsers");

var _rules = require("./utilities/rules");

var _ruleName = require("./utilities/ruleName");

var _customGrammars = require("./utilities/customGrammars");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    filter = _necessary.arrayUtilities.filter,
    unshift = _necessary.arrayUtilities.unshift;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRules",
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          rules = rulesFromCustomGrammars(customGrammars);
      addStartRule(rules);
      (0, _occamGrammarUtilities.eliminateLeftRecursion)(rules);
      removeStartRule(rules);
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

exports["default"] = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = (0, _customGrammars.lexicalPatternsFromCustomGrammars)(customGrammars);
  lexicalPatterns.unshift(_occamLexers.defaultLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.reverse().join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function rulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = "metastatement",
      statementRuleName = "statement",
      expressionRuleName = "expression",
      termRuleName = "term",
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars, _occamParsers.metastatementDefaultBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars, _occamParsers.statementDefaultBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars, _occamParsers.expressionDefaultBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars, _occamParsers.termDefaultBNF),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);
  return rules;
}

function addStartRule(rules) {
  var startRulesBNF = " start ::= metastatement | statement | expression | term ; ",
      startRules = (0, _rules.rulesFromBNF)(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  rules.unshift(startRule);
}

function removeStartRule(rules) {
  var firstRule = first(rules),
      startRule = firstRule; ///

  filter(rules, function (rule) {
    if (rule !== startRule) {
      return true;
    }
  });
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();
  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);
  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars, defaultBNF) {
  var bnfs = (0, _customGrammars.bnfsFromRuleNameAndCustomGrammars)(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwiZmlsdGVyIiwidW5zaGlmdCIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwicnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJhZGRTdGFydFJ1bGUiLCJyZW1vdmVTdGFydFJ1bGUiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJsZXhpY2FsUGF0dGVybnMiLCJkZWZhdWx0TGV4aWNhbFBhdHRlcm4iLCJsZXhpY2FsUGF0dGVybnNTdHJpbmciLCJyZXZlcnNlIiwiam9pbiIsIm1ldGFzdGF0ZW1lbnRSdWxlTmFtZSIsInN0YXRlbWVudFJ1bGVOYW1lIiwiZXhwcmVzc2lvblJ1bGVOYW1lIiwidGVybVJ1bGVOYW1lIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwicnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEJORiIsInN0YXRlbWVudFJ1bGVzIiwic3RhdGVtZW50RGVmYXVsdEJORiIsImV4cHJlc3Npb25SdWxlcyIsImV4cHJlc3Npb25EZWZhdWx0Qk5GIiwidGVybVJ1bGVzIiwidGVybURlZmF1bHRCTkYiLCJjb25jYXQiLCJzdGFydFJ1bGVzQk5GIiwic3RhcnRSdWxlcyIsImZpcnN0U3RhcnRSdWxlIiwic3RhcnRSdWxlIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJtYWluUnVsZSIsInJlbWFpbmluZ1J1bGVzIiwibWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsInJ1bGVOYW1lIiwiZGVmYXVsdEJORiIsImJuZnMiLCJkZWZhdWx0UnVsZXMiLCJkZWZhdWx0TWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsImJuZiIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwiZGVmYXVsdFJlbWFpbmluZ1J1bGVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOzs7Ozs7OztJQUVRQSxLLEdBQTJCQyx5QixDQUEzQkQsSztJQUFPRSxNLEdBQW9CRCx5QixDQUFwQkMsTTtJQUFRQyxPLEdBQVlGLHlCLENBQVpFLE87O0lBRUZDLHFCO0FBQ25CLGlDQUFZQyxjQUFaLEVBQTRCQyxLQUE1QixFQUFtQztBQUFBOztBQUNqQyxTQUFLRCxjQUFMLEdBQXNCQSxjQUF0QjtBQUNBLFNBQUtDLEtBQUwsR0FBYUEsS0FBYjtBQUNEOzs7O3dDQUVtQjtBQUNsQixhQUFPLEtBQUtELGNBQVo7QUFDRDs7OytCQUVVO0FBQ1QsYUFBTyxLQUFLQyxLQUFaO0FBQ0Q7Ozt1Q0FFeUJDLGMsRUFBZ0I7QUFDeEMsVUFBTUYsY0FBYyxHQUFHRyxnQ0FBZ0MsQ0FBQ0QsY0FBRCxDQUF2RDtBQUFBLFVBQ01ELEtBQUssR0FBR0csdUJBQXVCLENBQUNGLGNBQUQsQ0FEckM7QUFHQUcsTUFBQUEsWUFBWSxDQUFDSixLQUFELENBQVo7QUFFQSx5REFBdUJBLEtBQXZCO0FBRUFLLE1BQUFBLGVBQWUsQ0FBQ0wsS0FBRCxDQUFmO0FBRUEsVUFBTU0scUJBQXFCLEdBQUcsSUFBSVIscUJBQUosQ0FBMEJDLGNBQTFCLEVBQTBDQyxLQUExQyxDQUE5QjtBQUVBLGFBQU9NLHFCQUFQO0FBQ0Q7Ozs7Ozs7O0FBR0gsU0FBU0osZ0NBQVQsQ0FBMENELGNBQTFDLEVBQTBEO0FBQ3hELE1BQU1NLGVBQWUsR0FBRyx1REFBa0NOLGNBQWxDLENBQXhCO0FBRUFNLEVBQUFBLGVBQWUsQ0FBQ1YsT0FBaEIs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Q0FBQ0MsUUFBRCxFQUFXQyxVQUFYLEVBQXVCQyxJQUF2QixDQUR0RDtBQUFBLE1BRU1KLGNBQWMsR0FBR1ksMkNBQTJDLENBQUNWLFFBQUQsRUFBV0MsVUFBWCxFQUF1QkMsSUFBdkIsQ0FGbEU7QUFBQSxNQUdNdEMsS0FBSyxHQUFHLEdBQUd5QixNQUFILENBQVVRLFFBQVYsRUFBb0JSLE1BQXBCLENBQTJCUyxjQUEzQixDQUhkO0FBS0EsU0FBT2xDLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyBhcnJheVV0aWxpdGllcyB9IGZyb20gXCJuZWNlc3NhcnlcIjtcbmltcG9ydCB7IGRlZmF1bHRMZXhpY2FsUGF0dGVybiB9IGZyb20gXCJvY2NhbS1sZXhlcnNcIjtcbmltcG9ydCB7IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24gfSBmcm9tIFwib2NjYW0tZ3JhbW1hci11dGlsaXRpZXNcIjtcbmltcG9ydCB7IHRlcm1EZWZhdWx0Qk5GLCBzdGF0ZW1lbnREZWZhdWx0Qk5GLCBleHByZXNzaW9uRGVmYXVsdEJORiwgbWV0YXN0YXRlbWVudERlZmF1bHRCTkYgfSBmcm9tIFwib2NjYW0tcGFyc2Vyc1wiO1xuXG5pbXBvcnQgeyBydWxlc0Zyb21CTkYgfSBmcm9tIFwiLi91dGlsaXRpZXMvcnVsZXNcIjtcbmltcG9ydCB7IGZpbmRSdWxlQnlSdWxlTmFtZSB9IGZyb20gXCIuL3V0aWxpdGllcy9ydWxlTmFtZVwiO1xuaW1wb3J0IHsgbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzLCBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMgfSBmcm9tIFwiLi91dGlsaXRpZXMvY3VzdG9tR3JhbW1hcnNcIjtcblxuY29uc3QgeyBmaXJzdCwgZmlsdGVyLCB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tYmluZWRDdXN0b21HcmFtbWFyIHtcbiAgY29uc3RydWN0b3IobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKSB7XG4gICAgdGhpcy5sZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuO1xuICAgIHRoaXMucnVsZXMgPSBydWxlcztcbiAgfVxuICBcbiAgZ2V0TGV4aWNhbFBhdHRlcm4oKSB7XG4gICAgcmV0dXJuIHRoaXMubGV4aWNhbFBhdHRlcm47XG4gIH1cblxuICBnZXRSdWxlcygpIHtcbiAgICByZXR1cm4gdGhpcy5ydWxlcztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgICBjb25zdCBsZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBydWxlcyA9IHJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKTtcblxuICAgIGFkZFN0YXJ0UnVsZShydWxlcyk7XG5cbiAgICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKTtcblxuICAgIHJlbW92ZVN0YXJ0UnVsZShydWxlcyk7XG5cbiAgICBjb25zdCBjb21iaW5lZEN1c3RvbUdyYW1tYXIgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFyKGxleGljYWxQYXR0ZXJuLCBydWxlcyk7XG4gICAgXG4gICAgcmV0dXJuIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcjtcbiAgfVxufVxuXG5mdW5jdGlvbiBsZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gIGxleGljYWxQYXR0ZXJucy51bnNoaWZ0KGRlZmF1bHRMZXhpY2FsUGF0dGVybik7XG5cbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zU3RyaW5nID0gbGV4aWNhbFBhdHRlcm5zLnJldmVyc2UoKS5qb2luKFwifFwiKSwgLy8vXG4gICAgICAgIGxleGljYWxQYXR0ZXJuID0gYF4oPzoke2xleGljYWxQYXR0ZXJuc1N0cmluZ30pYDtcblxuICByZXR1cm4gbGV4aWNhbFBhdHRlcm47XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IG1ldGFzdGF0ZW1lbnRSdWxlTmFtZSA9IFwibWV0YXN0YXRlbWVudFwiLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlTmFtZSA9IFwic3RhdGVtZW50XCIsXG4gICAgICAgIGV4cHJlc3Npb25SdWxlTmFtZSA9IFwiZXhwcmVzc2lvblwiLFxuICAgICAgICB0ZXJtUnVsZU5hbWUgPSBcInRlcm1cIixcbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYobWV0YXN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgbWV0YXN0YXRlbWVudERlZmF1bHRCTkYpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgc3RhdGVtZW50RGVmYXVsdEJORiksXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIGV4cHJlc3Npb25EZWZhdWx0Qk5GKSxcbiAgICAgICAgdGVybVJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYodGVybVJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgdGVybURlZmF1bHRCTkYpLFxuICAgICAgICBydWxlcyA9IFtdLmNvbmNhdChtZXRhc3RhdGVtZW50UnVsZXMpLmNvbmNhdChzdGF0ZW1lbnRSdWxlcykuY29uY2F0KGV4cHJlc3Npb25SdWxlcykuY29uY2F0KHRlcm1SdWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBhZGRTdGFydFJ1bGUocnVsZXMpIHtcbiAgY29uc3Qgc3RhcnRSdWxlc0JORiA9IFwiIHN0YXJ0IDo6PSBtZXRhc3RhdGVtZW50IHwgc3RhdGVtZW50IHwgZXhwcmVzc2lvbiB8IHRlcm0gOyBcIixcbiAgICAgICAgc3RhcnRSdWxlcyA9IHJ1bGVzRnJvbUJORihzdGFydFJ1bGVzQk5GKSxcbiAgICAgICAgZmlyc3RTdGFydFJ1bGUgPSBmaXJzdChzdGFydFJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RTdGFydFJ1bGU7IC8vL1xuXG4gIHJ1bGVzLnVuc2hpZnQoc3RhcnRSdWxlKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RSdWxlOyAgLy8vXG5cbiAgZmlsdGVyKHJ1bGVzLCAocnVsZSkgPT4ge1xuICAgIGlmIChydWxlICE9PSBzdGFydFJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSB7XG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gcnVsZXMuZmlsdGVyKChydWxlKSA9PiB7XG4gICAgaWYgKHJ1bGUgIT09IG1haW5SdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMgPSBkZWZhdWx0TWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBibmZzLmZvckVhY2goKGJuZikgPT4ge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICBtYWluUnVsZURlZmluaXRpb25zID0gKG1haW5SdWxlICE9PSBudWxsKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMsIG1haW5SdWxlRGVmaW5pdGlvbnMpO1xuICB9KTtcblxuICBjb25zdCBtYWluUnVsZSA9IGRlZmF1bHRNYWluUnVsZTsgLy8vXG5cbiAgcmV0dXJuIG1haW5SdWxlO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0UmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKGRlZmF1bHRSdWxlcywgZGVmYXVsdE1haW5SdWxlKTtcblxuICBibmZzLmZvckVhY2goKGJuZikgPT4ge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdFJlbWFpbmluZ1J1bGVzLCByZW1haW5pbmdSdWxlcyk7XG4gIH0pO1xuXG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gZGVmYXVsdFJlbWFpbmluZ1J1bGVzOyAvLy9cblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZGVmYXVsdEJORikge1xuICBjb25zdCBibmZzID0gYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1haW5SdWxlKS5jb25jYXQocmVtYWluaW5nUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cbiJdfQ==