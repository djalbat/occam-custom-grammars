"use strict";

var _necessary = require("necessary");

var _occamLexers = require("occam-lexers");

var _occamGrammarUtilities = require("occam-grammar-utilities");

var _occamParsers = require("occam-parsers");

var _rules = require("./utilities/rules");

var _ruleName = require("./utilities/ruleName");

var _customGrammars = require("./utilities/customGrammars");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    filter = _necessary.arrayUtilities.filter,
    unshift = _necessary.arrayUtilities.unshift;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRules",
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          rules = rulesFromCustomGrammars(customGrammars);
      addStartRule(rules);
      (0, _occamGrammarUtilities.eliminateLeftRecursion)(rules);
      removeStartRule(rules);
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

module.exports = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = (0, _customGrammars.lexicalPatternsFromCustomGrammars)(customGrammars);
  lexicalPatterns.unshift(_occamLexers.defaultLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.reverse().join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function rulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = "metastatement",
      statementRuleName = "statement",
      expressionRuleName = "expression",
      termRuleName = "term",
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars, _occamParsers.metastatementDefaultBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars, _occamParsers.statementDefaultBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars, _occamParsers.expressionDefaultBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars, _occamParsers.termDefaultBNF),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);
  return rules;
}

function addStartRule(rules) {
  var startRulesBNF = " start ::= metastatement | statement | expression | term ; ",
      startRules = (0, _rules.rulesFromBNF)(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  rules.unshift(startRule);
}

function removeStartRule(rules) {
  var firstRule = first(rules),
      startRule = firstRule; ///

  filter(rules, function (rule) {
    if (rule !== startRule) {
      return true;
    }
  });
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();
  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);
  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars, defaultBNF) {
  var bnfs = (0, _customGrammars.bnfsFromRuleNameAndCustomGrammars)(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwiZmlsdGVyIiwidW5zaGlmdCIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwicnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJhZGRTdGFydFJ1bGUiLCJyZW1vdmVTdGFydFJ1bGUiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJtb2R1bGUiLCJleHBvcnRzIiwibGV4aWNhbFBhdHRlcm5zIiwiZGVmYXVsdExleGljYWxQYXR0ZXJuIiwibGV4aWNhbFBhdHRlcm5zU3RyaW5nIiwicmV2ZXJzZSIsImpvaW4iLCJtZXRhc3RhdGVtZW50UnVsZU5hbWUiLCJzdGF0ZW1lbnRSdWxlTmFtZSIsImV4cHJlc3Npb25SdWxlTmFtZSIsInRlcm1SdWxlTmFtZSIsIm1ldGFzdGF0ZW1lbnRSdWxlcyIsInJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GIiwibWV0YXN0YXRlbWVudERlZmF1bHRCTkYiLCJzdGF0ZW1lbnRSdWxlcyIsInN0YXRlbWVudERlZmF1bHRCTkYiLCJleHByZXNzaW9uUnVsZXMiLCJleHByZXNzaW9uRGVmYXVsdEJORiIsInRlcm1SdWxlcyIsInRlcm1EZWZhdWx0Qk5GIiwiY29uY2F0Iiwic3RhcnRSdWxlc0JORiIsInN0YXJ0UnVsZXMiLCJmaXJzdFN0YXJ0UnVsZSIsInN0YXJ0UnVsZSIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlIiwibWFpblJ1bGUiLCJyZW1haW5pbmdSdWxlcyIsIm1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMiLCJydWxlTmFtZSIsImRlZmF1bHRCTkYiLCJibmZzIiwiZGVmYXVsdFJ1bGVzIiwiZGVmYXVsdE1haW5SdWxlIiwiZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJibmYiLCJtYWluUnVsZURlZmluaXRpb25zIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsImRlZmF1bHRSZW1haW5pbmdSdWxlcyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0lBRVFBLEssR0FBMkJDLHlCLENBQTNCRCxLO0lBQU9FLE0sR0FBb0JELHlCLENBQXBCQyxNO0lBQVFDLE8sR0FBWUYseUIsQ0FBWkUsTzs7SUFFakJDLHFCO0FBQ0osaUNBQVlDLGNBQVosRUFBNEJDLEtBQTVCLEVBQW1DO0FBQUE7O0FBQ2pDLFNBQUtELGNBQUwsR0FBc0JBLGNBQXRCO0FBQ0EsU0FBS0MsS0FBTCxHQUFhQSxLQUFiO0FBQ0Q7Ozs7d0NBRW1CO0FBQ2xCLGFBQU8sS0FBS0QsY0FBWjtBQUNEOzs7K0JBRVU7QUFDVCxhQUFPLEtBQUtDLEtBQVo7QUFDRDs7O3VDQUV5QkMsYyxFQUFnQjtBQUN4QyxVQUFNRixjQUFjLEdBQUdHLGdDQUFnQyxDQUFDRCxjQUFELENBQXZEO0FBQUEsVUFDTUQsS0FBSyxHQUFHRyx1QkFBdUIsQ0FBQ0YsY0FBRCxDQURyQztBQUdBRyxNQUFBQSxZQUFZLENBQUNKLEtBQUQsQ0FBWjtBQUVBLHlEQUF1QkEsS0FBdkI7QUFFQUssTUFBQUEsZUFBZSxDQUFDTCxLQUFELENBQWY7QUFFQSxVQUFNTSxxQkFBcUIsR0FBRyxJQUFJUixxQkFBSixDQUEwQkMsY0FBMUIsRUFBMENDLEtBQTFDLENBQTlCO0FBRUEsYUFBT00scUJBQVA7QUFDRDs7Ozs7O0FBR0hDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQlYscUJBQWpCOztBQUVBLFNBQVNJLGdDQUFULENBQTBDRCxjQUExQyxFQUEwRDtBQUN4RCxNQUFNUSxlQUFlLEdBQUcs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LEVBQTRDckMsY0FBNUMsQ0FBYjtBQUFBLE1BQ01rQyxRQUFRLEdBQUdFLHFDQUFxQyxDQUFDQyxRQUFELEVBQVdDLFVBQVgsRUFBdUJDLElBQXZCLENBRHREO0FBQUEsTUFFTUosY0FBYyxHQUFHWSwyQ0FBMkMsQ0FBQ1YsUUFBRCxFQUFXQyxVQUFYLEVBQXVCQyxJQUF2QixDQUZsRTtBQUFBLE1BR014QyxLQUFLLEdBQUcsR0FBRzJCLE1BQUgsQ0FBVVEsUUFBVixFQUFvQlIsTUFBcEIsQ0FBMkJTLGNBQTNCLENBSGQ7QUFLQSxTQUFPcEMsS0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IGFycmF5VXRpbGl0aWVzIH0gZnJvbSBcIm5lY2Vzc2FyeVwiO1xuaW1wb3J0IHsgZGVmYXVsdExleGljYWxQYXR0ZXJuIH0gZnJvbSBcIm9jY2FtLWxleGVyc1wiO1xuaW1wb3J0IHsgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9IGZyb20gXCJvY2NhbS1ncmFtbWFyLXV0aWxpdGllc1wiO1xuaW1wb3J0IHsgdGVybURlZmF1bHRCTkYsIHN0YXRlbWVudERlZmF1bHRCTkYsIGV4cHJlc3Npb25EZWZhdWx0Qk5GLCBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiB9IGZyb20gXCJvY2NhbS1wYXJzZXJzXCI7XG5cbmltcG9ydCB7IHJ1bGVzRnJvbUJORiB9IGZyb20gXCIuL3V0aWxpdGllcy9ydWxlc1wiO1xuaW1wb3J0IHsgZmluZFJ1bGVCeVJ1bGVOYW1lIH0gZnJvbSBcIi4vdXRpbGl0aWVzL3J1bGVOYW1lXCI7XG5pbXBvcnQgeyBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMsIGJuZnNGcm9tUnVsZU5hbWVBbmRDdXN0b21HcmFtbWFycyB9IGZyb20gXCIuL3V0aWxpdGllcy9jdXN0b21HcmFtbWFyc1wiO1xuXG5jb25zdCB7IGZpcnN0LCBmaWx0ZXIsIHVuc2hpZnQgfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5jbGFzcyBDb21iaW5lZEN1c3RvbUdyYW1tYXIge1xuICBjb25zdHJ1Y3RvcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlcyA9IHJ1bGVzO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFJ1bGVzKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHJ1bGVzID0gcnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gICAgYWRkU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpO1xuXG4gICAgcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGNvbnN0IGNvbWJpbmVkQ3VzdG9tR3JhbW1hciA9IG5ldyBDb21iaW5lZEN1c3RvbUdyYW1tYXIobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKTtcbiAgICBcbiAgICByZXR1cm4gY29tYmluZWRDdXN0b21HcmFtbWFyO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29tYmluZWRDdXN0b21HcmFtbWFyO1xuXG5mdW5jdGlvbiBsZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gIGxleGljYWxQYXR0ZXJucy51bnNoaWZ0KGRlZmF1bHRMZXhpY2FsUGF0dGVybik7XG5cbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zU3RyaW5nID0gbGV4aWNhbFBhdHRlcm5zLnJldmVyc2UoKS5qb2luKFwifFwiKSwgLy8vXG4gICAgICAgIGxleGljYWxQYXR0ZXJuID0gYF4oPzoke2xleGljYWxQYXR0ZXJuc1N0cmluZ30pYDtcblxuICByZXR1cm4gbGV4aWNhbFBhdHRlcm47XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IG1ldGFzdGF0ZW1lbnRSdWxlTmFtZSA9IFwibWV0YXN0YXRlbWVudFwiLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlTmFtZSA9IFwic3RhdGVtZW50XCIsXG4gICAgICAgIGV4cHJlc3Npb25SdWxlTmFtZSA9IFwiZXhwcmVzc2lvblwiLFxuICAgICAgICB0ZXJtUnVsZU5hbWUgPSBcInRlcm1cIixcbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYobWV0YXN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgbWV0YXN0YXRlbWVudERlZmF1bHRCTkYpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgc3RhdGVtZW50RGVmYXVsdEJORiksXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIGV4cHJlc3Npb25EZWZhdWx0Qk5GKSxcbiAgICAgICAgdGVybVJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYodGVybVJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgdGVybURlZmF1bHRCTkYpLFxuICAgICAgICBydWxlcyA9IFtdLmNvbmNhdChtZXRhc3RhdGVtZW50UnVsZXMpLmNvbmNhdChzdGF0ZW1lbnRSdWxlcykuY29uY2F0KGV4cHJlc3Npb25SdWxlcykuY29uY2F0KHRlcm1SdWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBhZGRTdGFydFJ1bGUocnVsZXMpIHtcbiAgY29uc3Qgc3RhcnRSdWxlc0JORiA9IFwiIHN0YXJ0IDo6PSBtZXRhc3RhdGVtZW50IHwgc3RhdGVtZW50IHwgZXhwcmVzc2lvbiB8IHRlcm0gOyBcIixcbiAgICAgICAgc3RhcnRSdWxlcyA9IHJ1bGVzRnJvbUJORihzdGFydFJ1bGVzQk5GKSxcbiAgICAgICAgZmlyc3RTdGFydFJ1bGUgPSBmaXJzdChzdGFydFJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RTdGFydFJ1bGU7IC8vL1xuXG4gIHJ1bGVzLnVuc2hpZnQoc3RhcnRSdWxlKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RSdWxlOyAgLy8vXG5cbiAgZmlsdGVyKHJ1bGVzLCAocnVsZSkgPT4ge1xuICAgIGlmIChydWxlICE9PSBzdGFydFJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSB7XG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gcnVsZXMuZmlsdGVyKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBpZiAocnVsZSAhPT0gbWFpblJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuXG5mdW5jdGlvbiBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyA9IGRlZmF1bHRNYWluUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgbWFpblJ1bGVEZWZpbml0aW9ucyA9IChtYWluUnVsZSAhPT0gbnVsbCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5SdWxlLmdldERlZmluaXRpb25zKCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW107XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zLCBtYWluUnVsZURlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgY29uc3QgbWFpblJ1bGUgPSBkZWZhdWx0TWFpblJ1bGU7IC8vL1xuXG4gIHJldHVybiBtYWluUnVsZTtcbn1cblxuZnVuY3Rpb24gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdFJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShkZWZhdWx0UnVsZXMsIGRlZmF1bHRNYWluUnVsZSk7XG5cbiAgYm5mcy5mb3JFYWNoKGZ1bmN0aW9uKGJuZikge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdFJlbWFpbmluZ1J1bGVzLCByZW1haW5pbmdSdWxlcyk7XG4gIH0pO1xuXG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gZGVmYXVsdFJlbWFpbmluZ1J1bGVzOyAvLy9cblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZGVmYXVsdEJORikge1xuICBjb25zdCBibmZzID0gYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1haW5SdWxlKS5jb25jYXQocmVtYWluaW5nUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cbiJdfQ==