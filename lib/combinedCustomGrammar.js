'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var parsers = require('occam-parsers'),
    ///
necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities'); ///

var rulesUtilities = require('./utilities/rules'),
    ruleNameUtilities = require('./utilities/ruleName'),
    customGrammarsUtilities = require('./utilities/customGrammars');

var rulesFromBNF = rulesUtilities.rulesFromBNF,
    arrayUtilities = necessary.arrayUtilities,
    unshift = arrayUtilities.unshift,
    findRuleByRuleName = ruleNameUtilities.findRuleByRuleName,
    eliminateImplicitLeftRecursion = grammarUtilities.eliminateImplicitLeftRecursion,
    lexicalPatternsFromCustomGrammars = customGrammarsUtilities.lexicalPatternsFromCustomGrammars,
    bnfsFromRuleNameAndCustomGrammars = customGrammarsUtilities.bnfsFromRuleNameAndCustomGrammars,
    termDefaultCustomGrammarBNF = parsers.termDefaultCustomGrammarBNF,
    statementDefaultCustomGrammarBNF = parsers.statementDefaultCustomGrammarBNF,
    expressionDefaultCustomGrammarBNF = parsers.expressionDefaultCustomGrammarBNF,
    metastatementDefaultCustomGrammarBNF = parsers.metastatementDefaultCustomGrammarBNF;

var CombinedCustomGrammar = function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: 'getLexicalPattern',
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: 'getRules',
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: 'fromCustomGrammars',
    value: function fromCustomGrammars(customGrammars) {
      var combinedLexicalPattern = combinedLexicalPatternFromCustomGrammars(customGrammars),
          combinedRules = combinedRulesFromCustomGrammars(customGrammars),
          lexicalPattern = combinedLexicalPattern,
          ///
      rules = combinedRules,
          ///
      combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);

      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

module.exports = CombinedCustomGrammar;

function combinedLexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars),
      combinedLexicalPattern = lexicalPatterns.reverse().join('|'); ///

  return combinedLexicalPattern;
}

function combinedRulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = 'metastatement',
      statementRuleName = 'statement',
      expressionRuleName = 'expression',
      termRuleName = 'term',
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(metastatementRuleName, customGrammars, metastatementDefaultCustomGrammarBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(statementRuleName, customGrammars, statementDefaultCustomGrammarBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(expressionRuleName, customGrammars, expressionDefaultCustomGrammarBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(termRuleName, customGrammars, termDefaultCustomGrammarBNF),
      combinedRules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);

  return combinedRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultCustomGrammarBNF(ruleName, customGrammars, defaultCustomGrammarBNF) {
  var defaultBNF = defaultCustomGrammarBNF,
      ///
  bnfs = bnfsFromRuleNameAndCustomGrammars(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs);

  var rules = void 0;

  rules = [].concat(mainRule).concat(remainingRules);

  rules = eliminateImplicitLeftRecursion(rules);

  return rules;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });

  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];

    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });

  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);

    unshift(defaultRemainingRules, remainingRules);
  });

  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9jb21iaW5lZEN1c3RvbUdyYW1tYXIuanMiXSwibmFtZXMiOlsicGFyc2VycyIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJncmFtbWFyVXRpbGl0aWVzIiwicnVsZXNVdGlsaXRpZXMiLCJydWxlTmFtZVV0aWxpdGllcyIsImN1c3RvbUdyYW1tYXJzVXRpbGl0aWVzIiwicnVsZXNGcm9tQk5GIiwiYXJyYXlVdGlsaXRpZXMiLCJ1bnNoaWZ0IiwiZmluZFJ1bGVCeVJ1bGVOYW1lIiwiZWxpbWluYXRlSW1wbGljaXRMZWZ0UmVjdXJzaW9uIiwibGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzIiwiYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIiwidGVybURlZmF1bHRDdXN0b21HcmFtbWFyQk5GIiwic3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJleHByZXNzaW9uRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJtZXRhc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJDb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJsZXhpY2FsUGF0dGVybiIsInJ1bGVzIiwiY3VzdG9tR3JhbW1hcnMiLCJjb21iaW5lZExleGljYWxQYXR0ZXJuIiwiY29tYmluZWRMZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyIsImNvbWJpbmVkUnVsZXMiLCJjb21iaW5lZFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzIiwiY29tYmluZWRDdXN0b21HcmFtbWFyIiwibW9kdWxlIiwiZXhwb3J0cyIsImxleGljYWxQYXR0ZXJucyIsInJldmVyc2UiLCJqb2luIiwibWV0YXN0YXRlbWVudFJ1bGVOYW1lIiwic3RhdGVtZW50UnVsZU5hbWUiLCJleHByZXNzaW9uUnVsZU5hbWUiLCJ0ZXJtUnVsZU5hbWUiLCJtZXRhc3RhdGVtZW50UnVsZXMiLCJydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJzdGF0ZW1lbnRSdWxlcyIsImV4cHJlc3Npb25SdWxlcyIsInRlcm1SdWxlcyIsImNvbmNhdCIsInJ1bGVOYW1lIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJkZWZhdWx0Qk5GIiwiYm5mcyIsIm1haW5SdWxlIiwibWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsInJlbWFpbmluZ1J1bGVzIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJmaWx0ZXIiLCJydWxlIiwiZGVmYXVsdFJ1bGVzIiwiZGVmYXVsdE1haW5SdWxlIiwiZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJibmYiLCJtYWluUnVsZURlZmluaXRpb25zIiwiZGVmYXVsdFJlbWFpbmluZ1J1bGVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxlQUFSLENBQWhCO0FBQUEsSUFBMEM7QUFDcENDLFlBQVlELFFBQVEsV0FBUixDQURsQjtBQUFBLElBRU1FLG1CQUFtQkYsUUFBUSx5QkFBUixDQUZ6QixDLENBRThEOztBQUU5RCxJQUFNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FBdkI7QUFBQSxJQUNNSSxvQkFBb0JKLFFBQVEsc0JBQVIsQ0FEMUI7QUFBQSxJQUVNSywwQkFBMEJMLFFBQVEsNEJBQVIsQ0FGaEM7O0FBSU0sSUFBRU0sWUFBRixHQUFtQkgsY0FBbkIsQ0FBRUcsWUFBRjtBQUFBLElBQ0VDLGNBREYsR0FDcUJOLFNBRHJCLENBQ0VNLGNBREY7QUFBQSxJQUVFQyxPQUZGLEdBRWNELGNBRmQsQ0FFRUMsT0FGRjtBQUFBLElBR0VDLGtCQUhGLEdBR3lCTCxpQkFIekIsQ0FHRUssa0JBSEY7QUFBQSxJQUlFQyw4QkFKRixHQUlxQ1IsZ0JBSnJDLENBSUVRLDhCQUpGO0FBQUEsSUFLRUMs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QTdCLENBRHhCO0FBQUEsTUFFTU8sd0JBQXdCVixtQ0FBbUNHLFlBQW5DLEVBQWlEQyxlQUFqRCxDQUY5Qjs7QUFJQVQsT0FBS1ksT0FBTCxDQUFhLFVBQVNDLEdBQVQsRUFBYztBQUN6QixRQUFNdEMsUUFBUWIsYUFBYW1ELEdBQWIsQ0FBZDtBQUFBLFFBQ01aLFdBQVdwQyxtQkFBbUJnQyxRQUFuQixFQUE2QnRCLEtBQTdCLENBRGpCO0FBQUEsUUFFTTRCLGlCQUFpQkUsbUNBQW1DOUIsS0FBbkMsRUFBMEMwQixRQUExQyxDQUZ2Qjs7QUFJQXJDLFlBQVFtRCxxQkFBUixFQUErQlosY0FBL0I7QUFDRCxHQU5EOztBQVFBLE1BQU1BLGlCQUFpQlkscUJBQXZCLENBYitFLENBYWpDOztBQUU5QyxTQUFPWixjQUFQO0FBQ0QiLCJmaWxlIjoiY29tYmluZWRDdXN0b21HcmFtbWFyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpLCAvLy9cbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpLFxuICAgICAgZ3JhbW1hclV0aWxpdGllcyA9IHJlcXVpcmUoJ29jY2FtLWdyYW1tYXItdXRpbGl0aWVzJyk7ICAvLy9cblxuY29uc3QgcnVsZXNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlcycpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgY3VzdG9tR3JhbW1hcnNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9jdXN0b21HcmFtbWFycycpO1xuXG5jb25zdCB7IHJ1bGVzRnJvbUJORiB9ID0gcnVsZXNVdGlsaXRpZXMsXG4gICAgICB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHVuc2hpZnQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZUJ5UnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzLFxuICAgICAgeyBlbGltaW5hdGVJbXBsaWNpdExlZnRSZWN1cnNpb24gfSA9IGdyYW1tYXJVdGlsaXRpZXMsXG4gICAgICB7IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycywgYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIH0gPSBjdXN0b21HcmFtbWFyc1V0aWxpdGllcyxcbiAgICAgIHsgdGVybURlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCBzdGF0ZW1lbnREZWZhdWx0Q3VzdG9tR3JhbW1hckJORiwgZXhwcmVzc2lvbkRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCBtZXRhc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgfSA9IHBhcnNlcnM7XG5cbmNsYXNzIENvbWJpbmVkQ3VzdG9tR3JhbW1hciB7XG4gIGNvbnN0cnVjdG9yKGxleGljYWxQYXR0ZXJuLCBydWxlcykge1xuICAgIHRoaXMubGV4aWNhbFBhdHRlcm4gPSBsZXhpY2FsUGF0dGVybjtcbiAgICB0aGlzLnJ1bGVzID0gcnVsZXM7XG4gIH1cbiAgXG4gIGdldExleGljYWxQYXR0ZXJuKCkge1xuICAgIHJldHVybiB0aGlzLmxleGljYWxQYXR0ZXJuO1xuICB9XG5cbiAgZ2V0UnVsZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMucnVsZXM7XG4gIH1cblxuICBzdGF0aWMgZnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gICAgY29uc3QgY29tYmluZWRMZXhpY2FsUGF0dGVybiA9IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIGNvbWJpbmVkUnVsZXMgPSBjb21iaW5lZFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBsZXhpY2FsUGF0dGVybiA9IGNvbWJpbmVkTGV4aWNhbFBhdHRlcm4sICAvLy9cbiAgICAgICAgICBydWxlcyA9IGNvbWJpbmVkUnVsZXMsICAvLy9cbiAgICAgICAgICBjb21iaW5lZEN1c3RvbUdyYW1tYXIgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFyKGxleGljYWxQYXR0ZXJuLCBydWxlcyk7XG4gICAgXG4gICAgcmV0dXJuIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcjtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvbWJpbmVkQ3VzdG9tR3JhbW1hcjtcblxuZnVuY3Rpb24gY29tYmluZWRMZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBjb21iaW5lZExleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5zLnJldmVyc2UoKS5qb2luKCd8Jyk7IC8vL1xuXG4gIHJldHVybiBjb21iaW5lZExleGljYWxQYXR0ZXJuO1xufVxuXG5mdW5jdGlvbiBjb21iaW5lZFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IG1ldGFzdGF0ZW1lbnRSdWxlTmFtZSA9ICdtZXRhc3RhdGVtZW50JyxcbiAgICAgICAgc3RhdGVtZW50UnVsZU5hbWUgPSAnc3RhdGVtZW50JyxcbiAgICAgICAgZXhwcmVzc2lvblJ1bGVOYW1lID0gJ2V4cHJlc3Npb24nLFxuICAgICAgICB0ZXJtUnVsZU5hbWUgPSAndGVybScsXG4gICAgICAgIG1ldGFzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Q3VzdG9tR3JhbW1hckJORihtZXRhc3RhdGVtZW50UnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBtZXRhc3RhdGVtZW50RGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Q3VzdG9tR3JhbW1hckJORihzdGF0ZW1lbnRSdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIHN0YXRlbWVudERlZmF1bHRDdXN0b21HcmFtbWFyQk5GKSxcbiAgICAgICAgZXhwcmVzc2lvblJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRDdXN0b21HcmFtbWFyQk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMsIGV4cHJlc3Npb25EZWZhdWx0Q3VzdG9tR3JhbW1hckJORiksXG4gICAgICAgIHRlcm1SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Q3VzdG9tR3JhbW1hckJORih0ZXJtUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCB0ZXJtRGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYpLFxuICAgICAgICBjb21iaW5lZFJ1bGVzID0gW10uY29uY2F0KG1ldGFzdGF0ZW1lbnRSdWxlcykuY29uY2F0KHN0YXRlbWVudFJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQodGVybVJ1bGVzKTtcblxuICByZXR1cm4gY29tYmluZWRSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRDdXN0b21HcmFtbWFyQk5GKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYpIHtcbiAgY29uc3QgZGVmYXVsdEJORiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgYm5mcyA9IGJuZnNGcm9tUnVsZU5hbWVBbmRDdXN0b21HcmFtbWFycyhydWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBtYWluUnVsZSA9IG1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpLFxuICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpO1xuXG4gIGxldCBydWxlcztcblxuICBydWxlcyA9IFtdLmNvbmNhdChtYWluUnVsZSkuY29uY2F0KHJlbWFpbmluZ1J1bGVzKTtcblxuICBydWxlcyA9IGVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbihydWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSkge1xuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IHJ1bGVzLmZpbHRlcihmdW5jdGlvbihydWxlKSB7XG4gICAgaWYgKHJ1bGUgIT09IG1haW5SdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMgPSBkZWZhdWx0TWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBibmZzLmZvckVhY2goZnVuY3Rpb24oYm5mKSB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIG1haW5SdWxlRGVmaW5pdGlvbnMgPSAobWFpblJ1bGUgIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUnVsZS5nZXREZWZpbml0aW9ucygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucywgbWFpblJ1bGVEZWZpbml0aW9ucyk7XG4gIH0pO1xuXG4gIGNvbnN0IG1haW5SdWxlID0gZGVmYXVsdE1haW5SdWxlOyAvLy9cblxuICByZXR1cm4gbWFpblJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGRlZmF1bHRCTkYsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRSZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSk7XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRSZW1haW5pbmdSdWxlcywgcmVtYWluaW5nUnVsZXMpO1xuICB9KTtcblxuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IGRlZmF1bHRSZW1haW5pbmdSdWxlczsgLy8vXG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuIl19