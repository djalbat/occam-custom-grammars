'use strict';

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var lexers = require('occam-lexers'),
    parsers = require('occam-parsers'),
    necessary = require('necessary'),
    grammarUtilities = require('occam-grammar-utilities');

var rulesUtilities = require('./utilities/rules'),
    ruleNameUtilities = require('./utilities/ruleName'),
    customGrammarsUtilities = require('./utilities/customGrammars');

var rulesFromBNF = rulesUtilities.rulesFromBNF,
    arrayUtilities = necessary.arrayUtilities,
    findRuleByRuleName = ruleNameUtilities.findRuleByRuleName,
    defaultLexicalPattern = lexers.defaultLexicalPattern,
    eliminateLeftRecursion = grammarUtilities.eliminateLeftRecursion,
    first = arrayUtilities.first,
    filter = arrayUtilities.filter,
    unshift = arrayUtilities.unshift,
    lexicalPatternsFromCustomGrammars = customGrammarsUtilities.lexicalPatternsFromCustomGrammars,
    bnfsFromRuleNameAndCustomGrammars = customGrammarsUtilities.bnfsFromRuleNameAndCustomGrammars,
    termDefaultBNF = parsers.termDefaultBNF,
    statementDefaultBNF = parsers.statementDefaultBNF,
    expressionDefaultBNF = parsers.expressionDefaultBNF,
    metastatementDefaultBNF = parsers.metastatementDefaultBNF;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRules",
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          rules = rulesFromCustomGrammars(customGrammars);
      addStartRule(rules);
      eliminateLeftRecursion(rules);
      removeStartRule(rules);
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

module.exports = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = lexicalPatternsFromCustomGrammars(customGrammars);
  lexicalPatterns.unshift(defaultLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.reverse().join('|'),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function rulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = 'metastatement',
      statementRuleName = 'statement',
      expressionRuleName = 'expression',
      termRuleName = 'term',
      metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars, metastatementDefaultBNF),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars, statementDefaultBNF),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars, expressionDefaultBNF),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars, termDefaultBNF),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);
  return rules;
}

function addStartRule(rules) {
  var startRulesBNF = ' start ::= metastatement | statement | expression | term ; ',
      startRules = rulesFromBNF(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  rules.unshift(startRule);
}

function removeStartRule(rules) {
  var firstRule = first(rules),
      startRule = firstRule; ///

  filter(rules, function (rule) {
    if (rule !== startRule) {
      return true;
    }
  });
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();
  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs) {
  var defaultRules = rulesFromBNF(defaultBNF),
      defaultMainRule = findRuleByRuleName(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);
  bnfs.forEach(function (bnf) {
    var rules = rulesFromBNF(bnf),
        mainRule = findRuleByRuleName(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars, defaultBNF) {
  var bnfs = bnfsFromRuleNameAndCustomGrammars(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, defaultBNF, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJsZXhlcnMiLCJyZXF1aXJlIiwicGFyc2VycyIsIm5lY2Vzc2FyeSIsImdyYW1tYXJVdGlsaXRpZXMiLCJydWxlc1V0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiY3VzdG9tR3JhbW1hcnNVdGlsaXRpZXMiLCJydWxlc0Zyb21CTkYiLCJhcnJheVV0aWxpdGllcyIsImZpbmRSdWxlQnlSdWxlTmFtZSIsImRlZmF1bHRMZXhpY2FsUGF0dGVybiIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJmaXJzdCIsImZpbHRlciIsInVuc2hpZnQiLCJsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMiLCJ0ZXJtRGVmYXVsdEJORiIsInN0YXRlbWVudERlZmF1bHRCTkYiLCJleHByZXNzaW9uRGVmYXVsdEJORiIsIm1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GIiwiQ29tYmluZWRDdXN0b21HcmFtbWFyIiwibGV4aWNhbFBhdHRlcm4iLCJydWxlcyIsImN1c3RvbUdyYW1tYXJzIiwibGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMiLCJydWxlc0Zyb21DdXN0b21HcmFtbWFycyIsImFkZFN0YXJ0UnVsZSIsInJlbW92ZVN0YXJ0UnVsZSIsImNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsIm1vZHVsZSIsImV4cG9ydHMiLCJsZXhpY2FsUGF0dGVybnMiLCJsZXhpY2FsUGF0dGVybnNTdHJpbmciLCJyZXZlcnNlIiwiam9pbiIsIm1ldGFzdGF0ZW1lbnRSdWxlTmFtZSIsInN0YXRlbWVudFJ1bGVOYW1lIiwiZXhwcmVzc2lvblJ1bGVOYW1lIiwidGVybVJ1bGVOYW1lIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwicnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJzdGF0ZW1lbnRSdWxlcyIsImV4cHJlc3Npb25SdWxlcyIsInRlcm1SdWxlcyIsImNvbmNhdCIsInN0YXJ0UnVsZXNCTkYiLCJzdGFydFJ1bGVzIiwiZmlyc3RTdGFydFJ1bGUiLCJzdGFydFJ1bGUiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZSIsIm1haW5SdWxlIiwicmVtYWluaW5nUnVsZXMiLCJtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwicnVsZU5hbWUiLCJkZWZhdWx0Qk5GIiwiYm5mcyIsImRlZmF1bHRSdWxlcyIsImRlZmF1bHRNYWluUnVsZSIsImRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwiYm5mIiwibWFpblJ1bGVEZWZpbml0aW9ucyIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMiLCJkZWZhdWx0UmVtYWluaW5nUnVsZXMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUVBLElBQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBdEI7QUFBQSxJQUNNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxlQUFELENBRHZCO0FBQUEsSUFFTUUsU0FBUyxHQUFHRixPQUFPLENBQUMsV0FBRCxDQUZ6QjtBQUFBLElBR01HLGdCQUFnQixHQUFHSCxPQUFPLENBQUMseUJBQUQsQ0FIaEM7O0FBS0EsSUFBTUksY0FBYyxHQUFHSixPQUFPLENBQUMsbUJBQUQsQ0FBOUI7QUFBQSxJQUNNSyxpQkFBaUIsR0FBR0wsT0FBTyxDQUFDLHNCQUFELENBRGpDO0FBQUEsSUFFTU0sdUJBQXVCLEdBQUdOLE9BQU8sQ0FBQyw0QkFBRCxDQUZ2Qzs7QUFJTSxJQUFFTyxZQUFGLEdBQW1CSCxjQUFuQixDQUFFRyxZQUFGO0FBQUEsSUFDRUMsY0FERixHQUNxQk4sU0FEckIsQ0FDRU0sY0FERjtBQUFBLElBRUVDLGtCQUZGLEdBRXlCSixpQkFGekIsQ0FFRUksa0JBRkY7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Q0FGekQ7QUFJQXZDLElBQUFBLE9BQU8sQ0FBQ3FELHFCQUFELEVBQXdCYixjQUF4QixDQUFQO0FBQ0QsR0FORDtBQVFBLE1BQU1BLGNBQWMsR0FBR2EscUJBQXZCLENBYitFLENBYWpDOztBQUU5QyxTQUFPYixjQUFQO0FBQ0Q7O0FBRUQsU0FBU2IsNENBQVQsQ0FBc0RlLFFBQXRELEVBQWdFaEMsY0FBaEUsRUFBZ0ZpQyxVQUFoRixFQUE0RjtBQUMxRixNQUFNQyxJQUFJLEdBQUcxQyxpQ0FBaUMsQ0FBQ3dDLFFBQUQsRUFBV2hDLGNBQVgsQ0FBOUM7QUFBQSxNQUNNNkIsUUFBUSxHQUFHRSxxQ0FBcUMsQ0FBQ0MsUUFBRCxFQUFXQyxVQUFYLEVBQXVCQyxJQUF2QixDQUR0RDtBQUFBLE1BRU1KLGNBQWMsR0FBR1ksMkNBQTJDLENBQUNWLFFBQUQsRUFBV0MsVUFBWCxFQUF1QkMsSUFBdkIsQ0FGbEU7QUFBQSxNQUdNbkMsS0FBSyxHQUFHLEdBQUdzQixNQUFILENBQVVRLFFBQVYsRUFBb0JSLE1BQXBCLENBQTJCUyxjQUEzQixDQUhkO0FBS0EsU0FBTy9CLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbGV4ZXJzID0gcmVxdWlyZSgnb2NjYW0tbGV4ZXJzJyksXG4gICAgICBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5JyksXG4gICAgICBncmFtbWFyVXRpbGl0aWVzID0gcmVxdWlyZSgnb2NjYW0tZ3JhbW1hci11dGlsaXRpZXMnKTtcblxuY29uc3QgcnVsZXNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlcycpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgY3VzdG9tR3JhbW1hcnNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9jdXN0b21HcmFtbWFycycpO1xuXG5jb25zdCB7IHJ1bGVzRnJvbUJORiB9ID0gcnVsZXNVdGlsaXRpZXMsXG4gICAgICB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGZpbmRSdWxlQnlSdWxlTmFtZSB9ID0gcnVsZU5hbWVVdGlsaXRpZXMsXG4gICAgICB7IGRlZmF1bHRMZXhpY2FsUGF0dGVybiB9ID0gbGV4ZXJzLFxuICAgICAgeyBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIH0gPSBncmFtbWFyVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgZmlsdGVyLCB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzLCBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMgfSA9IGN1c3RvbUdyYW1tYXJzVXRpbGl0aWVzLFxuICAgICAgeyB0ZXJtRGVmYXVsdEJORiwgc3RhdGVtZW50RGVmYXVsdEJORiwgZXhwcmVzc2lvbkRlZmF1bHRCTkYsIG1ldGFzdGF0ZW1lbnREZWZhdWx0Qk5GIH0gPSBwYXJzZXJzO1xuXG5jbGFzcyBDb21iaW5lZEN1c3RvbUdyYW1tYXIge1xuICBjb25zdHJ1Y3RvcihsZXhpY2FsUGF0dGVybiwgcnVsZXMpIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlcyA9IHJ1bGVzO1xuICB9XG4gIFxuICBnZXRMZXhpY2FsUGF0dGVybigpIHtcbiAgICByZXR1cm4gdGhpcy5sZXhpY2FsUGF0dGVybjtcbiAgfVxuXG4gIGdldFJ1bGVzKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVzO1xuICB9XG5cbiAgc3RhdGljIGZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICAgIGNvbnN0IGxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHJ1bGVzID0gcnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gICAgYWRkU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpO1xuXG4gICAgcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKTtcblxuICAgIGNvbnN0IGNvbWJpbmVkQ3VzdG9tR3JhbW1hciA9IG5ldyBDb21iaW5lZEN1c3RvbUdyYW1tYXIobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKTtcbiAgICBcbiAgICByZXR1cm4gY29tYmluZWRDdXN0b21HcmFtbWFyO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29tYmluZWRDdXN0b21HcmFtbWFyO1xuXG5mdW5jdGlvbiBsZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpO1xuXG4gIGxleGljYWxQYXR0ZXJucy51bnNoaWZ0KGRlZmF1bHRMZXhpY2FsUGF0dGVybik7XG5cbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zU3RyaW5nID0gbGV4aWNhbFBhdHRlcm5zLnJldmVyc2UoKS5qb2luKCd8JyksIC8vL1xuICAgICAgICBsZXhpY2FsUGF0dGVybiA9IGBeKD86JHtsZXhpY2FsUGF0dGVybnNTdHJpbmd9KWA7XG5cbiAgcmV0dXJuIGxleGljYWxQYXR0ZXJuO1xufVxuXG5mdW5jdGlvbiBydWxlc0Zyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBtZXRhc3RhdGVtZW50UnVsZU5hbWUgPSAnbWV0YXN0YXRlbWVudCcsXG4gICAgICAgIHN0YXRlbWVudFJ1bGVOYW1lID0gJ3N0YXRlbWVudCcsXG4gICAgICAgIGV4cHJlc3Npb25SdWxlTmFtZSA9ICdleHByZXNzaW9uJyxcbiAgICAgICAgdGVybVJ1bGVOYW1lID0gJ3Rlcm0nLFxuICAgICAgICBtZXRhc3RhdGVtZW50UnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihtZXRhc3RhdGVtZW50UnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBtZXRhc3RhdGVtZW50RGVmYXVsdEJORiksXG4gICAgICAgIHN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoc3RhdGVtZW50UnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCBzdGF0ZW1lbnREZWZhdWx0Qk5GKSxcbiAgICAgICAgZXhwcmVzc2lvblJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoZXhwcmVzc2lvblJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZXhwcmVzc2lvbkRlZmF1bHRCTkYpLFxuICAgICAgICB0ZXJtUnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORih0ZXJtUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzLCB0ZXJtRGVmYXVsdEJORiksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1ldGFzdGF0ZW1lbnRSdWxlcykuY29uY2F0KHN0YXRlbWVudFJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQodGVybVJ1bGVzKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG5cbmZ1bmN0aW9uIGFkZFN0YXJ0UnVsZShydWxlcykge1xuICBjb25zdCBzdGFydFJ1bGVzQk5GID0gJyBzdGFydCA6Oj0gbWV0YXN0YXRlbWVudCB8IHN0YXRlbWVudCB8IGV4cHJlc3Npb24gfCB0ZXJtIDsgJyxcbiAgICAgICAgc3RhcnRSdWxlcyA9IHJ1bGVzRnJvbUJORihzdGFydFJ1bGVzQk5GKSxcbiAgICAgICAgZmlyc3RTdGFydFJ1bGUgPSBmaXJzdChzdGFydFJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RTdGFydFJ1bGU7IC8vL1xuXG4gIHJ1bGVzLnVuc2hpZnQoc3RhcnRSdWxlKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlU3RhcnRSdWxlKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgc3RhcnRSdWxlID0gZmlyc3RSdWxlOyAgLy8vXG5cbiAgZmlsdGVyKHJ1bGVzLCAocnVsZSkgPT4ge1xuICAgIGlmIChydWxlICE9PSBzdGFydFJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKSB7XG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gcnVsZXMuZmlsdGVyKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBpZiAocnVsZSAhPT0gbWFpblJ1bGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlbWFpbmluZ1J1bGVzO1xufVxuXG5mdW5jdGlvbiBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBkZWZhdWx0Qk5GLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRSdWxlcyA9IHJ1bGVzRnJvbUJORihkZWZhdWx0Qk5GKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBkZWZhdWx0UnVsZXMpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyA9IGRlZmF1bHRNYWluUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGJuZnMuZm9yRWFjaChmdW5jdGlvbihibmYpIHtcbiAgICBjb25zdCBydWxlcyA9IHJ1bGVzRnJvbUJORihibmYpLFxuICAgICAgICAgIG1haW5SdWxlID0gZmluZFJ1bGVCeVJ1bGVOYW1lKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgbWFpblJ1bGVEZWZpbml0aW9ucyA9IChtYWluUnVsZSAhPT0gbnVsbCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5SdWxlLmdldERlZmluaXRpb25zKCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW107XG5cbiAgICB1bnNoaWZ0KGRlZmF1bHRNYWluUnVsZURlZmluaXRpb25zLCBtYWluUnVsZURlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgY29uc3QgbWFpblJ1bGUgPSBkZWZhdWx0TWFpblJ1bGU7IC8vL1xuXG4gIHJldHVybiBtYWluUnVsZTtcbn1cblxuZnVuY3Rpb24gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcykge1xuICBjb25zdCBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdFJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShkZWZhdWx0UnVsZXMsIGRlZmF1bHRNYWluUnVsZSk7XG5cbiAgYm5mcy5mb3JFYWNoKGZ1bmN0aW9uKGJuZikge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUocnVsZXMsIG1haW5SdWxlKTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdFJlbWFpbmluZ1J1bGVzLCByZW1haW5pbmdSdWxlcyk7XG4gIH0pO1xuXG4gIGNvbnN0IHJlbWFpbmluZ1J1bGVzID0gZGVmYXVsdFJlbWFpbmluZ1J1bGVzOyAvLy9cblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycywgZGVmYXVsdEJORikge1xuICBjb25zdCBibmZzID0gYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzKHJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIG1haW5SdWxlID0gbWFpblJ1bGVGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyhydWxlTmFtZSwgZGVmYXVsdEJORiwgYm5mcyksXG4gICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1haW5SdWxlKS5jb25jYXQocmVtYWluaW5nUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cbiJdfQ==