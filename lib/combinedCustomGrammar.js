"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _necessary = require("necessary");

var _occamGrammarUtilities = require("occam-grammar-utilities");

var _defaultCustomGrammar = _interopRequireDefault(require("./defaultCustomGrammar"));

var _ruleName = require("./utilities/ruleName");

var _rules = require("./utilities/rules");

var _customGrammars = require("./utilities/customGrammars");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    filter = _necessary.arrayUtilities.filter,
    unshift = _necessary.arrayUtilities.unshift;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, ruleMap) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.ruleMap = ruleMap;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRuleMap",
    value: function getRuleMap() {
      return this.ruleMap;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var metastatementRules = metastatementRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          statementRules = statementRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          expressionRules = expressionRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          termRules = termRulesFromCustomGrammarsAndDefaultBNF(customGrammars),
          rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules),
          startRule = startRuleFromNothing(),
          lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          ruleMap = (0, _rules.ruleMapFromRules)(rules);
      ruleMap[_constants.START_RULE_NAME] = startRule;
      (0, _occamGrammarUtilities.eliminateLeftRecursion)(startRule, ruleMap);
      delete ruleMap[_constants.START_RULE_NAME];
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, ruleMap);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

exports["default"] = CombinedCustomGrammar;

function metastatementRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var metastatementRuleName = _constants.METASTATEMENT_RULE_NAME,
      ///
  metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars);
  return metastatementRules;
}

function statementRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var statementRuleName = _constants.STATEMENT_RULE_NAME,
      ///
  statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars);
  return statementRules;
}

function expressionRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var expressionRuleName = _constants.EXPRESSION_RULE_NAME,
      ///
  expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars);
  return expressionRules;
}

function termRulesFromCustomGrammarsAndDefaultBNF(customGrammars) {
  var termRuleName = _constants.TERM_RULE_NAME,
      ///
  termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars);
  return termRules;
}

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = (0, _customGrammars.lexicalPatternsFromCustomGrammars)(customGrammars),
      defaultCustomGrammarLexicalPattern = _defaultCustomGrammar["default"].getLexicalPattern(),
      defaultLexicalPattern = defaultCustomGrammarLexicalPattern; ///


  lexicalPatterns.reverse();
  lexicalPatterns.push(defaultLexicalPattern);
  filter(lexicalPatterns, function (lexicalPattern) {
    if (lexicalPattern !== "") {
      return true;
    }
  });
  var lexicalPatternsString = lexicalPatterns.join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function startRuleFromNothing() {
  var startRulesBNF = " ".concat(_constants.START_RULE_NAME, " ::= ").concat(_constants.METASTATEMENT_RULE_NAME, " | ").concat(_constants.STATEMENT_RULE_NAME, " | ").concat(_constants.EXPRESSION_RULE_NAME, " | ").concat(_constants.TERM_RULE_NAME, " ; "),
      startRules = (0, _rules.rulesFromBNF)(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  return startRule;
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars) {
  var bnfs = (0, _customGrammars.bnfsFromRuleNameAndCustomGrammars)(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwiZmlsdGVyIiwidW5zaGlmdCIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZU1hcCIsImN1c3RvbUdyYW1tYXJzIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwibWV0YXN0YXRlbWVudFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORiIsInN0YXRlbWVudFJ1bGVzIiwic3RhdGVtZW50UnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GIiwiZXhwcmVzc2lvblJ1bGVzIiwiZXhwcmVzc2lvblJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORiIsInRlcm1SdWxlcyIsInRlcm1SdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJydWxlcyIsImNvbmNhdCIsInN0YXJ0UnVsZSIsInN0YXJ0UnVsZUZyb21Ob3RoaW5nIiwibGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMiLCJTVEFSVF9SVUxFX05BTUUiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJtZXRhc3RhdGVtZW50UnVsZU5hbWUiLCJNRVRBU1RBVEVNRU5UX1JVTEVfTkFNRSIsInJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GIiwic3RhdGVtZW50UnVsZU5hbWUiLCJTVEFURU1FTlRfUlVMRV9OQU1FIiwiZXhwcmVzc2lvblJ1bGVOYW1lIiwiRVhQUkVTU0lPTl9SVUxFX05BTUUiLCJ0ZXJtUnVsZU5hbWUiLCJURVJNX1JVTEVfTkFNRSIsImxleGljYWxQYXR0ZXJucyIsImRlZmF1bHRDdXN0b21HcmFtbWFyTGV4aWNhbFBhdHRlcm4iLCJkZWZhdWx0Q3VzdG9tR3JhbW1hciIsImdldExleGljYWxQYXR0ZXJuIiwiZGVmYXVsdExleGljYWxQYXR0ZXJuIiwicmV2ZXJzZSIsInB1c2giLCJsZXhpY2FsUGF0dGVybnNTdHJpbmciLCJqb2luIiwic3RhcnRSdWxlc0JORiIsInN0YXJ0UnVsZXMiLCJmaXJzdFN0YXJ0UnVsZSIsInJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUiLCJtYWluUnVsZSIsInJlbWFpbmluZ1J1bGVzIiwicnVsZSIsIm1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMiLCJydWxlTmFtZSIsImJuZnMiLCJkZWZhdWx0Q3VzdG9tR3JhbW1hckJORiIsImdldEJORiIsImRlZmF1bHRCTkYiLCJkZWZhdWx0UnVsZXMiLCJkZWZhdWx0TWFpblJ1bGUiLCJkZWZhdWx0TWFpblJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsImJuZiIsIm1haW5SdWxlRGVmaW5pdGlvbnMiLCJyZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwiZGVmYXVsdFJlbWFpbmluZ1J1bGVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUNBOztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0lBRVFBLEssR0FBMkJDLHlCLENBQTNCRCxLO0lBQU9FLE0sR0FBb0JELHlCLENBQXBCQyxNO0lBQVFDLE8sR0FBWUYseUIsQ0FBWkUsTzs7SUFFRkMscUI7QUFDbkIsaUNBQVlDLGNBQVosRUFBNEJDLE9BQTVCLEVBQXFDO0FBQUE7O0FBQ25DLFNBQUtELGNBQUwsR0FBc0JBLGNBQXRCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0Q7Ozs7d0NBRW1CO0FBQ2xCLGFBQU8sS0FBS0QsY0FBWjtBQUNEOzs7aUNBRVk7QUFDWCxhQUFPLEtBQUtDLE9BQVo7QUFDRDs7O3VDQUV5QkMsYyxFQUFnQjtBQUN4QyxVQUFNQyxrQkFBa0IsR0FBR0MsaURBQWlELENBQUNGLGNBQUQsQ0FBNUU7QUFBQSxVQUNNRyxjQUFjLEdBQUdDLDZDQUE2QyxDQUFDSixj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QyxRQUFRLEdBQUdHLHFDQUFxQyxDQUFDQyxRQUFELEVBQVdDLElBQVgsQ0FEdEQ7QUFBQSxNQUVNSixjQUFjLEdBQUdlLDJDQUEyQyxDQUFDWixRQUFELEVBQVdDLElBQVgsQ0FGbEU7QUFBQSxNQUdNbEMsS0FBSyxHQUFHLEdBQUdDLE1BQUgsQ0FBVTRCLFFBQVYsRUFBb0I1QixNQUFwQixDQUEyQjZCLGNBQTNCLENBSGQ7QUFLQSxTQUFPOUIsS0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IGFycmF5VXRpbGl0aWVzIH0gZnJvbSBcIm5lY2Vzc2FyeVwiO1xuaW1wb3J0IHsgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9IGZyb20gXCJvY2NhbS1ncmFtbWFyLXV0aWxpdGllc1wiO1xuXG5pbXBvcnQgZGVmYXVsdEN1c3RvbUdyYW1tYXIgZnJvbSBcIi4vZGVmYXVsdEN1c3RvbUdyYW1tYXJcIjtcblxuaW1wb3J0IHsgZmluZFJ1bGVCeVJ1bGVOYW1lIH0gZnJvbSBcIi4vdXRpbGl0aWVzL3J1bGVOYW1lXCI7XG5pbXBvcnQgeyBydWxlc0Zyb21CTkYsIHJ1bGVNYXBGcm9tUnVsZXMgfSBmcm9tIFwiLi91dGlsaXRpZXMvcnVsZXNcIjtcbmltcG9ydCB7IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycywgYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIH0gZnJvbSBcIi4vdXRpbGl0aWVzL2N1c3RvbUdyYW1tYXJzXCI7XG5pbXBvcnQgeyBTVEFSVF9SVUxFX05BTUUsIFRFUk1fUlVMRV9OQU1FLCBFWFBSRVNTSU9OX1JVTEVfTkFNRSwgU1RBVEVNRU5UX1JVTEVfTkFNRSwgTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUgfSBmcm9tIFwiLi9jb25zdGFudHNcIjtcblxuY29uc3QgeyBmaXJzdCwgZmlsdGVyLCB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tYmluZWRDdXN0b21HcmFtbWFyIHtcbiAgY29uc3RydWN0b3IobGV4aWNhbFBhdHRlcm4sIHJ1bGVNYXApIHtcbiAgICB0aGlzLmxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm47XG4gICAgdGhpcy5ydWxlTWFwID0gcnVsZU1hcDtcbiAgfVxuICBcbiAgZ2V0TGV4aWNhbFBhdHRlcm4oKSB7XG4gICAgcmV0dXJuIHRoaXMubGV4aWNhbFBhdHRlcm47XG4gIH1cblxuICBnZXRSdWxlTWFwKCkge1xuICAgIHJldHVybiB0aGlzLnJ1bGVNYXA7XG4gIH1cblxuICBzdGF0aWMgZnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSB7XG4gICAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVzID0gbWV0YXN0YXRlbWVudFJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORihjdXN0b21HcmFtbWFycyksXG4gICAgICAgICAgc3RhdGVtZW50UnVsZXMgPSBzdGF0ZW1lbnRSdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IGV4cHJlc3Npb25SdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHRlcm1SdWxlcyA9IHRlcm1SdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHJ1bGVzID0gW10uY29uY2F0KG1ldGFzdGF0ZW1lbnRSdWxlcykuY29uY2F0KHN0YXRlbWVudFJ1bGVzKS5jb25jYXQoZXhwcmVzc2lvblJ1bGVzKS5jb25jYXQodGVybVJ1bGVzKSxcbiAgICAgICAgICBzdGFydFJ1bGUgPSBzdGFydFJ1bGVGcm9tTm90aGluZygpLFxuICAgICAgICAgIGxleGljYWxQYXR0ZXJuID0gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICAgIHJ1bGVNYXAgPSBydWxlTWFwRnJvbVJ1bGVzKHJ1bGVzKTtcblxuICAgIHJ1bGVNYXBbU1RBUlRfUlVMRV9OQU1FXSA9IHN0YXJ0UnVsZTtcblxuICAgIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24oc3RhcnRSdWxlLCBydWxlTWFwKTtcblxuICAgIGRlbGV0ZSBydWxlTWFwW1NUQVJUX1JVTEVfTkFNRV07XG5cbiAgICBjb25zdCBjb21iaW5lZEN1c3RvbUdyYW1tYXIgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFyKGxleGljYWxQYXR0ZXJuLCBydWxlTWFwKTtcbiAgICBcbiAgICByZXR1cm4gY29tYmluZWRDdXN0b21HcmFtbWFyO1xuICB9XG59XG5cbmZ1bmN0aW9uIG1ldGFzdGF0ZW1lbnRSdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVOYW1lID0gTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUsICAvLy9cbiAgICAgICAgbWV0YXN0YXRlbWVudFJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYobWV0YXN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyk7XG5cbiAgcmV0dXJuIG1ldGFzdGF0ZW1lbnRSdWxlcztcbn1cblxuZnVuY3Rpb24gc3RhdGVtZW50UnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IHN0YXRlbWVudFJ1bGVOYW1lID0gU1RBVEVNRU5UX1JVTEVfTkFNRSwgIC8vL1xuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyk7XG5cbiAgcmV0dXJuIHN0YXRlbWVudFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBleHByZXNzaW9uUnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGV4cHJlc3Npb25SdWxlTmFtZSA9IEVYUFJFU1NJT05fUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpO1xuXG4gIHJldHVybiBleHByZXNzaW9uUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHRlcm1SdWxlc0Zyb21DdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgdGVybVJ1bGVOYW1lID0gVEVSTV9SVUxFX05BTUUsICAvLy9cbiAgICAgICAgdGVybVJ1bGVzID0gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYodGVybVJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyk7XG5cbiAgcmV0dXJuIHRlcm1SdWxlcztcbn1cblxuZnVuY3Rpb24gbGV4aWNhbFBhdHRlcm5Gcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zID0gbGV4aWNhbFBhdHRlcm5zRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgZGVmYXVsdEN1c3RvbUdyYW1tYXJMZXhpY2FsUGF0dGVybiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyLmdldExleGljYWxQYXR0ZXJuKCksXG4gICAgICAgIGRlZmF1bHRMZXhpY2FsUGF0dGVybiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyTGV4aWNhbFBhdHRlcm47IC8vL1xuXG4gIGxleGljYWxQYXR0ZXJucy5yZXZlcnNlKCk7XG5cbiAgbGV4aWNhbFBhdHRlcm5zLnB1c2goZGVmYXVsdExleGljYWxQYXR0ZXJuKTtcblxuICBmaWx0ZXIobGV4aWNhbFBhdHRlcm5zLCAobGV4aWNhbFBhdHRlcm4pID0+IHtcbiAgICBpZiAobGV4aWNhbFBhdHRlcm4gIT09IFwiXCIpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgbGV4aWNhbFBhdHRlcm5zU3RyaW5nID0gbGV4aWNhbFBhdHRlcm5zLmpvaW4oXCJ8XCIpLCAvLy9cbiAgICAgICAgbGV4aWNhbFBhdHRlcm4gPSBgXig/OiR7bGV4aWNhbFBhdHRlcm5zU3RyaW5nfSlgO1xuXG4gIHJldHVybiBsZXhpY2FsUGF0dGVybjtcbn1cblxuZnVuY3Rpb24gc3RhcnRSdWxlRnJvbU5vdGhpbmcoKSB7XG4gIGNvbnN0IHN0YXJ0UnVsZXNCTkYgPSBgICR7U1RBUlRfUlVMRV9OQU1FfSA6Oj0gJHtNRVRBU1RBVEVNRU5UX1JVTEVfTkFNRX0gfCAke1NUQVRFTUVOVF9SVUxFX05BTUV9IHwgJHtFWFBSRVNTSU9OX1JVTEVfTkFNRX0gfCAke1RFUk1fUlVMRV9OQU1FfSA7IGAsXG4gICAgICAgIHN0YXJ0UnVsZXMgPSBydWxlc0Zyb21CTkYoc3RhcnRSdWxlc0JORiksXG4gICAgICAgIGZpcnN0U3RhcnRSdWxlID0gZmlyc3Qoc3RhcnRSdWxlcyksXG4gICAgICAgIHN0YXJ0UnVsZSA9IGZpcnN0U3RhcnRSdWxlOyAvLy9cblxuICByZXR1cm4gc3RhcnRSdWxlO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSkge1xuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IHJ1bGVzLmZpbHRlcigocnVsZSkgPT4ge1xuICAgIGlmIChydWxlICE9PSBtYWluUnVsZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIG1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgPSBkZWZhdWx0Q3VzdG9tR3JhbW1hci5nZXRCTkYocnVsZU5hbWUpLFxuICAgICAgICBkZWZhdWx0Qk5GID0gZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMgPSBkZWZhdWx0TWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBibmZzLmZvckVhY2goKGJuZikgPT4ge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICBtYWluUnVsZURlZmluaXRpb25zID0gKG1haW5SdWxlICE9PSBudWxsKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMsIG1haW5SdWxlRGVmaW5pdGlvbnMpO1xuICB9KTtcblxuICBjb25zdCBtYWluUnVsZSA9IGRlZmF1bHRNYWluUnVsZTsgLy8vXG5cbiAgcmV0dXJuIG1haW5SdWxlO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRDdXN0b21HcmFtbWFyQk5GID0gZGVmYXVsdEN1c3RvbUdyYW1tYXIuZ2V0Qk5GKHJ1bGVOYW1lKSxcbiAgICAgICAgZGVmYXVsdEJORiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRSZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpO1xuXG4gIGJuZnMuZm9yRWFjaCgoYm5mKSA9PiB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0UmVtYWluaW5nUnVsZXMsIHJlbWFpbmluZ1J1bGVzKTtcbiAgfSk7XG5cbiAgY29uc3QgcmVtYWluaW5nUnVsZXMgPSBkZWZhdWx0UmVtYWluaW5nUnVsZXM7IC8vL1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGJuZnMgPSBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgbWFpblJ1bGUgPSBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBibmZzKSxcbiAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBibmZzKSxcbiAgICAgICAgcnVsZXMgPSBbXS5jb25jYXQobWFpblJ1bGUpLmNvbmNhdChyZW1haW5pbmdSdWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuIl19