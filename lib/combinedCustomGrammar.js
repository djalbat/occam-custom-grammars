"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _necessary = require("necessary");

var _occamGrammarUtilities = require("occam-grammar-utilities");

var _defaultCustomGrammar = _interopRequireDefault(require("./defaultCustomGrammar"));

var _rules = require("./utilities/rules");

var _ruleName = require("./utilities/ruleName");

var _customGrammars = require("./utilities/customGrammars");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    filter = _necessary.arrayUtilities.filter,
    unshift = _necessary.arrayUtilities.unshift;

var CombinedCustomGrammar = /*#__PURE__*/function () {
  function CombinedCustomGrammar(lexicalPattern, rules) {
    _classCallCheck(this, CombinedCustomGrammar);

    this.lexicalPattern = lexicalPattern;
    this.rules = rules;
  }

  _createClass(CombinedCustomGrammar, [{
    key: "getLexicalPattern",
    value: function getLexicalPattern() {
      return this.lexicalPattern;
    }
  }, {
    key: "getRules",
    value: function getRules() {
      return this.rules;
    }
  }], [{
    key: "fromCustomGrammars",
    value: function fromCustomGrammars(customGrammars) {
      var lexicalPattern = lexicalPatternFromCustomGrammars(customGrammars),
          rules = rulesFromCustomGrammars(customGrammars);
      addStartRule(rules);
      (0, _occamGrammarUtilities.eliminateLeftRecursion)(rules);
      removeStartRule(rules);
      var combinedCustomGrammar = new CombinedCustomGrammar(lexicalPattern, rules);
      return combinedCustomGrammar;
    }
  }]);

  return CombinedCustomGrammar;
}();

exports["default"] = CombinedCustomGrammar;

function lexicalPatternFromCustomGrammars(customGrammars) {
  var lexicalPatterns = (0, _customGrammars.lexicalPatternsFromCustomGrammars)(customGrammars),
      defaultCustomGrammarLexicalPattern = _defaultCustomGrammar["default"].getLexicalPattern(),
      defaultLexicalPattern = defaultCustomGrammarLexicalPattern; ///


  lexicalPatterns.unshift(defaultLexicalPattern);
  var lexicalPatternsString = lexicalPatterns.reverse().join("|"),
      ///
  lexicalPattern = "^(?:".concat(lexicalPatternsString, ")");
  return lexicalPattern;
}

function rulesFromCustomGrammars(customGrammars) {
  var metastatementRuleName = _constants.METASTATEMENT_RULE_NAME,
      ///
  statementRuleName = _constants.STATEMENT_RULE_NAME,
      ///
  expressionRuleName = _constants.EXPRESSION_RULE_NAME,
      ///
  termRuleName = _constants.TERM_RULE_NAME,
      ///
  metastatementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(metastatementRuleName, customGrammars),
      statementRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(statementRuleName, customGrammars),
      expressionRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(expressionRuleName, customGrammars),
      termRules = rulesFromRuleNameCustomGrammarsAndDefaultBNF(termRuleName, customGrammars),
      rules = [].concat(metastatementRules).concat(statementRules).concat(expressionRules).concat(termRules);
  return rules;
}

function addStartRule(rules) {
  var startRulesBNF = " ".concat(_constants.START_RULE_NAME, " ::= ").concat(_constants.METASTATEMENT_RULE_NAME, " | ").concat(_constants.STATEMENT_RULE_NAME, " | ").concat(_constants.EXPRESSION_RULE_NAME, " | ").concat(_constants.TERM_RULE_NAME, " ; "),
      startRules = (0, _rules.rulesFromBNF)(startRulesBNF),
      firstStartRule = first(startRules),
      startRule = firstStartRule; ///

  rules.unshift(startRule);
}

function removeStartRule(rules) {
  var firstRule = first(rules),
      startRule = firstRule; ///

  filter(rules, function (rule) {
    if (rule !== startRule) {
      return true;
    }
  });
}

function remainingRulesFromRulesAndMainRule(rules, mainRule) {
  var remainingRules = rules.filter(function (rule) {
    if (rule !== mainRule) {
      return true;
    }
  });
  return remainingRules;
}

function mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultMainRuleDefinitions = defaultMainRule.getDefinitions();

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        mainRuleDefinitions = mainRule !== null ? mainRule.getDefinitions() : [];
    unshift(defaultMainRuleDefinitions, mainRuleDefinitions);
  });
  var mainRule = defaultMainRule; ///

  return mainRule;
}

function remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs) {
  var defaultCustomGrammarBNF = _defaultCustomGrammar["default"].getBNF(ruleName),
      defaultBNF = defaultCustomGrammarBNF,
      ///
  defaultRules = (0, _rules.rulesFromBNF)(defaultBNF),
      defaultMainRule = (0, _ruleName.findRuleByRuleName)(ruleName, defaultRules),
      defaultRemainingRules = remainingRulesFromRulesAndMainRule(defaultRules, defaultMainRule);

  bnfs.forEach(function (bnf) {
    var rules = (0, _rules.rulesFromBNF)(bnf),
        mainRule = (0, _ruleName.findRuleByRuleName)(ruleName, rules),
        remainingRules = remainingRulesFromRulesAndMainRule(rules, mainRule);
    unshift(defaultRemainingRules, remainingRules);
  });
  var remainingRules = defaultRemainingRules; ///

  return remainingRules;
}

function rulesFromRuleNameCustomGrammarsAndDefaultBNF(ruleName, customGrammars) {
  var bnfs = (0, _customGrammars.bnfsFromRuleNameAndCustomGrammars)(ruleName, customGrammars),
      mainRule = mainRuleFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      remainingRules = remainingRulesFromRuleNameDefaultBNFAndBNFs(ruleName, bnfs),
      rules = [].concat(mainRule).concat(remainingRules);
  return rules;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbWJpbmVkQ3VzdG9tR3JhbW1hci5qcyJdLCJuYW1lcyI6WyJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwiZmlsdGVyIiwidW5zaGlmdCIsIkNvbWJpbmVkQ3VzdG9tR3JhbW1hciIsImxleGljYWxQYXR0ZXJuIiwicnVsZXMiLCJjdXN0b21HcmFtbWFycyIsImxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzIiwicnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMiLCJhZGRTdGFydFJ1bGUiLCJyZW1vdmVTdGFydFJ1bGUiLCJjb21iaW5lZEN1c3RvbUdyYW1tYXIiLCJsZXhpY2FsUGF0dGVybnMiLCJkZWZhdWx0Q3VzdG9tR3JhbW1hckxleGljYWxQYXR0ZXJuIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXIiLCJnZXRMZXhpY2FsUGF0dGVybiIsImRlZmF1bHRMZXhpY2FsUGF0dGVybiIsImxleGljYWxQYXR0ZXJuc1N0cmluZyIsInJldmVyc2UiLCJqb2luIiwibWV0YXN0YXRlbWVudFJ1bGVOYW1lIiwiTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUiLCJzdGF0ZW1lbnRSdWxlTmFtZSIsIlNUQVRFTUVOVF9SVUxFX05BTUUiLCJleHByZXNzaW9uUnVsZU5hbWUiLCJFWFBSRVNTSU9OX1JVTEVfTkFNRSIsInRlcm1SdWxlTmFtZSIsIlRFUk1fUlVMRV9OQU1FIiwibWV0YXN0YXRlbWVudFJ1bGVzIiwicnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYiLCJzdGF0ZW1lbnRSdWxlcyIsImV4cHJlc3Npb25SdWxlcyIsInRlcm1SdWxlcyIsImNvbmNhdCIsInN0YXJ0UnVsZXNCTkYiLCJTVEFSVF9SVUxFX05BTUUiLCJzdGFydFJ1bGVzIiwiZmlyc3RTdGFydFJ1bGUiLCJzdGFydFJ1bGUiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZSIsIm1haW5SdWxlIiwicmVtYWluaW5nUnVsZXMiLCJtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzIiwicnVsZU5hbWUiLCJibmZzIiwiZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYiLCJnZXRCTkYiLCJkZWZhdWx0Qk5GIiwiZGVmYXVsdFJ1bGVzIiwiZGVmYXVsdE1haW5SdWxlIiwiZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJibmYiLCJtYWluUnVsZURlZmluaXRpb25zIiwicmVtYWluaW5nUnVsZXNGcm9tUnVsZU5hbWVEZWZhdWx0Qk5GQW5kQk5GcyIsImRlZmF1bHRSZW1haW5pbmdSdWxlcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7OztJQUVRQSxLLEdBQTJCQyx5QixDQUEzQkQsSztJQUFPRSxNLEdBQW9CRCx5QixDQUFwQkMsTTtJQUFRQyxPLEdBQVlGLHlCLENBQVpFLE87O0lBRUZDLHFCO0FBQ25CLGlDQUFZQyxjQUFaLEVBQTRCQyxLQUE1QixFQUFtQztBQUFBOztBQUNqQyxTQUFLRCxjQUFMLEdBQXNCQSxjQUF0QjtBQUNBLFNBQUtDLEtBQUwsR0FBYUEsS0FBYjtBQUNEOzs7O3dDQUVtQjtBQUNsQixhQUFPLEtBQUtELGNBQVo7QUFDRDs7OytCQUVVO0FBQ1QsYUFBTyxLQUFLQyxLQUFaO0FBQ0Q7Ozt1Q0FFeUJDLGMsRUFBZ0I7QUFDeEMsVUFBTUYsY0FBYyxHQUFHRyxnQ0FBZ0MsQ0FBQ0QsY0FBRCxDQUF2RDtBQUFBLFVBQ01ELEtBQUssR0FBR0csdUJBQXVCLENBQUNGLGNBQUQsQ0FEckM7QUFHQUcsTUFBQUEsWUFBWSxDQUFDSixLQUFELENBQVo7QUFFQSx5REFBdUJBLEtBQXZCO0FBRUFLLE1BQUFBLGVBQWUsQ0FBQ0wsS0FBRCxDQUFmO0FBRUEsVUFBTU0scUJBQXFCLEdBQUcsSUFBSVIscUJBQUosQ0FBMEJDLGNBQTFCLEVBQTBDQyxLQUExQyxDQUE5QjtB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QUwsRUFBQUEsSUFBSSxDQUFDUSxPQUFMLENBQWEsVUFBQ0MsR0FBRCxFQUFTO0FBQ3BCLFFBQU1sRCxLQUFLLEdBQUcseUJBQWFrRCxHQUFiLENBQWQ7QUFBQSxRQUNNYixRQUFRLEdBQUcsa0NBQW1CRyxRQUFuQixFQUE2QnhDLEtBQTdCLENBRGpCO0FBQUEsUUFFTXNDLGNBQWMsR0FBR0Ysa0NBQWtDLENBQUNwQyxLQUFELEVBQVFxQyxRQUFSLENBRnpEO0FBSUF4QyxJQUFBQSxPQUFPLENBQUN3RCxxQkFBRCxFQUF3QmYsY0FBeEIsQ0FBUDtBQUNELEdBTkQ7QUFRQSxNQUFNQSxjQUFjLEdBQUdlLHFCQUF2QixDQWZtRSxDQWVyQjs7QUFFOUMsU0FBT2YsY0FBUDtBQUNEOztBQUVELFNBQVNkLDRDQUFULENBQXNEZ0IsUUFBdEQsRUFBZ0V2QyxjQUFoRSxFQUFnRjtBQUM5RSxNQUFNd0MsSUFBSSxHQUFHLHVEQUFrQ0QsUUFBbEMsRUFBNEN2QyxjQUE1QyxDQUFiO0FBQUEsTUFDTW9DLFFBQVEsR0FBR0UscUNBQXFDLENBQUNDLFFBQUQsRUFBV0MsSUFBWCxDQUR0RDtBQUFBLE1BRU1ILGNBQWMsR0FBR2MsMkNBQTJDLENBQUNaLFFBQUQsRUFBV0MsSUFBWCxDQUZsRTtBQUFBLE1BR016QyxLQUFLLEdBQUcsR0FBRzRCLE1BQUgsQ0FBVVMsUUFBVixFQUFvQlQsTUFBcEIsQ0FBMkJVLGNBQTNCLENBSGQ7QUFLQSxTQUFPdEMsS0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IGFycmF5VXRpbGl0aWVzIH0gZnJvbSBcIm5lY2Vzc2FyeVwiO1xuaW1wb3J0IHsgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiB9IGZyb20gXCJvY2NhbS1ncmFtbWFyLXV0aWxpdGllc1wiO1xuXG5pbXBvcnQgZGVmYXVsdEN1c3RvbUdyYW1tYXIgZnJvbSBcIi4vZGVmYXVsdEN1c3RvbUdyYW1tYXJcIjtcblxuaW1wb3J0IHsgcnVsZXNGcm9tQk5GIH0gZnJvbSBcIi4vdXRpbGl0aWVzL3J1bGVzXCI7XG5pbXBvcnQgeyBmaW5kUnVsZUJ5UnVsZU5hbWUgfSBmcm9tIFwiLi91dGlsaXRpZXMvcnVsZU5hbWVcIjtcbmltcG9ydCB7IGxleGljYWxQYXR0ZXJuc0Zyb21DdXN0b21HcmFtbWFycywgYm5mc0Zyb21SdWxlTmFtZUFuZEN1c3RvbUdyYW1tYXJzIH0gZnJvbSBcIi4vdXRpbGl0aWVzL2N1c3RvbUdyYW1tYXJzXCI7XG5pbXBvcnQgeyBTVEFSVF9SVUxFX05BTUUsIFRFUk1fUlVMRV9OQU1FLCBFWFBSRVNTSU9OX1JVTEVfTkFNRSwgU1RBVEVNRU5UX1JVTEVfTkFNRSwgTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUgfSBmcm9tIFwiLi9jb25zdGFudHNcIjtcblxuY29uc3QgeyBmaXJzdCwgZmlsdGVyLCB1bnNoaWZ0IH0gPSBhcnJheVV0aWxpdGllcztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tYmluZWRDdXN0b21HcmFtbWFyIHtcbiAgY29uc3RydWN0b3IobGV4aWNhbFBhdHRlcm4sIHJ1bGVzKSB7XG4gICAgdGhpcy5sZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuO1xuICAgIHRoaXMucnVsZXMgPSBydWxlcztcbiAgfVxuICBcbiAgZ2V0TGV4aWNhbFBhdHRlcm4oKSB7XG4gICAgcmV0dXJuIHRoaXMubGV4aWNhbFBhdHRlcm47XG4gIH1cblxuICBnZXRSdWxlcygpIHtcbiAgICByZXR1cm4gdGhpcy5ydWxlcztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgICBjb25zdCBsZXhpY2FsUGF0dGVybiA9IGxleGljYWxQYXR0ZXJuRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgICBydWxlcyA9IHJ1bGVzRnJvbUN1c3RvbUdyYW1tYXJzKGN1c3RvbUdyYW1tYXJzKTtcblxuICAgIGFkZFN0YXJ0UnVsZShydWxlcyk7XG5cbiAgICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKTtcblxuICAgIHJlbW92ZVN0YXJ0UnVsZShydWxlcyk7XG5cbiAgICBjb25zdCBjb21iaW5lZEN1c3RvbUdyYW1tYXIgPSBuZXcgQ29tYmluZWRDdXN0b21HcmFtbWFyKGxleGljYWxQYXR0ZXJuLCBydWxlcyk7XG4gICAgXG4gICAgcmV0dXJuIGNvbWJpbmVkQ3VzdG9tR3JhbW1hcjtcbiAgfVxufVxuXG5mdW5jdGlvbiBsZXhpY2FsUGF0dGVybkZyb21DdXN0b21HcmFtbWFycyhjdXN0b21HcmFtbWFycykge1xuICBjb25zdCBsZXhpY2FsUGF0dGVybnMgPSBsZXhpY2FsUGF0dGVybnNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBkZWZhdWx0Q3VzdG9tR3JhbW1hckxleGljYWxQYXR0ZXJuID0gZGVmYXVsdEN1c3RvbUdyYW1tYXIuZ2V0TGV4aWNhbFBhdHRlcm4oKSxcbiAgICAgICAgZGVmYXVsdExleGljYWxQYXR0ZXJuID0gZGVmYXVsdEN1c3RvbUdyYW1tYXJMZXhpY2FsUGF0dGVybjsgLy8vXG5cbiAgbGV4aWNhbFBhdHRlcm5zLnVuc2hpZnQoZGVmYXVsdExleGljYWxQYXR0ZXJuKTtcblxuICBjb25zdCBsZXhpY2FsUGF0dGVybnNTdHJpbmcgPSBsZXhpY2FsUGF0dGVybnMucmV2ZXJzZSgpLmpvaW4oXCJ8XCIpLCAvLy9cbiAgICAgICAgbGV4aWNhbFBhdHRlcm4gPSBgXig/OiR7bGV4aWNhbFBhdHRlcm5zU3RyaW5nfSlgO1xuXG4gIHJldHVybiBsZXhpY2FsUGF0dGVybjtcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tQ3VzdG9tR3JhbW1hcnMoY3VzdG9tR3JhbW1hcnMpIHtcbiAgY29uc3QgbWV0YXN0YXRlbWVudFJ1bGVOYW1lID0gTUVUQVNUQVRFTUVOVF9SVUxFX05BTUUsICAvLy9cbiAgICAgICAgc3RhdGVtZW50UnVsZU5hbWUgPSBTVEFURU1FTlRfUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIGV4cHJlc3Npb25SdWxlTmFtZSA9IEVYUFJFU1NJT05fUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIHRlcm1SdWxlTmFtZSA9IFRFUk1fUlVMRV9OQU1FLCAgLy8vXG4gICAgICAgIG1ldGFzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKG1ldGFzdGF0ZW1lbnRSdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICBzdGF0ZW1lbnRSdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKHN0YXRlbWVudFJ1bGVOYW1lLCBjdXN0b21HcmFtbWFycyksXG4gICAgICAgIGV4cHJlc3Npb25SdWxlcyA9IHJ1bGVzRnJvbVJ1bGVOYW1lQ3VzdG9tR3JhbW1hcnNBbmREZWZhdWx0Qk5GKGV4cHJlc3Npb25SdWxlTmFtZSwgY3VzdG9tR3JhbW1hcnMpLFxuICAgICAgICB0ZXJtUnVsZXMgPSBydWxlc0Zyb21SdWxlTmFtZUN1c3RvbUdyYW1tYXJzQW5kRGVmYXVsdEJORih0ZXJtUnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgcnVsZXMgPSBbXS5jb25jYXQobWV0YXN0YXRlbWVudFJ1bGVzKS5jb25jYXQoc3RhdGVtZW50UnVsZXMpLmNvbmNhdChleHByZXNzaW9uUnVsZXMpLmNvbmNhdCh0ZXJtUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cblxuZnVuY3Rpb24gYWRkU3RhcnRSdWxlKHJ1bGVzKSB7XG4gIGNvbnN0IHN0YXJ0UnVsZXNCTkYgPSBgICR7U1RBUlRfUlVMRV9OQU1FfSA6Oj0gJHtNRVRBU1RBVEVNRU5UX1JVTEVfTkFNRX0gfCAke1NUQVRFTUVOVF9SVUxFX05BTUV9IHwgJHtFWFBSRVNTSU9OX1JVTEVfTkFNRX0gfCAke1RFUk1fUlVMRV9OQU1FfSA7IGAsXG4gICAgICAgIHN0YXJ0UnVsZXMgPSBydWxlc0Zyb21CTkYoc3RhcnRSdWxlc0JORiksXG4gICAgICAgIGZpcnN0U3RhcnRSdWxlID0gZmlyc3Qoc3RhcnRSdWxlcyksXG4gICAgICAgIHN0YXJ0UnVsZSA9IGZpcnN0U3RhcnRSdWxlOyAvLy9cblxuICBydWxlcy51bnNoaWZ0KHN0YXJ0UnVsZSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZVN0YXJ0UnVsZShydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHN0YXJ0UnVsZSA9IGZpcnN0UnVsZTsgIC8vL1xuXG4gIGZpbHRlcihydWxlcywgKHJ1bGUpID0+IHtcbiAgICBpZiAocnVsZSAhPT0gc3RhcnRSdWxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlc0FuZE1haW5SdWxlKHJ1bGVzLCBtYWluUnVsZSkge1xuICBjb25zdCByZW1haW5pbmdSdWxlcyA9IHJ1bGVzLmZpbHRlcigocnVsZSkgPT4ge1xuICAgIGlmIChydWxlICE9PSBtYWluUnVsZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gcmVtYWluaW5nUnVsZXM7XG59XG5cbmZ1bmN0aW9uIG1haW5SdWxlRnJvbVJ1bGVOYW1lRGVmYXVsdEJORkFuZEJORnMocnVsZU5hbWUsIGJuZnMpIHtcbiAgY29uc3QgZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYgPSBkZWZhdWx0Q3VzdG9tR3JhbW1hci5nZXRCTkYocnVsZU5hbWUpLFxuICAgICAgICBkZWZhdWx0Qk5GID0gZGVmYXVsdEN1c3RvbUdyYW1tYXJCTkYsIC8vL1xuICAgICAgICBkZWZhdWx0UnVsZXMgPSBydWxlc0Zyb21CTkYoZGVmYXVsdEJORiksXG4gICAgICAgIGRlZmF1bHRNYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgZGVmYXVsdFJ1bGVzKSxcbiAgICAgICAgZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMgPSBkZWZhdWx0TWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBibmZzLmZvckVhY2goKGJuZikgPT4ge1xuICAgIGNvbnN0IHJ1bGVzID0gcnVsZXNGcm9tQk5GKGJuZiksXG4gICAgICAgICAgbWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICBtYWluUnVsZURlZmluaXRpb25zID0gKG1haW5SdWxlICE9PSBudWxsKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpblJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXTtcblxuICAgIHVuc2hpZnQoZGVmYXVsdE1haW5SdWxlRGVmaW5pdGlvbnMsIG1haW5SdWxlRGVmaW5pdGlvbnMpO1xuICB9KTtcblxuICBjb25zdCBtYWluUnVsZSA9IGRlZmF1bHRNYWluUnVsZTsgLy8vXG5cbiAgcmV0dXJuIG1haW5SdWxlO1xufVxuXG5mdW5jdGlvbiByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBibmZzKSB7XG4gIGNvbnN0IGRlZmF1bHRDdXN0b21HcmFtbWFyQk5GID0gZGVmYXVsdEN1c3RvbUdyYW1tYXIuZ2V0Qk5GKHJ1bGVOYW1lKSxcbiAgICAgICAgZGVmYXVsdEJORiA9IGRlZmF1bHRDdXN0b21HcmFtbWFyQk5GLCAvLy9cbiAgICAgICAgZGVmYXVsdFJ1bGVzID0gcnVsZXNGcm9tQk5GKGRlZmF1bHRCTkYpLFxuICAgICAgICBkZWZhdWx0TWFpblJ1bGUgPSBmaW5kUnVsZUJ5UnVsZU5hbWUocnVsZU5hbWUsIGRlZmF1bHRSdWxlcyksXG4gICAgICAgIGRlZmF1bHRSZW1haW5pbmdSdWxlcyA9IHJlbWFpbmluZ1J1bGVzRnJvbVJ1bGVzQW5kTWFpblJ1bGUoZGVmYXVsdFJ1bGVzLCBkZWZhdWx0TWFpblJ1bGUpO1xuXG4gIGJuZnMuZm9yRWFjaCgoYm5mKSA9PiB7XG4gICAgY29uc3QgcnVsZXMgPSBydWxlc0Zyb21CTkYoYm5mKSxcbiAgICAgICAgICBtYWluUnVsZSA9IGZpbmRSdWxlQnlSdWxlTmFtZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlbWFpbmluZ1J1bGVzID0gcmVtYWluaW5nUnVsZXNGcm9tUnVsZXNBbmRNYWluUnVsZShydWxlcywgbWFpblJ1bGUpO1xuXG4gICAgdW5zaGlmdChkZWZhdWx0UmVtYWluaW5nUnVsZXMsIHJlbWFpbmluZ1J1bGVzKTtcbiAgfSk7XG5cbiAgY29uc3QgcmVtYWluaW5nUnVsZXMgPSBkZWZhdWx0UmVtYWluaW5nUnVsZXM7IC8vL1xuXG4gIHJldHVybiByZW1haW5pbmdSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tUnVsZU5hbWVDdXN0b21HcmFtbWFyc0FuZERlZmF1bHRCTkYocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSB7XG4gIGNvbnN0IGJuZnMgPSBibmZzRnJvbVJ1bGVOYW1lQW5kQ3VzdG9tR3JhbW1hcnMocnVsZU5hbWUsIGN1c3RvbUdyYW1tYXJzKSxcbiAgICAgICAgbWFpblJ1bGUgPSBtYWluUnVsZUZyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBibmZzKSxcbiAgICAgICAgcmVtYWluaW5nUnVsZXMgPSByZW1haW5pbmdSdWxlc0Zyb21SdWxlTmFtZURlZmF1bHRCTkZBbmRCTkZzKHJ1bGVOYW1lLCBibmZzKSxcbiAgICAgICAgcnVsZXMgPSBbXS5jb25jYXQobWFpblJ1bGUpLmNvbmNhdChyZW1haW5pbmdSdWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuIl19